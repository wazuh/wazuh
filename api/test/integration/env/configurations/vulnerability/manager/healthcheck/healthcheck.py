import json
import socket
import sys
from base64 import b64encode
from os import system

sys.path.append('/tools')

import requests
import urllib3
from healthcheck_utils import get_manager_health_base, check

agents_to_check = ['001', '002']

# Configuration
protocol = 'https'
host = 'localhost'
port = '55000'
user = 'wazuh'
password = 'wazuh'

# Variables
base_url = f"{protocol}://{host}:{port}"
login_url = f"{base_url}/security/user/authenticate"
basic_auth = f"{user}:{password}".encode()
headers = {'Authorization': f'Basic {b64encode(basic_auth).decode()}'}


# Disable insecure https warnings (for self-signed SSL certificates)
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


# Functions
def get_response(url, headers):
    """Get API result for GET request.

    Parameters
    ----------
    url : str
        URL of the API (+ endpoint and parameters if needed).
    headers : dict
        Headers required by the API.

    Returns
    -------
    Dict
        API response for the request.
    """
    request_result = requests.get(url, headers=headers, verify=False)

    if request_result.status_code == 200:
        return json.loads(request_result.content.decode())


def get_agents_node(status='active'):
    """Get to which manager each agent reports.

    Parameters
    ----------
    status : str
        Status to filter agents by.

    Returns
    -------
    dict, None
        Dictionary like {agent_id: manager_name} if agents were obtained, else None.
    """
    try:
        headers['Authorization'] = f'Bearer {get_response(login_url, headers)["data"]["token"]}'
        response = get_response(base_url + f'/agents?select=id,manager&status={status}',
                                headers)['data']['affected_items']
    except Exception:
        return

    return {item['id']: item['manager'] for item in response}


if __name__ == '__main__':
    # Get dict of agent IDs and the manager they report to.
    agents_node = get_agents_node()

    # If not all requested agents were returned, exit with error code
    if agents_node is None or not all(agent in agents_node for agent in agents_to_check):
        exit(1)

    checks_list = list()
    expected_log = "grep -q 'wazuh-modulesd:vulnerability-detector: INFO: (5471): Finished vulnerability assessment " \
                   "for agent '\\''{}'\\''' /var/ossec/logs/wazuh.log"

    if socket.gethostname() == 'wazuh-master':
        checks_list.append(get_manager_health_base())

    for agent in agents_to_check:
        if agents_node[agent] == socket.gethostname():
            # Append only logs that are expected in the current node.
            checks_list.append(check(system(expected_log.format(agent))))

    exit(any(checks_list))
