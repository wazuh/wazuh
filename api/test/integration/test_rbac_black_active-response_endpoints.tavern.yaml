---
test_name: PUT ACTIVE-RESPONSE OVER A LIST OF AGENTS

marks:
  - usefixtures:
    - active-response_black_rbac_tests

includes:
  - !include common.yaml

stages:

    # Authentication stage
  - type: ref
    id: login_get_token

  - name: Runs an Active Response command on a specified agent (Deny)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/{version:s}/active-response"
      method: PUT
      headers:
        Authorization: "Bearer {test_login_token}"
        content-type: application/json
      json:
        command: "restart-ossec0"
        arguments: ["-", "null", "(from_the_server)", "(no_rule_id)"]
      params:
        list_agents: '001'
    response:
      status_code: 400
      body:
        code: 4000
        detail: "Permission denied: Resource type: agent:id"

  - name: Send a message to an agent (Status=Active) (Allow)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/{version:s}/active-response"
      method: PUT
      headers:
        Authorization: "Bearer {test_login_token}"
        content-type: application/json
      json:
        command: "restart-ossec0"
        arguments: ["-", "null", "(from_the_server)", "(no_rule_id)"]
      params:
        list_agents: '002'
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - '002'
          failed_items: []
          total_affected_items: 1
          total_failed_items: 0
        message: Command sent to all agents

  - name: Send a message to a list of agents
    request:
      url: "{protocol:s}://{host:s}:{port:d}/{version:s}/active-response"
      method: PUT
      headers:
        Authorization: "Bearer {test_login_token}"
        content-type: application/json
      json:
        command: "restart-ossec0"
        arguments: ["-", "null", "(from_the_server)", "(no_rule_id)"]
      params:
        list_agents: 002,004,005,007,010,011
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - '002'
            - '005'
          failed_items:
            - error:
                code: 1651
                message: Active response - Agent is not active
                remediation: !anything
              id:
                - '010'
            - error:
                code: 4000
                message: 'Permission denied: Resource type: agent:id'
                remediation: Please, make sure you have permissions to execute current request,
                  for more information on setting up permissions please visit XXXX
              id:
                - '004'
                - '007'
                - '011'
          total_affected_items: 2
          total_failed_items: 4
        message: Could not send command to some agents

  - name: Try to send a message to an agent (status=disconnected/never_connected) (Allow)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/{version:s}/active-response"
      method: PUT
      headers:
        Authorization: "Bearer {test_login_token}"
        content-type: application/json
      json:
        command: "restart-ossec0"
        arguments: ["-", "null", "(from_the_server)", "(no_rule_id)"]
      params:
        list_agents: '009'
    response:
      status_code: 400
      body:
        code: 4000
        detail: "Permission denied: Resource type: agent:id"

  - name: Try to send a message to an unexisting agent (Allow)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/{version:s}/active-response"
      method: PUT
      headers:
        Authorization: "Bearer {test_login_token}"
        content-type: application/json
      json:
        command: "restart-ossec0"
        arguments: ["-", "null", "(from_the_server)", "(no_rule_id)"]
      params:
        list_agents: 251,252
    response:
      status_code: 200
      body:
        data:
          affected_items: []
          failed_items:
            - error:
                code: 1701
                message: Agent does not exist
                remediation: Please, use `GET /agents?select=id,name` to find all available
                  agents
              id:
                - '251'
                - '252'
          total_affected_items: 0
          total_failed_items: 2
        message: Could not send command to any agent

---
test_name: PUT /active-response

stages:

    # PUT /active-response
  - name: Runs an Active Response command on all agents
    request:
      url: "{protocol:s}://{host:s}:{port:d}/{version:s}/active-response"
      method: PUT
      headers:
        Authorization: "Bearer {test_login_token}"
        content-type: application/json
      json:
        command: "restart-ossec0"
        arguments: ["-", "null", "(from_the_server)", "(no_rule_id)"]
    response:
      status_code: 200
      body:
        data:
          affected_items: !anything
          failed_items:
            - error:
                code: 1651
                message: Active response - Agent is not active
                remediation: !anything
              id:
                - '010'
                - '012'
          total_affected_items: 5
          total_failed_items: 2
        message: Could not send command to some agents
