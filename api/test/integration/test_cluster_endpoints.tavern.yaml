---
test_name: GET /cluster/config

marks:
  - usefixtures:
      - cluster_tests

includes:
  - !include common.yaml

stages:

    # Authentication stage
  - type: ref
    id: login_get_token

  - name: Get cluster config
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/config"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        data:
          name: !anystr
          node_name: !anystr
          node_type: !anystr
          key: !anystr
          port: !anyint
          bind_addr: !anystr
          nodes: !anything
          hidden: !anystr
          disabled: false

---
test_name: GET /cluster/healthcheck

stages:

  - name: Get cluster healtcheck
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/healthcheck"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        data:
          n_connected_nodes: !anyint
          nodes:
            master-node:
              info:
                name: !anystr
                ip: !anystr
                version: !anystr
                type: !anystr
                n_active_agents: !anyint
            worker1:
              info:
                name: !anystr
                ip: !anystr
                version: !anystr
                type: !anystr
                n_active_agents: !anyint
              status: !anything
            worker2:
              info:
                name: !anystr
                ip: !anystr
                version: !anystr
                type: !anystr
                n_active_agents: !anyint
              status: !anything

---
test_name: GET /cluster/node

stages:

  - name: Get cluster node
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/node"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        data:
          cluster: wazuh
          node: master-node
          type: master

---
test_name: GET /cluster/nodes

stages:

  - name: Get cluster nodes
    request: &get_cluster_nodes
      url: "{protocol:s}://{host:s}:{port:d}/cluster/nodes"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
      params:
        limit: 1
    response:
      status_code: 200
      body:
        data:
          totalItems: 3
          items: &cluster_nodes_response
            - ip: !anystr
              version: !anystr
              type: !anystr
              name: !anystr

  - name: Get cluster nodes
    request:
      <<: *get_cluster_nodes
      params:
        limit: 500
    response:
      status_code: 200
      body:
        data:
          totalItems: 3
          items:
            - <<: *cluster_nodes_response
            - <<: *cluster_nodes_response
            - <<: *cluster_nodes_response

  - name: Retrieve all elements with limit=0
    request:
      <<: *get_cluster_nodes
      params:
        limit: 0
    response: &connexion_error
      status_code: 400
      body:
        detail: !anystr
        status: 400
        title: !anystr
        type: !anystr

  - name: Sort nodes by name in ascending order
    request:
      <<: *get_cluster_nodes
      params:
        sort: name
    response:
      status_code: 200
      body:
        data:
          items:
            - <<: *cluster_nodes_response
              type: master
              name: master-node
            - <<: *cluster_nodes_response
              type: worker
              name: worker1
            - <<: *cluster_nodes_response
              type: worker
              name: worker2
      save:
        body:
          master_response: data.items.0
          worker1_response: data.items.1
          worker2_response: data.items.2

  - name: Sort nodes by name in descending order
    request:
      <<: *get_cluster_nodes
      params:
        sort: -name
    response:
      status_code: 200
      body:
        data:
          items:
            - <<: *cluster_nodes_response
              type: worker
              name: worker2
            - <<: *cluster_nodes_response
              type: worker
              name: worker1
            - <<: *cluster_nodes_response
              type: master
              name: master-node

  - name: Search master
    request:
      <<: *get_cluster_nodes
      params:
        search: master
    response:
      status_code: 200
      body:
        data:
          totalItems: 1
          items:
            - <<: *cluster_nodes_response
              type: master
              name: master-node

  - name: Search worker1
    request:
      <<: *get_cluster_nodes
      params:
        search: worker1
    response:
      status_code: 200
      body:
        data:
          totalItems:
          items:
            - <<: *cluster_nodes_response
              name: worker1

  - name: Filters (type) -> master
    request:
      <<: *get_cluster_nodes
      params:
        type: master
    response:
      status_code: 200
      body:
        data:
          totalItems: 1
          items:
            - <<: *cluster_nodes_response
              type: master

  - name: Filters (type) -> worker
    request:
      <<: *get_cluster_nodes
      params:
        limit: 1
        type: worker
    response:
      status_code: 200
      body:
        data:
          totalItems: 2
          items:
            - <<: *cluster_nodes_response
              type: worker


  - name: Filters -> invalid type
    request:
      <<: *get_cluster_nodes
      params:
        type: wrong_type
    response:
      <<: *connexion_error

  - name: Select name and version
    request:
      <<: *get_cluster_nodes
      params:
        select: name,version
    response:
      status_code: 200
      body:
        data:
          totalItems: 3
          items:
            - name: !anystr
              version: !anystr
            - name: !anystr
              version: !anystr
            - name: !anystr
              version: !anystr

  - name: Select type
    request:
      <<: *get_cluster_nodes
      params:
        select: type
    response:
      status_code: 200
      body:
        data:
          totalItems: 3
          items:
            - type: !anystr
            - type: !anystr
            - type: !anystr

  - name: Select wrong_field
    request:
      <<: *get_cluster_nodes
      params:
        select: wrong_field
    response:
      <<: *connexion_error

---
test_name: GET /cluster/nodes/{node_id}

marks:
  - parametrize:
      key: node_id
      vals:
        - master-node
        - worker1
        - worker2

stages:

  - name: Get cluster {node_id}
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/nodes/{node_id}"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        data:
          ip: !anystr
          name: !anystr
          type: !anystr
          version: !anystr

---
test_name: GET /cluster/nodes/{node_id} select

marks:
  - parametrize:
      key: field
      vals:
        - ip
        - name
        - type
        - version

stages:

  - name: Get cluster nodes with select
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/nodes/master-node"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
      params:
        select: "{field}"
    response:
      status_code: 200
      body:
        $ext:
          # Check response item keys are the selected keys
          function: tavern_utils:test_select_key_no_items
          extra_kwargs:
            select_key: "{field:s}"

---
test_name: GET /cluster/status

stages:

  - name: Get cluster status
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/status"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        data:
          enabled: "yes"
          running: "yes"

---
test_name: GET /cluster/{node_id}/configuration

stages:

  - name: Request {node_id}
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/master-node/configuration"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        data:
          agentless: !anything
          alerts: !anything
          auth: !anything
          cis-cat: !anything
          cluster: !anything
          command: !anything
          email_alerts: !anything
          global: !anything
          integration: !anything
          localfile: !anything
          open-scap: !anything
          osquery: !anything
          remote: !anything
          rootcheck: !anything
          ruleset: !anything
          sca: !anything
          syscheck: !anything
          syscollector: !anything
          syslog_output: !anything
          vulnerability-detector: !anything

  - name: Request (worker)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/worker1/configuration"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        data:
          auth: !anything
          cis-cat: !anything
          cluster: !anything
          command: !anything
          global: !anything
          localfile: !anything
          open-scap: !anything
          osquery: !anything
          remote: !anything
          rootcheck: !anything
          ruleset: !anything
          syscheck: !anything
          syscollector: !anything
          vulnerability-detector: !anything

  - name: Filters -> section=alerts (master-node)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/master-node/configuration"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
      params:
        section: alerts
    response:
      status_code: 200
      body:
        data:
          alerts:
            email_alert_level: !anystr
            log_alert_level: !anystr


  - name: Filters -> section=syscheck (master)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/master-node/configuration"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
      params:
        section: syscheck
    response:
      status_code: 200
      body:
        data:
          syscheck:
            alert_new_files: !anystr
            auto_ignore: !anything
            directories: !anything
            disabled: !anystr
            frequency: !anystr
            ignore: !anything
            nodiff: !anything
            scan_on_start: !anystr
            skip_nfs: !anystr

  - name: Filters -> section=syscollector (master)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/master-node/configuration"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
      params:
        section: syscollector
    response:
      status_code: 200
      body:
        data:
          syscollector:
            disabled: !anystr
            hardware: !anystr
            interval: !anystr
            network: !anystr
            os: !anystr
            packages: !anystr
            ports : !anything
            processes: !anystr
            scan_on_start: !anystr

  - name: Filters -> section=alerts (worker1)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/worker1/configuration"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
      params:
        section: alerts
    response:
      status_code: 200
      body:
        data:
          alerts:
            email_alert_level: !anystr
            log_alert_level: !anystr

  - name: Filters -> section=syscheck (worker1)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/worker1/configuration"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
      params:
        section: syscheck
    response:
      status_code: 200
      body:
        data:
          syscheck:
            alert_new_files: !anystr
            auto_ignore: !anything
            directories: !anything
            disabled: !anystr
            frequency: !anystr
            ignore: !anything
            nodiff: !anything
            scan_on_start: !anystr
            skip_nfs: !anystr

  - name: Filters -> section=syscollector (worker1)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/worker1/configuration"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
      params:
        section: syscollector
    response:
      status_code: 200
      body:
        data:
          syscollector:
            disabled: !anystr
            hardware: !anystr
            interval: !anystr
            network: !anystr
            os: !anystr
            packages: !anystr
            ports : !anything
            processes: !anystr
            scan_on_start: !anystr

---
test_name: GET /cluster/configuration/validation

stages:

  - name: Request cluster validation
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/configuration/validation"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        status: OK

  #### Upload corrupted rules file
  - name: Upload corrupted configuration
    request:
      url: "{protocol:s}://{host:s}:{port:d}/manager/files"
      method: PUT
      data: "{corrupted_rules_file}"
      headers:
        Authorization: "Bearer {test_login_token}"
        content-type: application/octet-stream
      params:
        path: etc/rules/new-rules_corrupted.xml
    response:
      status_code: 200
      body:
        message: !anystr

  - name: Request validation
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/configuration/validation"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 400
      body:
        code: 1908
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 400
        title: !anystr
        type: !anystr

    #### Delete corrupted rules file
  - name: Delete rules file
    request:
      url: "{protocol:s}://{host:s}:{port:d}/manager/files"
      method: DELETE
      headers:
        Authorization: "Bearer {test_login_token}"
      params:
        path: etc/rules/new-rules_corrupted.xml
    response:
      status_code: 200
      body:
        message: !anystr

---
test_name: GET /cluster/{node_id}/configuration/validation

marks:
  - parametrize:
      key: node_id
      vals:
        - master-node
        - worker1
        - worker2

stages:

  - name: Request cluster {node_id} validation
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/{node_id}/configuration/validation"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        status: OK

  #### Upload corrupted rules file
  - name: Upload corrupted configuration
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/{node_id}/files"
      method: PUT
      data: "{corrupted_rules_file}"
      headers:
        Authorization: "Bearer {test_login_token}"
        content-type: application/octet-stream
      params:
        path: etc/rules/rules_corrupted.xml
    response:
      status_code: 200
      body:
        message: !anystr

  - name: Request KO validation in {node_id}
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/{node_id}/configuration/validation"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 400
      body:
        code: 1908
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 400
        title: !anystr
        type: !anystr

---
test_name: DELETE /cluster/{node_id}/files

marks:
  - parametrize:
      key: node_id
      vals:
        - master-node
        - worker1
        - worker2

stages:

  - name: Delete rules file
    request: &delete_cluster_files
      url: "{protocol:s}://{host:s}:{port:d}/cluster/{node_id}/files"
      method: DELETE
      headers:
        Authorization: "Bearer {test_login_token}"
      params:
        path: etc/rules/local_rules.xml
    response:
      status_code: 200
      body:
        message: !anystr

  - name: Delete unexisting rules file
    request:
      <<: *delete_cluster_files
      params:
        path: etc/rules/local-rules.xml
    response: &non_existing_file
      status_code: 400
      body:
        code: 1906
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 400
        title: !anystr
        type: !anystr

  - name: Delete decoder file
    request:
      <<: *delete_cluster_files
      params:
        path: etc/decoders/local_decoder.xml
    response:
      status_code: 200
      body:
        message: !anystr

  - name: Delete unexisting decoder file
    request:
      <<: *delete_cluster_files
      params:
        path: etc/decoders/local-decoder.xml
    response:
      <<: *non_existing_file

  - name: Delete CDB list file
    request:
      <<: *delete_cluster_files
      params:
        path: etc/lists/audit-keys
    response:
      status_code: 200
      body:
        message: !anystr

  - name: Delete unexisting CDB list file
    request:
      <<: *delete_cluster_files
      params:
        path: etc/lists/wrong_list
    response:
      <<: *non_existing_file

---
test_name: GET /cluster/{node_id}/files

marks:
  - parametrize:
      key: node_id
      vals:
        - master-node
        - worker1
        - worker2

stages:

  - name: Get ossec.conf {node_id}
    request: &get_cluster_files
      url: "{protocol:s}://{host:s}:{port:d}/cluster/{node_id}/files"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
      params:
        path: etc/ossec.conf
    response:
      status_code: 200
      body:
        data:
          contents: !anystr

  - name: Get local rules {node_id}
    request:
      <<: *get_cluster_files
      params:
        path: etc/rules/local_rules.xml
    response:
      status_code: 200
      body:
        data:
          contents: !anystr

  - name: Get rules {node_id}
    request:
      <<: *get_cluster_files
      params:
        path: ruleset/rules/0350-amazon_rules.xml
    response:
      status_code: 200
      body:
        data:
          contents: !anystr

  - name: Get local decoder {node_id}
    request:
      <<: *get_cluster_files
      params:
        path: etc/decoders/local_decoder.xml
    response:
      status_code: 200
      body:
        data:
          contents: !anystr

  - name: Get decoder {node_id}
    request:
      <<: *get_cluster_files
      params:
        path: ruleset/decoders/0005-wazuh_decoders.xml
    response:
      status_code: 200
      body:
        data:
          contents: !anystr

  - name: Get CDB list {node_id}
    request:
      <<: *get_cluster_files
      params:
        path: etc/lists/audit-keys
    response:
      status_code: 200
      body:
        data:
          contents: !anystr

  - name: Get file with wrong path (master)
    request:
      <<: *get_cluster_files
      params:
        path: wrong_path/file.xml
    response:
      <<: *connexion_error

  - name: Get file with empty path (master)
    request:
      <<: *get_cluster_files
      params:
        path:
    response:
      <<: *connexion_error

---
test_name: PUT /cluster/{node_id}/files

marks:
  - parametrize:
      key: node_id
      vals:
        - master-node
        - worker1
        - worker2

stages:

  #### Save ossec.conf
  - name: Get ossec.conf {node_id}
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/{node_id}/files"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
      params:
        path: etc/ossec.conf
    response:
      save:
        body:
          ossec_conf: data.contents
      status_code: 200
      body:
        data:
          contents: !anystr

  - name: Upload ossec.conf {node_id}
    request: &upload_cluster_files
      url: "{protocol:s}://{host:s}:{port:d}/cluster/{node_id}/files"
      method: PUT
      data: "{ossec_conf}"
      headers:
        Authorization: "Bearer {test_login_token}"
        content-type: application/octet-stream
      params:
        overwrite: True
        path: etc/ossec.conf
    response:
      status_code: 200
      body:
        message: !anystr

  - name: Upload new rules {node_id}
    request:
      <<: *upload_cluster_files
      data: "{new_rules:s}"
      params:
        path: etc/rules/new-rules.xml
    response:
      status_code: 200
      body:
        message: !anystr

  - name: Upload rules (overwrite=false) {node_id}
    request:
      <<: *upload_cluster_files
      data: "{new_rules:s}"
      params:
        path: etc/rules/new-rules.xml
        overwrite: False
    response:
      status_code: 400
      body:
        code: 1905
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 400
        title: !anystr
        type: !anystr

  - name: Upload rules (overwrite=true) {node_id}
    request:
      <<: *upload_cluster_files
      data: "{new_rules:s}"
      params:
        path: etc/rules/new-rules.xml
        overwrite: True
    response:
      status_code: 200
      body:
        message: !anystr

  - name: Upload rules with XML syntax error (overwrite=true)
    request:
      <<: *upload_cluster_files
      data: "{new_rules_with_syntax_error:s}"
      params:
        path: etc/rules/new-rules.xml
        overwrite: True
    response:
      status_code: 400
      body:
        code: 1113
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 400
        title: !anystr
        type: !anystr

  - name: Upload new decoder
    request:
      <<: *upload_cluster_files
      data: "{new_decoder:s}"
      params:
        path: etc/decoders/new-decoder.xml
    response:
      status_code: 200
      body:
        message: !anystr

  - name: Upload decoder (overwrite=false)
    request:
      <<: *upload_cluster_files
      data: "{new_decoder:s}"
      params:
        path: etc/decoders/new-decoder.xml
        overwrite: False
    response:
      status_code: 400
      body:
        code: 1905
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 400
        title: !anystr
        type: !anystr

  - name: Upload decoder (overwrite=true)
    request:
      <<: *upload_cluster_files
      data: "{new_decoder:s}"
      params:
        path: etc/decoders/new-decoder.xml
        overwrite: True
    response:
      status_code: 200
      body:
        message: !anystr

  - name: Upload decoder with XML syntax error (overwrite=true)
    request:
      <<: *upload_cluster_files
      data: "{new_decoder_with_syntax_error:s}"
      params:
        path: etc/decoders/new-decoder.xml
        overwrite: True
    response:
      status_code: 400
      body:
        code: 1113
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 400
        title: !anystr
        type: !anystr

  - name: Upload new CDB list
    request:
      <<: *upload_cluster_files
      data: "{new_cdb_list:s}"
      params:
        path: etc/lists/new-list
    response:
      status_code: 200
      body:
        message: !anystr

  - name: Upload CDB list (overwrite=false)
    request:
      <<: *upload_cluster_files
      data: "{new_cdb_list:s}"
      params:
        path: etc/lists/new-list
        overwrite: False
    response:
      status_code: 400
      body:
        code: 1905
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 400
        title: !anystr
        type: !anystr

  - name: Upload CDB list (overwrite=true)
    request:
      <<: *upload_cluster_files
      data: "{new_cdb_list:s}"
      params:
        path: etc/lists/new-list
        overwrite: True
    response:
      status_code: 200
      body:
        message: !anystr

  - name: Upload CDB list with a syntax error (overwrite=true)
    request:
      <<: *upload_cluster_files
      data: "{new_cdb_list_with_syntax_error:s}"
      params:
        path: etc/lists/new-list
        overwrite: True
    response:
      status_code: 400
      body:
        code: 1802
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 400
        title: !anystr
        type: !anystr

---
test_name: PUT /cluster/wrong_node/files

stages:

  - name: Upload rules to unexisting node (overwrite=false) {node_id}
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/unexisting-node/files"
      method: PUT
      data: "{new_rules:s}"
      headers:
        Authorization: "Bearer {test_login_token}"
        content-type: application/octet-stream
      params:
        path: etc/rules/new-rules.xml
        overwrite: True
    response:
      status_code: 500 # should be 400?
      body:
        code: 3022
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 500
        title: !anystr
        type: !anystr

  - name: Upload decoder to unexisting node
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/unexisting-node/files"
      method: PUT
      data: "{new_decoder:s}"
      headers:
        Authorization: "Bearer {test_login_token}"
        content-type: application/octet-stream
      params:
        path: etc/decoders/new-decoder.xml
        overwrite: True
    response:
      status_code: 500 # should be 400
      body:
        code: 3022
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 500
        title: !anystr
        type: !anystr

  - name: Upload CDB list to unexisting node
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/unexisting-node/files"
      method: PUT
      data: "{new_cdb_list:s}"
      headers:
        Authorization: "Bearer {test_login_token}"
        content-type: application/octet-stream
      params:
        path: etc/lists/new-list
        overwrite: False
    response:
      status_code: 500  # should be 400?
      body:
        code: 3022
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 500
        title: !anystr
        type: !anystr

---
test_name: GET /cluster/{node_id}/info

marks:
  - parametrize:
      key: node_id
      vals:
        - master-node
        - worker1
        - worker2

stages:

  - name: Request {node_id}
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/{node_id}/info"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        data:
          path: !anystr
          version: !anystr
          compilation_date: !anystr
          type: !anystr
          max_agents: !anystr
          openssl_support: !anystr
          ruleset_version: !anystr
          tz_offset: !anystr
          tz_name: !anystr

---
test_name: GET /cluster/{node_id}/logs

marks:
  - parametrize:
      key: node_id
      vals:
        - master-node
        - worker1
        - worker2

stages:

  - name: Request {node_id}
    request: &get_cluster_logs
      url: "{protocol:s}://{host:s}:{port:d}/cluster/{node_id}/logs"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        data:
          items: !anything
          totalItems: !anyint

  - name: Filters -> limit=3 {node_id}
    request:
      <<: *get_cluster_logs
      params:
        limit: 3
    response:
      status_code: 200
      body:
        data:
          items:
            - &cluster_log
              description: !anystr
              level: !anystr
              tag: !anystr
              timestamp: !anystr
            - <<: *cluster_log
            - <<: *cluster_log
          totalItems: !anyint

  - name: Filters -> limit=4 {node_id}
    request:
      <<: *get_cluster_logs
      params:
        limit: 4
    response:
      status_code: 200
      body:
        data:
          items:
            - <<: *cluster_log
            - <<: *cluster_log
            - <<: *cluster_log
            - <<: *cluster_log
          totalItems: !anyint

  - name: Filters -> limit=2, sort=tag {node_id}
    request:
      <<: *get_cluster_logs
      params:
        limit: 2
        sort: tag
    response:
      status_code: 200
      body:
        data:
          items:
            - <<: *cluster_log
            - <<: *cluster_log
          totalItems: !anyint

  - name: Filters -> limit=1, sort=-level {node_id}
    request:
      <<: *get_cluster_logs
      params:
        limit: 1
        sort: -level
    response:
      status_code: 200
      body:
        data:
          items:
            - <<: *cluster_log
          totalItems: !anyint

  - name: Filters -> offset=2, limit=3 {node_id}
    request:
      <<: *get_cluster_logs
      params:
        limit: 3
        offset: 2
    response:
      status_code: 200
      body:
        data:
          items:
            - <<: *cluster_log
            - <<: *cluster_log
            - <<: *cluster_log
          totalItems: !anyint

  - name: Filters -> offset=5, limit=2 {node_id}
    request:
      <<: *get_cluster_logs
      params:
        limit: 2
        offset: 5
    response:
      status_code: 200
      body:
        data:
          items:
            - <<: *cluster_log
            - <<: *cluster_log
          totalItems: !anyint

  - name: Filters -> category=ossec-analysisd, limit=1 {node_id}
    request:
      <<: *get_cluster_logs
      params:
        category: ossec-analysisd
        limit: 1
    response:
      status_code: 200
      body:
        data:
          items:
            - <<: *cluster_log
          totalItems: !anyint

  - name: Filters -> category=ossec-syscheckd, limit=2 {node_id}
    request:
      <<: *get_cluster_logs
      params:
        category: ossec-syscheckd
        limit: 2
    response:
      status_code: 200
      body:
        data:
          items:
            - <<: *cluster_log
            - <<: *cluster_log
          totalItems: !anyint

---
test_name: GET /cluster/{node_id}/logs/summary

marks:
  - parametrize:
      key: node_id
      vals:
        - master-node
        - worker1
        - worker2

stages:

  - name: Request {node_id}
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/{node_id}/logs/summary"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        data:
          ossec-agentlessd: !anything
          ossec-analysisd: !anything
          ossec-authd: !anything
          ossec-csyslogd: !anything
          ossec-dbd: !anything
          ossec-execd: !anything
          ossec-integratord: !anything
          ossec-logcollector: !anything
          ossec-monitord: !anything
          ossec-remoted: !anything
          ossec-rootcheck: !anything
          ossec-syscheckd: !anything
          wazuh-db: !anything
          wazuh-modulesd: !anything
          wazuh-modulesd:ciscat: !anything
          wazuh-modulesd:database: !anything
          wazuh-modulesd:download: !anything
          wazuh-modulesd:oscap: !anything
          wazuh-modulesd:osquery: !anything
          wazuh-modulesd:syscollector: !anything

---
test_name: GET /cluster/{node_id}/stats

marks:
  - parametrize:
      key: node_id
      vals:
        - master-node
        - worker1
        - worker2

stages:

  - name: Cluster stats {node_id} today
    request: &get_cluster_stats
      url: "{protocol:s}://{host:s}:{port:d}/cluster/{node_id}/stats"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 400
      body:
        code: 1308
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 400
        title: !anystr
        type: !anystr

  - name: Cluster stats {node_id} 2019-08-27
    request:
      <<: *get_cluster_stats
      params:
        date: "2019-08-27"
    response:
      status_code: 200
      body:
        data: !anything

  - name: Cluster stats {node_id} day without stats
    request:
      <<: *get_cluster_stats
      params:
        date: "1970-01-01"
    response:
      status_code: 400
      body:
        code: 1310
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 400
        title: !anystr
        type: !anystr

---
test_name: GET /cluster/wrong_node/stats

stages:

  - name: wrong_node stats
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/wrong_node/stats"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 500 #Should be 400?
      body:
        code: 3022
        dapi_errors: !anything
        detail: !anystr
        remediation: !anystr
        status: 500
        title: !anystr
        type: !anystr

---
test_name: GET /cluster/{node_id}/stats/analysisd

marks:
  - parametrize:
      key: node_id
      vals:
        - master-node
        - worker1
        - worker2

stages:

  - name: Analysisd stats {node_id}
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/{node_id}/stats/analysisd"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        data:
          total_events_decoded: !anyfloat
          syscheck_events_decoded: !anyfloat
          syscheck_edps: !anyfloat
          syscollector_events_decoded: !anyfloat
          syscollector_edps: !anyfloat
          rootcheck_events_decoded: !anyfloat
          rootcheck_edps: !anyfloat
          sca_events_decoded: !anyfloat
          sca_edps: !anyfloat
          hostinfo_events_decoded: !anyfloat
          hostinfo_edps: !anyfloat
          winevt_events_decoded: !anyfloat
          winevt_edps: !anyfloat
          other_events_decoded: !anyfloat
          other_events_edps: !anyfloat
          events_processed: !anyfloat
          events_edps: !anyfloat
          events_received: !anyfloat
          events_dropped: !anyfloat
          alerts_written: !anyfloat
          firewall_written: !anyfloat
          fts_written: !anyfloat
          syscheck_queue_usage: !anyfloat
          syscheck_queue_size: !anyfloat
          syscollector_queue_usage: !anyfloat
          syscollector_queue_size: !anyfloat
          rootcheck_queue_usage: !anyfloat
          rootcheck_queue_size: !anyfloat
          sca_queue_usage: !anyfloat
          sca_queue_size: !anyfloat
          hostinfo_queue_usage: !anyfloat
          hostinfo_queue_size: !anyfloat
          winevt_queue_usage: !anyfloat
          winevt_queue_size: !anyfloat
          event_queue_usage: !anyfloat
          event_queue_size: !anyfloat
          rule_matching_queue_usage: !anyfloat
          rule_matching_queue_size: !anyfloat
          alerts_queue_usage: !anyfloat
          alerts_queue_size: !anyfloat
          firewall_queue_usage: !anyfloat
          firewall_queue_size: !anyfloat
          statistical_queue_usage: !anyfloat
          statistical_queue_size: !anyfloat
          archives_queue_usage: !anyfloat
          archives_queue_size: !anyfloat

---
test_name: GET /cluster/{node_id}/stats/hourly

marks:
  - parametrize:
      key: node_id
      vals:
        - master-node
        - worker1
        - worker2

stages:

  - name: Hourly node stats {node_id}
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/{node_id}/stats/hourly"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        data:
          averages: !anything
          interactions: !anyint

---
test_name: GET /cluster/{node_id}/stats/remoted

marks:
  - parametrize:
      key: node_id
      vals:
        - master-node
        - worker1
        - worker2

stages:

  - name: Remoted stats {node_id}
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/{node_id}/stats/remoted"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        data:
          queue_size: !anyfloat
          total_queue_size: !anyfloat
          tcp_sessions: !anyfloat
          evt_count: !anyfloat
          ctrl_msg_count: !anyfloat
          discarded_count: !anyfloat
          msg_sent: !anyfloat
          recv_bytes: !anyfloat

---
test_name: GET /cluster/{node_id}/stats/weekly

marks:
  - parametrize:
      key: node_id
      vals:
        - master-node
        - worker1
        - worker2

stages:

  - name: Weekly node stats {node_id}
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/{node_id}/stats/weekly"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        data:
          Mon:
            hours: !anything
            interactions: !anyint
          Tue:
            hours: !anything
            interactions: !anyint
          Wed:
            hours: !anything
            interactions: !anyint
          Thu:
            hours: !anything
            interactions: !anyint
          Fri:
            hours: !anything
            interactions: !anyint
          Sat:
            hours: !anything
            interactions: !anyint
          Sun:
            hours: !anything
            interactions: !anyint

---
test_name: GET /cluster/{node_id}/status

marks:
  - parametrize:
      key: node_id
      vals:
        - master-node
        - worker1
        - worker2

stages:

  - name: Request {node_id}
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/{node_id}/status"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        data:
          ossec-agentlessd: !anystr
          ossec-analysisd: !anystr
          ossec-authd: !anystr
          ossec-csyslogd: !anystr
          ossec-dbd: !anystr
          ossec-execd: !anystr
          ossec-integratord: !anystr
          ossec-logcollector: !anystr
          ossec-maild: !anystr
          ossec-monitord: !anystr
          ossec-remoted: !anystr
          ossec-reportd: !anystr
          ossec-syscheckd: !anystr
          wazuh-apid: !anystr
          wazuh-clusterd: !anystr
          wazuh-db: !anystr
          wazuh-modulesd: !anystr

---
test_name: PUT /cluster/restart

stages:

  - name: Restart cluster
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/restart"
      method: PUT
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        message: !anystr
    delay_after: 30

---
test_name: PUT /cluster/{node_id}restart

marks:
  - parametrize:
      key: node_id
      vals:
        - master-node
        - worker1
        - worker2

stages:

  - name: Restart {node_id}
    request:
      url: "{protocol:s}://{host:s}:{port:d}/cluster/{node_id}/restart"
      method: PUT
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        message: !anystr
