# Copyright (C) 2015-2021, Wazuh Inc.
# Created by Wazuh, Inc. <info@wazuh.com>.
# This program is free software; you can redistribute it and/or modify it under the terms of GP

from wazuh.core import common
from wazuh.core.agent import Agent
from wazuh.core.utils import WazuhDBQuery, WazuhDBBackend
from datetime import datetime


class WazuhDBQueryVulnerability(WazuhDBQuery):
    """"""
    fields = {
        'name': 'name', 'version': 'version', 'architecture': 'architecture', 'cve': 'cve', 'status': 'status',
        'type': 'type', 'detection_time': 'detection_time', 'severity': 'severity', 'cvss2_score': 'cvss2_score',
        'cvss3_score': 'cvss3_score'
    }

    def __init__(self, agent_id, offset=0, limit=common.database_limit, sort=None, search=None, select=None, query='',
                 count=True, get_data=True, distinct=False, default_sort_field='name', filters=None, fields=fields,
                 table='vuln_cves'):
        if filters is None:
            filters = {}
        # Check if the agent exists
        Agent(agent_id).get_basic_information()
        backend = WazuhDBBackend(agent_id)
        WazuhDBQuery.__init__(self, offset=offset, limit=limit, table=table, sort=sort, search=search,
                              select=select, fields=fields, default_sort_field=default_sort_field,
                              default_sort_order='ASC', filters=filters, query=query, backend=backend,
                              min_select_fields=set(), count=count, get_data=get_data, distinct=distinct)

    def _format_data_into_dictionary(self):
        def format_fields(field_name, value):
            if field_name in ['detection_time', 'last_partial_scan', 'last_full_scan']:
                try:
                    return datetime.utcfromtimestamp(int(value))
                except (ValueError, TypeError):
                    return value
            else:
                return value

        self._data = [{key: format_fields(key, value) for key, value in item.items()} for item in self._data]

        return super()._format_data_into_dictionary()
