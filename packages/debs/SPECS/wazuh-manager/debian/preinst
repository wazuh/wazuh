#!/bin/sh
# preinst script for Wazuh
set -e

# configuration variables
DIR="/var/wazuh-manager"
WAZUH_TMP_DIR="${DIR}/packages_files/manager_config_files"
VERSION="$2"
MAJOR=$(echo "$VERSION" | cut -dv -f2 | cut -d. -f1)

# environment configuration
if [ ! -d ${WAZUH_TMP_DIR} ]; then
    mkdir -p ${WAZUH_TMP_DIR}
else
    rm -rf ${WAZUH_TMP_DIR}
    mkdir -p ${WAZUH_TMP_DIR}
fi

case "$1" in
    install|upgrade)

        # HARD BLOCK: Prevent upgrade from 4.X to 5.X
        if [ "$1" = "upgrade" ] && [ -n "$2" ]; then
            # $2 contains the old version in upgrade scenarios
            OLD_VERSION="$2"
            OLD_MAJOR=$(echo "$OLD_VERSION" | cut -d. -f1)

            if [ "$OLD_MAJOR" = "4" ]; then
                cat <<EOF
==============================================================
ERROR: Direct upgrade from Wazuh Manager 4.X to 5.X is not supported.

Detected installed version: $OLD_VERSION
==============================================================
EOF
                exit 1
            fi
        fi

        if [ "$1" = "upgrade" ]; then
            # Get version information
            if [ -f "${DIR}/bin/wazuh-control" ]; then
                OLD_VERSION=`${DIR}/bin/wazuh-control info -v 2>/dev/null`
                MAJOR_VER=$(echo $OLD_VERSION | cut -dv -f2 | cut -d. -f1)
            elif [ -f ${DIR}/VERSION.json ]; then
                OLD_VERSION=`grep -oP '(?<="version": ")[^"]*' ${DIR}/VERSION.json 2>/dev/null`
                MAJOR_VER=$(echo $OLD_VERSION | cut -d. -f1)
            fi

            # Validate upgrade constraints for Manager
            ERROR_TYPE=""

            # Determine if upgrade should be blocked
            if [ -z "$MAJOR_VER" ]; then
                ERROR_TYPE="no_version"
                ERROR_TITLE="Cannot detect current version"
                ERROR_MESSAGE="Unable to detect the currently installed Wazuh version.
This indicates a very old installation (pre-4.x)."
            elif [ "$MAJOR_VER" -lt 5 ]; then
                ERROR_TYPE="old_version"
                ERROR_TITLE="Clean installation required"
                ERROR_MESSAGE="Current version: $OLD_VERSION
Target version:  5.0.0

Direct upgrade from 4.x to 5.0.0 is NOT supported for Wazuh Manager
due to breaking changes in database schema and architecture."
            fi

            # If any error was detected, show message and block
            if [ -n "$ERROR_TYPE" ]; then
                cat <<EOF >&2
═════════════════════════════════════════════════════════════════
  UPGRADE BLOCKED: $ERROR_TITLE
═════════════════════════════════════════════════════════════════

$ERROR_MESSAGE

Required action:
  1. Backup your configuration and data
  2. Perform a clean installation of Wazuh 5.0.0
  3. Restore configuration as needed

For migration guide, visit:
  https://documentation.wazuh.com/current/migration-guide/
═════════════════════════════════════════════════════════════════
EOF
                exit 1
            fi

            if command -v systemctl > /dev/null 2>&1 && systemctl > /dev/null 2>&1 && systemctl is-active --quiet wazuh-manager > /dev/null 2>&1; then
                systemctl stop wazuh-manager.service > /dev/null 2>&1
                touch ${WAZUH_TMP_DIR}/wazuh.restart
            elif command -v service > /dev/null 2>&1 && service wazuh-manager status 2>/dev/null | grep "is running" > /dev/null 2>&1; then
                service wazuh-manager stop > /dev/null 2>&1
                touch ${WAZUH_TMP_DIR}/wazuh.restart
            elif ${DIR}/bin/wazuh-control status 2>/dev/null | grep "is running" > /dev/null 2>&1; then
                touch ${WAZUH_TMP_DIR}/wazuh.restart
            elif ${DIR}/bin/ossec-control status 2>/dev/null | grep "is running" > /dev/null 2>&1; then
                touch ${WAZUH_TMP_DIR}/wazuh.restart
            fi
            ${DIR}/bin/ossec-control stop > /dev/null 2>&1 || ${DIR}/bin/wazuh-control stop > /dev/null 2>&1
            if pgrep -f ossec-authd > /dev/null 2>&1; then
                kill -15 $(pgrep -f ossec-authd)
            fi

            if [ -d ${DIR}/logs/ossec ]; then
                mv ${DIR}/logs/ossec ${DIR}/logs/wazuh
            fi

            if [ -d ${DIR}/queue/ossec ]; then
                mv ${DIR}/queue/ossec ${DIR}/queue/sockets
            fi

            # Delete old API backups
            if [ -d ${DIR}/~api ]; then
                rm -rf ${DIR}/~api
            fi

            # Delete 3.X Wazuh API service
            if [ "$MAJOR_VER" = "3" ] && [ -d ${DIR}/api ]; then
                if command -v systemctl > /dev/null 2>&1 && systemctl > /dev/null 2>&1 && \
                  systemctl list-unit-files --type service | grep wazuh-api; then
                    systemctl stop wazuh-api.service > /dev/null 2>&1
                    systemctl disable wazuh-api.service > /dev/null 2>&1
                    rm -f /etc/systemd/system/wazuh-api.service || true
                fi

                if command -v service > /dev/null 2>&1 && service status wazuh-api > /dev/null 2>&1 ; then
                    service wazuh-api stop > /dev/null 2>&1
                    update-rc.d wazuh-api remove > /dev/null 2>&1
                    rm -f /etc/rc.d/init.d/wazuh-api || true
                fi
            fi
        fi

        if [ ! -z "$2" ] && [ ! -f ${DIR}/etc/wazuh-manager.conf ] ; then
            touch ${WAZUH_TMP_DIR}/create_conf
        fi

        if [ "$1" = "upgrade" ]; then
            # RBAC database
            if [ -f ${DIR}/api/configuration/security/rbac.db ]; then
                cp -fp ${DIR}/api/configuration/security/rbac.db ${WAZUH_TMP_DIR}/rbac.db
            fi

            # API configuration file
            if [ -f ${DIR}/api/configuration/api.yaml ]; then
                cp -fp ${DIR}/api/configuration/api.yaml ${WAZUH_TMP_DIR}/api.yaml
            fi

            # Agent-groups files
            if [ -d ${DIR}/queue/agent-groups ]; then
                mv -f ${DIR}/queue/agent-groups ${WAZUH_TMP_DIR}/
            fi
        fi

        # Delete old service
        if [ -f /etc/init.d/ossec ]; then
          rm /etc/init.d/ossec
        fi


        if [ -f ${DIR}/etc/client.keys ]; then
            cp -p ${DIR}/etc/client.keys ${WAZUH_TMP_DIR}/client.keys
        fi

        if [ -f ${DIR}/etc/local_internal_options.conf ]; then
            cp -p ${DIR}/etc/local_internal_options.conf ${WAZUH_TMP_DIR}/local_internal_options.conf
        fi

        if [ -f ${DIR}/etc/wazuh-manager.conf ]; then
            cp -p ${DIR}/etc/wazuh-manager.conf ${WAZUH_TMP_DIR}/wazuh-manager.conf
        fi

        if [ -d ${DIR}/etc/shared ]; then
            cp -rp ${DIR}/etc/shared ${WAZUH_TMP_DIR}/group
        fi

        if [ -d ${DIR}/var/db/agents ]; then
            rm -rf ${DIR}/var/db/agents
        fi

        # Remove plain-text agent information if exists
        if [ -d ${DIR}/queue/agent-info ]; then
            rm -rf ${DIR}/queue/agent-info/* > /dev/null 2>&1
        fi

        if [ -d ${DIR}/queue/rootcheck ]; then
            rm -rf ${DIR}/queue/rootcheck/* > /dev/null 2>&1
        fi

        # Remove groups backup content if exists
        if [ -d ${DIR}/backup/groups ]; then
            rm -rf ${DIR}/backup/groups/* > /dev/null 2>&1
        fi
    ;;

    abort-upgrade)

    ;;

    *)
        echo "preinst called with unknown argument \`$1'" >&2
        exit 0

    ;;

esac

exit 0
