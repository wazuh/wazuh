/*
 * Wazuh Vulnerability scanner - Database Feed Manager
 * Copyright (C) 2015, Wazuh Inc.
 * May 1, 2023.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#include "databaseFeedManager.hpp"
#include "../policyManager/policyManager.hpp"
#include "eventDecoder.hpp"
#include "feedIndexer.hpp"
#include "scanDispatcher.hpp"
#include "storeModel.hpp"
#include <memory>

DatabaseFeedManager::DatabaseFeedManager(std::shared_ptr<IndexerConnector> indexerConnector)
    : Observer("database_feed_manager")
    , m_indexerConnector(indexerConnector)
{

    const auto updaterPolicy = PolicyManager::instance().getUpdaterConfiguration();
    // Vulnerability content updater initialization.
    m_contentRegistration = std::make_unique<ContentRegister>(updaterPolicy.at("topicName"),
                                                              PolicyManager::instance().getUpdaterConfiguration());

    // Subscription to vulnerability detector content update events.
    m_contentUpdateSubscription =
        std::make_unique<RouterSubscriber>(updaterPolicy.at("topicName"), "vulnerability_feed_manager");

    m_contentUpdateSubscription->subscribe(
        [this](const std::vector<char>& message)
        {
            std::cout << "DatabaseFeedManager::update" << std::endl;
            auto eventContext = std::make_shared<EventContext>(
                EventContext {.indexerConnector = m_indexerConnector, .message = message});
            auto eventDecoder = std::make_shared<EventDecoder>();
            eventDecoder->setLast(std::make_shared<StoreModel>());
            eventDecoder->setLast(std::make_shared<FeedIndexer>());
            eventDecoder->setLast(std::make_shared<ScanDispatcher>());

            eventDecoder->handleRequest(eventContext);
        });
}

