/*
 * Wazuh Vulnerability scanner
 * Copyright (C) 2015, Wazuh Inc.
 * March 8, 2024.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General
 * Public License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#ifndef _EVENT_SEND_REPORT_HPP
#define _EVENT_SEND_REPORT_HPP

#include "chainOfResponsability.hpp"
#include "loggerHelper.h"
#include "scanContext.hpp"
#include "vulnerabilityScanner.hpp"
#include <sstream>

/**
 * @brief Class in charge of sending formatted report messages.
 *
 * This class is responsible for sending the vulnerability events (ECS JSON)
 * to the analysisd queue.
 *
 * It now uses:
 *   - ScanContext::detectedCVEs() to know operation and component type.
 *   - ScanContext::ecsEvents() / getECSEvent() to get the final ECS JSON.
 *
 * To distinguish INSERT vs DELETE operations (because ECS JSON is identical),
 * we encode the operation in the "location" field of the log line:
 *
 *   LOCALFILE_MQ:[id] (name) ip->vulnerability-detector-insert:<json>
 *   LOCALFILE_MQ:[id] (name) ip->vulnerability-detector-delete:<json>
 *
 * So the engine can differentiate them without touching the ECS payload.
 *
 * @tparam TScanContext scan context type.
 * @tparam TReportDispatcher report dispatcher type.
 */
template<typename TScanContext = ScanContext, typename TReportDispatcher = ReportDispatcher>
class TEventSendReport final : public AbstractHandler<std::shared_ptr<TScanContext>>
{
private:
    std::shared_ptr<TReportDispatcher> m_reportDispatcher;

public:
    // LCOV_EXCL_START
    /**
     * @brief Construct a new Send Report object.
     *
     * @param reportDispatcher Report queue instance.
     */
    explicit TEventSendReport(std::shared_ptr<TReportDispatcher> reportDispatcher)
        : m_reportDispatcher(std::move(reportDispatcher))
    {
    }
    // LCOV_EXCL_STOP

    /**
     * @brief Handles request and passes control to the next step of the chain.
     *
     * @param data Scan context.
     * @return std::shared_ptr<TScanContext> Abstract handler.
     */
    std::shared_ptr<TScanContext> handleRequest(std::shared_ptr<TScanContext> data) override
    {
        const auto& detected = data->detectedCVEs();

        logDebug2(WM_VULNSCAN_LOGTAG,
                  "EventSendReport - Sending %zu detections (ecsEvents=%zu)",
                  detected.size(),
                  data->ecsEventCount());

        for (const auto& [detectionId, detection] : detected)
        {
            try
            {
                // Get ECS JSON previously built by EventDetailsBuilder
                const std::string* ecsJson = data->getECSEvent(detectionId);
                if (!ecsJson)
                {
                    logDebug2(WM_VULNSCAN_LOGTAG,
                              "EventSendReport - No ECS event found for detection '%s', skipping",
                              detectionId.c_str());
                    continue;
                }

                // Operation marker in "location" component of log line
                const char* opSuffix =
                    (detection.operation == ElementOperation::Delete) ? "delete" : "insert";

                std::ostringstream oss;

                // Format:
                // LOCALFILE_MQ:[001] (agent_name) ip->vulnerability-detector-<op>:<ecs_json>
                //
                // Example:
                // 1:[001] (ubuntu-agent) 10.0.0.1->vulnerability-detector-insert:{...}
                oss << LOCALFILE_MQ << ":"
                    << "[" << data->agentId() << "] (" << data->agentName() << ") "
                    << data->agentIP() << "->"
                    << "vulnerability-detector-" << opSuffix << ":"
                    << *ecsJson;

                // Send asynchronously
                m_reportDispatcher->push(oss.str());

                // Logging by affected component type
                const auto& vuln = detection.vulnerability;
                const auto& pkg  = detection.package;

                switch (detection.componentType)
                {
                    case AffectedComponentType::Package:
                        logDebug2(WM_VULNSCAN_LOGTAG,
                                  "EventSendReport - %s vulnerability report for agent '%s', package '%s', CVE '%s', "
                                  "detectionId='%s'",
                                  (detection.operation == ElementOperation::Delete) ? "DELETE" : "INSERT",
                                  data->agentId().data(),
                                  pkg.name.c_str(),
                                  vuln.id.c_str(),
                                  detectionId.c_str());
                        break;

                    case AffectedComponentType::Os:
                        logDebug2(WM_VULNSCAN_LOGTAG,
                                  "EventSendReport - %s vulnerability report for agent '%s', OS '%s', CVE '%s', "
                                  "detectionId='%s'",
                                  (detection.operation == ElementOperation::Delete) ? "DELETE" : "INSERT",
                                  data->agentId().data(),
                                  data->osName().data(),
                                  vuln.id.c_str(),
                                  detectionId.c_str());
                        break;

                    default:
                        logWarn(WM_VULNSCAN_LOGTAG,
                                "EventSendReport - %s vulnerability report for agent '%s', CVE '%s', "
                                "detectionId='%s' (unknown component type %d)",
                                (detection.operation == ElementOperation::Delete) ? "DELETE" : "INSERT",
                                data->agentId().data(),
                                vuln.id.c_str(),
                                detectionId.c_str(),
                                static_cast<int>(detection.componentType));
                        break;
                }
            }
            catch (...)
            {
                logWarn(WM_VULNSCAN_LOGTAG,
                        "EventSendReport - Couldn't send vulnerability JSON report for detection '%s'.",
                        detectionId.c_str());
            }
        }

        data->logDebugContext();
        return AbstractHandler<std::shared_ptr<TScanContext>>::handleRequest(std::move(data));
    }
};

using EventSendReport = TEventSendReport<>;

#endif // _EVENT_SEND_REPORT_HPP
