/*
 * Wazuh Vulnerability Scanner - Unit Tests
 * Copyright (C) 2015, Wazuh Inc.
 * September 21, 2023.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#include "scanContext_test.hpp"
#include "../scanOrchestrator/scanContext.hpp"
#include "MockGlobalData.hpp"
#include "MockOsDataCache.hpp"
#include "TrampolineGlobalData.hpp"
#include "TrampolineOsDataCache.hpp"
#include "json.hpp"

using ::testing::_;
using scanContext_t = TScanContext<TrampolineOsDataCache, GlobalData>;

namespace NSScanContextTest
{
    // Helper function to create a base Context with agent info
    Context createBaseContext()
    {
        Context ctx;
        ctx.agentId = "001";
        ctx.agentName = "focal";
        ctx.agentVersion = "";
        ctx.architecture = "x86_64";
        ctx.hostname = "test-host";
        ctx.osname = "Ubuntu";
        ctx.osplatform = "ubuntu";
        ctx.ostype = "Linux";
        ctx.osversion = "20.04";
        ctx.sessionId = 0;
        ctx.globalVersion = 0;
        ctx.moduleName = "syscollector";
        return ctx;
    }

    // Helper: Create Context for package operations (delta context - no full scan)
    Context createPackageContext()
    {
        Context ctx = createBaseContext();
        ctx.indices = {"wazuh-states-inventory-packages"};
        return ctx;
    }

    // Helper: Create Context for OS info scan (full scan context)
    Context createOsInfoContext()
    {
        Context ctx = createBaseContext();
        ctx.indices = {"wazuh-states-inventory-system"}; // OS index triggers full scan
        ctx.architecture = "x86_64";
        ctx.hostname = "redhat";
        ctx.osname = "Redhat";
        ctx.osplatform = "rhel";
        ctx.ostype = "Linux";
        ctx.osversion = "9.0.6";
        return ctx;
    }

    // Helper: Create Context for hotfix operations (full scan context)
    Context createHotfixContext()
    {
        Context ctx = createBaseContext();
        ctx.indices = {"wazuh-states-inventory-hotfixes"}; // Hotfix index triggers full scan
        return ctx;
    }

    const Os osData {.hostName = "osdata_hostname",
                     .architecture = "osdata_architecture",
                     .name = "osdata_name",
                     .codeName = "osdata_codeName",
                     .majorVersion = "osdata_majorVersion",
                     .minorVersion = "osdata_minorVersion",
                     .patch = "osdata_patch",
                     .build = "osdata_build",
                     .platform = "osdata_platform",
                     .version = "osdata_version",
                     .release = "osdata_release",
                     .displayVersion = "osdata_displayVersion",
                     .sysName = "osdata_sysName",
                     .kernelVersion = "osdata_kernelVersion",
                     .kernelRelease = "osdata_kernelRelease"};

    // Helper for tests that need OS data
    void expectOsData()
    {
        spOsDataCacheMock = std::make_shared<MockOsDataCache>();
        EXPECT_CALL(*spOsDataCacheMock, getOsData(_, _))
            .WillOnce(testing::Invoke(
                [](const std::string&, Os& osDataResult)
                {
                    osDataResult = osData;
                    return true;
                }));
    }
} // namespace NSScanContextTest

using namespace NSScanContextTest;

void ScanContextTest::TearDown()
{
    spGlobalDataMock.reset();
    spOsDataCacheMock.reset();
}

TEST_F(ScanContextTest, TestBasicContextConstruction)
{
    Context ctx = createBaseContext();

    std::shared_ptr<scanContext_t> scanContext;
    EXPECT_NO_THROW(scanContext = std::make_shared<scanContext_t>(ctx));

    EXPECT_STREQ(scanContext->agentId().data(), "001");
    EXPECT_STREQ(scanContext->agentName().data(), "focal");
    EXPECT_STREQ(scanContext->osHostName().data(), "test-host");
    EXPECT_STREQ(scanContext->osArchitecture().data(), "x86_64");
    EXPECT_STREQ(scanContext->osName().data(), "Ubuntu");
    EXPECT_STREQ(scanContext->osPlatform().data(), "ubuntu");
    EXPECT_STREQ(scanContext->osKernelSysName().data(), "Linux");
    EXPECT_STREQ(scanContext->osVersion().data(), "20.04");
}

TEST_F(ScanContextTest, TestPackageContext)
{
    Context ctx = createPackageContext();

    std::shared_ptr<scanContext_t> scanContext;
    EXPECT_NO_THROW(scanContext = std::make_shared<scanContext_t>(ctx));

    EXPECT_FALSE(scanContext->isFullScanContext());
    EXPECT_STREQ(scanContext->agentId().data(), "001");
    EXPECT_STREQ(scanContext->osName().data(), "Ubuntu");
}

TEST_F(ScanContextTest, TestOsInfoContextFullScan)
{
    Context ctx = createOsInfoContext();

    std::shared_ptr<scanContext_t> scanContext;
    EXPECT_NO_THROW(scanContext = std::make_shared<scanContext_t>(ctx));

    EXPECT_TRUE(scanContext->isFullScanContext());
    EXPECT_STREQ(scanContext->agentId().data(), "001");
    EXPECT_STREQ(scanContext->osHostName().data(), "redhat");
    EXPECT_STREQ(scanContext->osName().data(), "Redhat");
    EXPECT_STREQ(scanContext->osPlatform().data(), "rhel");
    EXPECT_STREQ(scanContext->osVersion().data(), "9.0.6");
}

TEST_F(ScanContextTest, TestHotfixContextFullScan)
{
    Context ctx = createHotfixContext();

    std::shared_ptr<scanContext_t> scanContext;
    EXPECT_NO_THROW(scanContext = std::make_shared<scanContext_t>(ctx));

    EXPECT_TRUE(scanContext->isFullScanContext());
    EXPECT_STREQ(scanContext->agentId().data(), "001");
}

TEST_F(ScanContextTest, TestContextWithMultipleIndices)
{
    Context ctx = createBaseContext();
    ctx.indices = {"wazuh-states-inventory-packages", "wazuh-states-inventory-system"};

    std::shared_ptr<scanContext_t> scanContext;
    EXPECT_NO_THROW(scanContext = std::make_shared<scanContext_t>(ctx));

    EXPECT_TRUE(scanContext->isFullScanContext());
}

// ============================================================================
// AGENT CONTEXT DATA TESTS
// ============================================================================

TEST_F(ScanContextTest, TestAgentContextAccessors)
{
    Context ctx = createBaseContext();
    ctx.agentId = "007";
    ctx.agentName = "test-agent";
    ctx.agentVersion = "v4.5.0";
    ctx.groups = {"group1", "group2", "group3"};

    auto scanContext = std::make_shared<scanContext_t>(ctx);

    EXPECT_STREQ(scanContext->agentId().data(), "007");
    EXPECT_STREQ(scanContext->agentName().data(), "test-agent");
    EXPECT_STREQ(scanContext->agentVersion().data(), "v4.5.0");
    EXPECT_STREQ(scanContext->agentHostArchitecture().data(), "x86_64");
    EXPECT_STREQ(scanContext->agentHostName().data(), "test-host");
    EXPECT_STREQ(scanContext->agentHostOsName().data(), "Ubuntu");
    EXPECT_STREQ(scanContext->agentHostOsPlatform().data(), "ubuntu");
    EXPECT_STREQ(scanContext->agentHostOsType().data(), "Linux");
    EXPECT_STREQ(scanContext->agentHostOsVersion().data(), "20.04");

    const auto& groups = scanContext->agentGroups();
    EXPECT_EQ(groups.size(), 3);
    EXPECT_EQ(groups[0], "group1");
    EXPECT_EQ(groups[1], "group2");
    EXPECT_EQ(groups[2], "group3");
}

TEST_F(ScanContextTest, TestSetAgentIP)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    EXPECT_TRUE(scanContext->agentIP().empty());

    scanContext->setAgentIP("192.168.1.100");
    EXPECT_STREQ(scanContext->agentIP().data(), "192.168.1.100");

    scanContext->setAgentIP("10.0.0.1");
    EXPECT_STREQ(scanContext->agentIP().data(), "10.0.0.1");
}

// ============================================================================
// PACKAGE MANAGEMENT TESTS
// ============================================================================

TEST_F(ScanContextTest, TestAddPackageToContext)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    EXPECT_EQ(scanContext->packageCount(), 0);

    PackageContextData pkg;
    pkg.name = "libssl";
    pkg.version = "1.1.1";
    pkg.format = "deb";
    pkg.architecture = "amd64";
    pkg.vendor = "Ubuntu";
    pkg.size = 1024000;

    std::string detectionIdBase = scanContext->buildPackageDetectionIdBase("pkg123");
    scanContext->addPackageToContext(detectionIdBase, pkg, ElementOperation::Upsert);

    EXPECT_EQ(scanContext->packageCount(), 1);
}

TEST_F(ScanContextTest, TestBuildPackageDetectionIdBase)
{
    Context ctx = createBaseContext();
    ctx.agentId = "007";
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    std::string id = scanContext->buildPackageDetectionIdBase("package_hash_123");
    EXPECT_EQ(id, "007_package_hash_123");
}

TEST_F(ScanContextTest, TestDetectionIdBaseFromDetection)
{
    std::string detectionId = "001_pkg_hash_CVE-2023-1234";
    std::string base = scanContext_t::detectionIdBaseFromDetection(detectionId);
    EXPECT_EQ(base, "001_pkg_hash");

    std::string detectionId2 = "123_abcdef_CVE-2024-9999";
    std::string base2 = scanContext_t::detectionIdBaseFromDetection(detectionId2);
    EXPECT_EQ(base2, "123_abcdef");
}

TEST_F(ScanContextTest, TestFindPackageByDetectionBase)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    PackageContextData pkg;
    pkg.name = "openssl";
    pkg.version = "1.1.1k";
    pkg.format = "deb";

    std::string detectionIdBase = scanContext->buildPackageDetectionIdBase("pkg456");
    scanContext->addPackageToContext(detectionIdBase, pkg, ElementOperation::Upsert);

    const auto* found = scanContext->findPackageByDetectionBase(detectionIdBase);
    ASSERT_NE(found, nullptr);
    EXPECT_EQ(found->name, "openssl");
    EXPECT_EQ(found->version, "1.1.1k");
    EXPECT_EQ(found->operation, ElementOperation::Upsert);
}

TEST_F(ScanContextTest, TestFindPackageByDetectionId)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    PackageContextData pkg;
    pkg.name = "curl";
    pkg.version = "7.68.0";

    std::string detectionIdBase = scanContext->buildPackageDetectionIdBase("pkg789");
    scanContext->addPackageToContext(detectionIdBase, pkg, ElementOperation::Upsert);

    std::string detectionId = detectionIdBase + "_CVE-2023-1234";
    const auto* found = scanContext->findPackageByDetectionId(detectionId);
    ASSERT_NE(found, nullptr);
    EXPECT_EQ(found->name, "curl");
}

TEST_F(ScanContextTest, TestFindPackageNotFound)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    const auto* found = scanContext->findPackageByDetectionBase("nonexistent");
    EXPECT_EQ(found, nullptr);

    const auto* found2 = scanContext->findPackageByDetectionId("nonexistent_CVE-2023-1234");
    EXPECT_EQ(found2, nullptr);
}

TEST_F(ScanContextTest, TestPackagesAccessor)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    PackageContextData pkg1;
    pkg1.name = "pkg1";
    PackageContextData pkg2;
    pkg2.name = "pkg2";

    scanContext->addPackageToContext("001_p1", pkg1, ElementOperation::Upsert);
    scanContext->addPackageToContext("001_p2", pkg2, ElementOperation::Delete);

    const auto& packages = scanContext->packages();
    EXPECT_EQ(packages.size(), 2);
    EXPECT_EQ(packages.at("001_p1").name, "pkg1");
    EXPECT_EQ(packages.at("001_p2").operation, ElementOperation::Delete);
}

TEST_F(ScanContextTest, TestClearPackages)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    PackageContextData pkg;
    pkg.name = "test";
    scanContext->addPackageToContext("001_pkg1", pkg, ElementOperation::Upsert);
    scanContext->addPackageToContext("001_pkg2", pkg, ElementOperation::Upsert);
    scanContext->addPackageToContext("001_pkg3", pkg, ElementOperation::Delete);

    EXPECT_EQ(scanContext->packageCount(), 3);

    scanContext->clearPackages();
    EXPECT_EQ(scanContext->packageCount(), 0);
}

// ============================================================================
// HOTFIX MANAGEMENT TESTS
// ============================================================================

TEST_F(ScanContextTest, TestAddHotfixToContext)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    EXPECT_EQ(scanContext->hotfixCount(), 0);

    HotfixContextData hotfix;
    hotfix.hotfixName = "KB5001234";

    scanContext->addHotfixToContext(hotfix);
    EXPECT_EQ(scanContext->hotfixCount(), 1);
}

TEST_F(ScanContextTest, TestAddHotfixMoveSemantics)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    HotfixContextData hotfix;
    hotfix.hotfixName = "KB5005678";

    scanContext->addHotfixToContext(std::move(hotfix));
    EXPECT_EQ(scanContext->hotfixCount(), 1);
}

TEST_F(ScanContextTest, TestGetHotfixContextData)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    HotfixContextData hotfix1;
    hotfix1.hotfixName = "KB111";
    HotfixContextData hotfix2;
    hotfix2.hotfixName = "KB222";
    HotfixContextData hotfix3;
    hotfix3.hotfixName = "KB333";

    scanContext->addHotfixToContext(hotfix1);
    scanContext->addHotfixToContext(hotfix2);
    scanContext->addHotfixToContext(hotfix3);

    EXPECT_EQ(scanContext->getHotfixContextData(0).hotfixName, "KB111");
    EXPECT_EQ(scanContext->getHotfixContextData(1).hotfixName, "KB222");
    EXPECT_EQ(scanContext->getHotfixContextData(2).hotfixName, "KB333");
}

TEST_F(ScanContextTest, TestHotfixesAccessor)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    HotfixContextData h1;
    h1.hotfixName = "KB1";
    HotfixContextData h2;
    h2.hotfixName = "KB2";

    scanContext->addHotfixToContext(h1);
    scanContext->addHotfixToContext(h2);

    const auto& hotfixes = scanContext->hotfixes();
    EXPECT_EQ(hotfixes.size(), 2);
    EXPECT_EQ(hotfixes[0].hotfixName, "KB1");
    EXPECT_EQ(hotfixes[1].hotfixName, "KB2");
}

TEST_F(ScanContextTest, TestClearHotfixes)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    HotfixContextData hotfix;
    scanContext->addHotfixToContext(hotfix);
    scanContext->addHotfixToContext(hotfix);
    scanContext->addHotfixToContext(hotfix);

    EXPECT_EQ(scanContext->hotfixCount(), 3);

    scanContext->clearHotfixes();
    EXPECT_EQ(scanContext->hotfixCount(), 0);
}

// ============================================================================
// CVE DETECTION MANAGEMENT TESTS
// ============================================================================

TEST_F(ScanContextTest, TestAddDetectedCVE)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    EXPECT_EQ(scanContext->cveCount(), 0);

    CVEDetectionResult detection;
    detection.cveId = "CVE-2023-1234";
    detection.componentType = AffectedComponentType::Package;
    detection.matchCondition = "version < 2.0";

    scanContext->addDetectedCVE("001_pkg1_CVE-2023-1234", std::move(detection));
    EXPECT_EQ(scanContext->cveCount(), 1);
}

TEST_F(ScanContextTest, TestHasCVE)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    CVEDetectionResult detection;
    detection.cveId = "CVE-2023-5678";

    std::string detectionId = "001_pkg1_CVE-2023-5678";
    scanContext->addDetectedCVE(detectionId, std::move(detection));

    EXPECT_TRUE(scanContext->hasCVE(detectionId));
    EXPECT_FALSE(scanContext->hasCVE("nonexistent"));
}

TEST_F(ScanContextTest, TestGetCVE)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    CVEDetectionResult detection;
    detection.cveId = "CVE-2023-9999";
    detection.matchCondition = "version < 2.0";
    detection.componentType = AffectedComponentType::Package;

    std::string detectionId = "001_pkg1_CVE-2023-9999";
    scanContext->addDetectedCVE(detectionId, std::move(detection));

    const auto* found = scanContext->getCVE(detectionId);
    ASSERT_NE(found, nullptr);
    EXPECT_EQ(found->cveId, "CVE-2023-9999");
    EXPECT_EQ(found->matchCondition, "version < 2.0");
    EXPECT_EQ(found->componentType, AffectedComponentType::Package);
}

TEST_F(ScanContextTest, TestGetCVEMutable)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    CVEDetectionResult detection;
    detection.cveId = "CVE-2023-1111";
    detection.matchCondition = "original";

    std::string detectionId = "001_pkg1_CVE-2023-1111";
    scanContext->addDetectedCVE(detectionId, std::move(detection));

    auto* found = scanContext->getCVE(detectionId);
    ASSERT_NE(found, nullptr);
    found->matchCondition = "modified";

    const auto* foundConst = scanContext->getCVE(detectionId);
    EXPECT_EQ(foundConst->matchCondition, "modified");
}

TEST_F(ScanContextTest, TestGetCVENotFound)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    const auto* found = scanContext->getCVE("nonexistent");
    EXPECT_EQ(found, nullptr);
}

TEST_F(ScanContextTest, TestRemoveCVE)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    CVEDetectionResult detection;
    detection.cveId = "CVE-2023-1111";

    std::string detectionId = "001_pkg1_CVE-2023-1111";
    scanContext->addDetectedCVE(detectionId, std::move(detection));
    scanContext->addECSEvent(detectionId, R"({"test":"event"})");

    EXPECT_TRUE(scanContext->hasCVE(detectionId));
    EXPECT_EQ(scanContext->ecsEventCount(), 1);

    scanContext->removeCVE(detectionId);
    EXPECT_FALSE(scanContext->hasCVE(detectionId));
    EXPECT_EQ(scanContext->ecsEventCount(), 0);
}

TEST_F(ScanContextTest, TestDetectedCVEsAccessor)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    CVEDetectionResult d1;
    d1.cveId = "CVE-1";
    CVEDetectionResult d2;
    d2.cveId = "CVE-2";

    scanContext->addDetectedCVE("id1", std::move(d1));
    scanContext->addDetectedCVE("id2", std::move(d2));

    const auto& cves = scanContext->detectedCVEs();
    EXPECT_EQ(cves.size(), 2);
    EXPECT_EQ(cves.at("id1").cveId, "CVE-1");
    EXPECT_EQ(cves.at("id2").cveId, "CVE-2");
}

TEST_F(ScanContextTest, TestDetectedCVEsMutableAccessor)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    CVEDetectionResult detection;
    detection.cveId = "CVE-2023-1234";
    scanContext->addDetectedCVE("id1", std::move(detection));

    auto& cves = scanContext->detectedCVEs();
    cves["id1"].matchCondition = "updated";

    EXPECT_EQ(scanContext->getCVE("id1")->matchCondition, "updated");
}

TEST_F(ScanContextTest, TestClearCVEs)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    CVEDetectionResult detection;
    scanContext->addDetectedCVE("id1", CVEDetectionResult {detection});
    scanContext->addDetectedCVE("id2", CVEDetectionResult {detection});
    scanContext->addDetectedCVE("id3", CVEDetectionResult {detection});

    EXPECT_EQ(scanContext->cveCount(), 3);

    scanContext->clearCVEs();
    EXPECT_EQ(scanContext->cveCount(), 0);
}

// ============================================================================
// ECS EVENTS MANAGEMENT TESTS
// ============================================================================

TEST_F(ScanContextTest, TestAddECSEvent)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    EXPECT_EQ(scanContext->ecsEventCount(), 0);

    std::string eventJSON = R"({"vulnerability":{"id":"CVE-2023-1234"}})";
    scanContext->addECSEvent("001_pkg1_CVE-2023-1234", std::move(eventJSON));

    EXPECT_EQ(scanContext->ecsEventCount(), 1);
}

TEST_F(ScanContextTest, TestGetECSEvent)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    std::string eventJSON = R"({"test":"data","nested":{"field":"value"}})";
    std::string detectionId = "001_pkg1_CVE-2023-5678";

    scanContext->addECSEvent(detectionId, std::string(eventJSON));

    const auto* found = scanContext->getECSEvent(detectionId);
    ASSERT_NE(found, nullptr);
    EXPECT_EQ(*found, eventJSON);
}

TEST_F(ScanContextTest, TestGetECSEventNotFound)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    const auto* found = scanContext->getECSEvent("nonexistent");
    EXPECT_EQ(found, nullptr);
}

TEST_F(ScanContextTest, TestECSEventsAccessor)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    scanContext->addECSEvent("id1", R"({"event":"1"})");
    scanContext->addECSEvent("id2", R"({"event":"2"})");
    scanContext->addECSEvent("id3", R"({"event":"3"})");

    const auto& events = scanContext->ecsEvents();
    EXPECT_EQ(events.size(), 3);
    EXPECT_EQ(events.at("id1"), R"({"event":"1"})");
    EXPECT_EQ(events.at("id2"), R"({"event":"2"})");
    EXPECT_EQ(events.at("id3"), R"({"event":"3"})");
}

TEST_F(ScanContextTest, TestClearECSEvents)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    scanContext->addECSEvent("id1", R"({})");
    scanContext->addECSEvent("id2", R"({})");

    EXPECT_EQ(scanContext->ecsEventCount(), 2);

    scanContext->clearECSEvents();
    EXPECT_EQ(scanContext->ecsEventCount(), 0);
}

// ============================================================================
// OS DATA ACCESSOR TESTS
// ============================================================================

TEST_F(ScanContextTest, TestOSDataAccessors)
{
    Context ctx = createOsInfoContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    EXPECT_STREQ(scanContext->osHostName().data(), "redhat");
    EXPECT_STREQ(scanContext->osArchitecture().data(), "x86_64");
    EXPECT_STREQ(scanContext->osName().data(), "Redhat");
    EXPECT_STREQ(scanContext->osPlatform().data(), "rhel");
    EXPECT_STREQ(scanContext->osVersion().data(), "9.0.6");
    EXPECT_STREQ(scanContext->osKernelSysName().data(), "Linux");
}

TEST_F(ScanContextTest, TestSetOSData)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    OsContextData osData;
    osData.item_id = "os_123";
    osData.hostName = "new-host";
    osData.name = "Debian";
    osData.version = "11.5";
    osData.platform = "debian";
    osData.majorVersion = "11";
    osData.minorVersion = "5";
    osData.codeName = "bullseye";
    osData.architecture = "amd64";
    osData.sysName = "Linux";
    osData.kernelVersion = "5.10.0";
    osData.kernelRelease = "5.10.0-20-amd64";

    scanContext->setOSData(osData);

    EXPECT_STREQ(scanContext->osItemId().data(), "os_123");
    EXPECT_STREQ(scanContext->osHostName().data(), "new-host");
    EXPECT_STREQ(scanContext->osName().data(), "Debian");
    EXPECT_STREQ(scanContext->osVersion().data(), "11.5");
    EXPECT_STREQ(scanContext->osMajorVersion().data(), "11");
    EXPECT_STREQ(scanContext->osMinorVersion().data(), "5");
    EXPECT_STREQ(scanContext->osCodeName().data(), "bullseye");
}

TEST_F(ScanContextTest, TestBuildOSFullName)
{
    Context ctx = createOsInfoContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    std::string fullName = scanContext->buildOSFullName();
    EXPECT_EQ(fullName, "Redhat 9.0.6");
}

TEST_F(ScanContextTest, TestBuildOSVersion)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    OsContextData osData;
    osData.majorVersion = "8";
    osData.minorVersion = "5";
    osData.patch = "3";
    osData.build = "1234";

    scanContext->setOSData(osData);

    std::string version = scanContext->buildOSVersion();
    EXPECT_EQ(version, "8.5.3.1234");
}

TEST_F(ScanContextTest, TestBuildOSVersionPartial)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    OsContextData osData;
    osData.majorVersion = "10";
    osData.minorVersion = "0";

    scanContext->setOSData(osData);

    std::string version = scanContext->buildOSVersion();
    EXPECT_EQ(version, "10.0");
}

TEST_F(ScanContextTest, TestOSKernelAccessors)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    OsContextData osData;
    osData.kernelVersion = "5.15.0";
    osData.kernelRelease = "5.15.0-91-generic";
    osData.release = "20.04.5 LTS";
    osData.displayVersion = "20.04.5";

    scanContext->setOSData(osData);

    EXPECT_STREQ(scanContext->osKernelVersion().data(), "5.15.0");
    EXPECT_STREQ(scanContext->osKernelRelease().data(), "5.15.0-91-generic");
    EXPECT_STREQ(scanContext->osRelease().data(), "20.04.5 LTS");
    EXPECT_STREQ(scanContext->osDisplayVersion().data(), "20.04.5");
}

// ============================================================================
// OS DELETED DATA TESTS
// ============================================================================

TEST_F(ScanContextTest, TestSetDeletedOSData)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    EXPECT_FALSE(scanContext->hasDeletedOSItemId());

    OsContextData osData;
    osData.item_id = "os_item_123";
    osData.name = "Ubuntu";
    osData.version = "20.04";
    osData.platform = "ubuntu";
    osData.architecture = "x86_64";
    osData.codeName = "focal";

    scanContext->setDeletedOSData(osData);

    EXPECT_TRUE(scanContext->hasDeletedOSItemId());
    EXPECT_STREQ(scanContext->deletedOSItemId().data(), "os_item_123");
    EXPECT_STREQ(scanContext->deletedOSName().data(), "Ubuntu");
    EXPECT_STREQ(scanContext->deletedOSVersion().data(), "20.04");
    EXPECT_STREQ(scanContext->deletedOSPlatform().data(), "ubuntu");
    EXPECT_STREQ(scanContext->deletedOSArchitecture().data(), "x86_64");
    EXPECT_STREQ(scanContext->deletedOSCodeName().data(), "focal");
}

TEST_F(ScanContextTest, TestAffectedComponentType)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    EXPECT_EQ(scanContext->affectedComponentType(), AffectedComponentType::Unknown);

    scanContext->setAffectedComponentType(AffectedComponentType::Package);
    EXPECT_EQ(scanContext->affectedComponentType(), AffectedComponentType::Package);

    scanContext->setAffectedComponentType(AffectedComponentType::Os);
    EXPECT_EQ(scanContext->affectedComponentType(), AffectedComponentType::Os);

    scanContext->setAffectedComponentType(AffectedComponentType::Hotfix);
    EXPECT_EQ(scanContext->affectedComponentType(), AffectedComponentType::Hotfix);
}

TEST_F(ScanContextTest, TestInventoryEmptyFlag)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    EXPECT_FALSE(scanContext->isInventoryEmpty());

    scanContext->setInventoryEmpty(true);
    EXPECT_TRUE(scanContext->isInventoryEmpty());

    scanContext->setInventoryEmpty(false);
    EXPECT_FALSE(scanContext->isInventoryEmpty());
}

TEST_F(ScanContextTest, TestFirstScanFlag)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    EXPECT_TRUE(scanContext->isFirstScan());

    scanContext->setFirstScan(false);
    EXPECT_FALSE(scanContext->isFirstScan());

    scanContext->setFirstScan(true);
    EXPECT_TRUE(scanContext->isFirstScan());
}

TEST_F(ScanContextTest, TestNoIndexFlag)
{
    Context ctx = createBaseContext();
    auto scanContext = std::make_shared<scanContext_t>(ctx);

    EXPECT_FALSE(scanContext->isNoIndex());

    scanContext->setNoIndex(true);
    EXPECT_TRUE(scanContext->isNoIndex());

    scanContext->setNoIndex(false);
    EXPECT_FALSE(scanContext->isNoIndex());
}

TEST_F(ScanContextTest, TestBuildCPEWindows10)
{
    const std::string osCpeRules {
        R"#({"Microsoft Windows 10": "microsoft:windows_10_$(DISPLAY_VERSION):$(VERSION):::::"})#"};

    const nlohmann::json osCpeMap = nlohmann::json::parse(osCpeRules);

    spGlobalDataMock = std::make_shared<MockGlobalData>();
    EXPECT_CALL(*spGlobalDataMock, osCpeMaps()).WillOnce(testing::ReturnRef(osCpeMap));

    Context ctx = createBaseContext();
    ctx.indices = {"wazuh-states-inventory-system"};
    ctx.osname = "Microsoft Windows 10 Pro";
    ctx.osplatform = "windows";
    ctx.osversion = "10.0.19045.3930";

    std::shared_ptr<TScanContext<TrampolineOsDataCache, TrampolineGlobalData>> scanContext;
    EXPECT_NO_THROW((scanContext = std::make_shared<TScanContext<TrampolineOsDataCache, TrampolineGlobalData>>(ctx)));

    EXPECT_STREQ(scanContext->osName().data(), "Microsoft Windows 10 Pro");
    EXPECT_STREQ(scanContext->osPlatform().data(), "windows");
    EXPECT_STREQ(scanContext->osVersion().data(), "10.0.19045.3930");
}

TEST_F(ScanContextTest, TestBuildCPECentOS)
{
    const std::string osCpeRules {R"#({"CentOS Linux": "centos:centos:$(MAJOR_VERSION)"})#"};
    const nlohmann::json osCpeMap = nlohmann::json::parse(osCpeRules);

    spGlobalDataMock = std::make_shared<MockGlobalData>();
    EXPECT_CALL(*spGlobalDataMock, osCpeMaps()).WillOnce(testing::ReturnRef(osCpeMap));

    Context ctx = createBaseContext();
    ctx.indices = {"wazuh-states-inventory-system"};
    ctx.osname = "CentOS Linux";
    ctx.osplatform = "centos";
    ctx.osversion = "7.9";

    std::shared_ptr<TScanContext<TrampolineOsDataCache, TrampolineGlobalData>> scanContext;
    EXPECT_NO_THROW((scanContext = std::make_shared<TScanContext<TrampolineOsDataCache, TrampolineGlobalData>>(ctx)));

    EXPECT_STREQ(scanContext->osName().data(), "CentOS Linux");
}

TEST_F(ScanContextTest, TestBuildCPERedHat)
{
    const std::string osCpeRules {R"#({"Red Hat Enterprise Linux": "redhat:enterprise_linux:$(MAJOR_VERSION)"})#"};
    const nlohmann::json osCpeMap = nlohmann::json::parse(osCpeRules);

    spGlobalDataMock = std::make_shared<MockGlobalData>();
    EXPECT_CALL(*spGlobalDataMock, osCpeMaps()).WillOnce(testing::ReturnRef(osCpeMap));

    Context ctx = createBaseContext();
    ctx.indices = {"wazuh-states-inventory-system"};
    ctx.osname = "Red Hat Enterprise Linux";
    ctx.osplatform = "rhel";
    ctx.osversion = "8.5";

    std::shared_ptr<TScanContext<TrampolineOsDataCache, TrampolineGlobalData>> scanContext;
    EXPECT_NO_THROW((scanContext = std::make_shared<TScanContext<TrampolineOsDataCache, TrampolineGlobalData>>(ctx)));

    EXPECT_STREQ(scanContext->osName().data(), "Red Hat Enterprise Linux");
}

TEST_F(ScanContextTest, TestBuildCPEUbuntu)
{
    const std::string osCpeRules {R"#({"Ubuntu": "canonical:ubuntu_linux:$(VERSION)"})#"};
    const nlohmann::json osCpeMap = nlohmann::json::parse(osCpeRules);

    spGlobalDataMock = std::make_shared<MockGlobalData>();
    EXPECT_CALL(*spGlobalDataMock, osCpeMaps()).WillOnce(testing::ReturnRef(osCpeMap));

    Context ctx = createBaseContext();
    ctx.indices = {"wazuh-states-inventory-system"};
    ctx.osname = "Ubuntu";
    ctx.osplatform = "ubuntu";
    ctx.osversion = "20.04";

    std::shared_ptr<TScanContext<TrampolineOsDataCache, TrampolineGlobalData>> scanContext;
    EXPECT_NO_THROW((scanContext = std::make_shared<TScanContext<TrampolineOsDataCache, TrampolineGlobalData>>(ctx)));

    EXPECT_STREQ(scanContext->osName().data(), "Ubuntu");
}
