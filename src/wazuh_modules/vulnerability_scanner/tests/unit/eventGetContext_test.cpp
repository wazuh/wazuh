/*
 * Wazuh Vulnerability Scanner - Unit Tests
 * Copyright (C) 2015, Wazuh Inc.
 * December 23, 2025.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#include "eventGetContext_test.hpp"
#include "MockIndexerConnector.hpp"
#include "factory/eventGetContext.hpp"
#include "json.hpp"
#include "scanContext.hpp"
#include "gmock/gmock.h"
#include "gtest/gtest.h"

using ::testing::_;
using ::testing::DoAll;
using ::testing::Invoke;
using ::testing::Return;
using ::testing::SetArgReferee;

void EventGetContextTest::SetUp() {}

void EventGetContextTest::TearDown() {}

TEST_F(EventGetContextTest, TestEmptyIndexerResponse)
{
    // Create scan context
    Context ctx;
    ctx.agentId = "001";
    ctx.agentName = "test-agent";
    ctx.agentVersion = "4.5.0";
    ctx.osname = "Ubuntu";
    ctx.osplatform = "ubuntu";

    auto scanContext = std::make_shared<ScanContext>(ctx);

    // Mock indexer connector
    auto mockIndexer = std::make_shared<MockIndexerConnector>();

    // Expect pagination call with empty response
    EXPECT_CALL(*mockIndexer, executeSearchQueryWithPagination(_, _, _))
        .WillOnce(Invoke(
            [](const std::string& index,
               const nlohmann::json& query,
               std::function<void(const nlohmann::json&)> callback)
            {
                // Empty response - no vulnerabilities
                nlohmann::json response = {{"hits", {{"hits", nlohmann::json::array()}}}};
                callback(response);
            }));

    // Create EventGetContext and execute
    TEventGetContext<MockIndexerConnector, ScanContext> eventGetContext(mockIndexer);
    auto result = eventGetContext.handleRequest(scanContext);

    // Verify no CVEs were added
    ASSERT_NE(result, nullptr);
    EXPECT_EQ(result->cveCount(), 0);
}

TEST_F(EventGetContextTest, TestSinglePackageVulnerability)
{
    Context ctx;
    ctx.agentId = "002";
    ctx.agentName = "test-agent-2";
    ctx.agentVersion = "4.5.0";

    auto scanContext = std::make_shared<ScanContext>(ctx);

    PackageContextData pkg;
    pkg.name = "openssl";
    pkg.version = "1.1.1f";
    pkg.format = "deb";
    pkg.architecture = "amd64";

    scanContext->addPackageToContext("002_openssl_1.1.1f", pkg, ElementOperation::Upsert);

    auto mockIndexer = std::make_shared<MockIndexerConnector>();

    EXPECT_CALL(*mockIndexer, executeSearchQueryWithPagination(_, _, _))
        .WillOnce(Invoke(
            [](const std::string& index,
               const nlohmann::json& query,
               std::function<void(const nlohmann::json&)> callback)
            {
                nlohmann::json response = {
                    {"hits",
                     {{"hits",
                       nlohmann::json::array(
                           {{{"_id", "002_openssl_1.1.1f_CVE-2024-0001"},
                             {"_source",
                              {{"vulnerability", {{"id", "CVE-2024-0001"}}},
                               {"package", {{"name", "openssl"}, {"version", "1.1.1f"}, {"type", "deb"}}}}}}})}}}};
                callback(response);
            }));

    TEventGetContext<MockIndexerConnector, ScanContext> eventGetContext(mockIndexer);
    auto result = eventGetContext.handleRequest(scanContext);

    ASSERT_NE(result, nullptr);
    EXPECT_EQ(result->cveCount(), 1);

    // Verify the CVE was added as DELETE operation
    auto detectedCVEs = result->detectedCVEs();
    auto it = detectedCVEs.find("002_openssl_1.1.1f_CVE-2024-0001");
    ASSERT_NE(it, detectedCVEs.end());
    EXPECT_EQ(it->second.cveId, "CVE-2024-0001");
    EXPECT_EQ(it->second.operation, ElementOperation::Delete);
    EXPECT_EQ(it->second.componentType, AffectedComponentType::Package);
}

TEST_F(EventGetContextTest, TestMultipleVulnerabilities)
{
    Context ctx;
    ctx.agentId = "003";
    ctx.agentName = "test-agent-3";
    ctx.agentVersion = "4.5.0";

    auto scanContext = std::make_shared<ScanContext>(ctx);

    // Add package context
    PackageContextData pkg1;
    pkg1.name = "nginx";
    pkg1.version = "1.18.0";
    pkg1.format = "deb";
    scanContext->addPackageToContext("003_nginx_1.18.0", pkg1, ElementOperation::Upsert);

    PackageContextData pkg2;
    pkg2.name = "curl";
    pkg2.version = "7.68.0";
    pkg2.format = "deb";
    scanContext->addPackageToContext("003_curl_7.68.0", pkg2, ElementOperation::Upsert);

    auto mockIndexer = std::make_shared<MockIndexerConnector>();

    EXPECT_CALL(*mockIndexer, executeSearchQuery(_, _))
        .WillRepeatedly(testing::Return(nlohmann::json {{"hits", {{"hits", nlohmann::json::array()}}}}));

    EXPECT_CALL(*mockIndexer, executeSearchQueryWithPagination(_, _, _))
        .WillOnce(Invoke(
            [](const std::string& index,
               const nlohmann::json& query,
               std::function<void(const nlohmann::json&)> callback)
            {
                nlohmann::json response = {
                    {"hits",
                     {{"hits",
                       nlohmann::json::array({{{"_id", "003_nginx_1.18.0_CVE-2024-0001"},
                                               {"_source",
                                                {{"vulnerability", {{"id", "CVE-2024-0001"}}},
                                                 {"package", {{"name", "nginx"}, {"version", "1.18.0"}}}}}},
                                              {{"_id", "003_curl_7.68.0_CVE-2024-0002"},
                                               {"_source",
                                                {{"vulnerability", {{"id", "CVE-2024-0002"}}},
                                                 {"package", {{"name", "curl"}, {"version", "7.68.0"}}}}}},
                                              {{"_id", "003_ubuntu_CVE-2024-0003"},
                                               {"_source", {{"vulnerability", {{"id", "CVE-2024-0003"}}}}}}})}}}};
                callback(response);
            }));

    TEventGetContext<MockIndexerConnector, ScanContext> eventGetContext(mockIndexer);
    auto result = eventGetContext.handleRequest(scanContext);

    ASSERT_NE(result, nullptr);
    EXPECT_EQ(result->cveCount(), 3);

    // Verify all three CVEs
    auto detectedCVEs = result->detectedCVEs();

    auto it1 = detectedCVEs.find("003_nginx_1.18.0_CVE-2024-0001");
    ASSERT_NE(it1, detectedCVEs.end());
    EXPECT_EQ(it1->second.componentType, AffectedComponentType::Package);

    auto it2 = detectedCVEs.find("003_curl_7.68.0_CVE-2024-0002");
    ASSERT_NE(it2, detectedCVEs.end());
    EXPECT_EQ(it2->second.componentType, AffectedComponentType::Package);

    auto it3 = detectedCVEs.find("003_ubuntu_CVE-2024-0003");
    ASSERT_NE(it3, detectedCVEs.end());
    EXPECT_EQ(it3->second.componentType, AffectedComponentType::Os);
}

TEST_F(EventGetContextTest, TestPaginationMultiplePages)
{
    Context ctx;
    ctx.agentId = "004";
    ctx.agentName = "test-agent-4";
    ctx.agentVersion = "4.5.0";

    auto scanContext = std::make_shared<ScanContext>(ctx);

    auto mockIndexer = std::make_shared<MockIndexerConnector>();

    // Mock executeSearchQuery for package fetch
    EXPECT_CALL(*mockIndexer, executeSearchQuery(_, _))
        .WillRepeatedly(testing::Return(nlohmann::json {{"hits", {{"hits", nlohmann::json::array()}}}}));

    int callCount = 0;
    EXPECT_CALL(*mockIndexer, executeSearchQueryWithPagination(_, _, _))
        .WillOnce(Invoke(
            [&callCount](const std::string& index,
                         const nlohmann::json& query,
                         std::function<void(const nlohmann::json&)> callback)
            {
                // First page
                nlohmann::json response1 = {
                    {"hits",
                     {{"hits",
                       nlohmann::json::array({{{"_id", "004_pkg1_CVE-2024-0001"},
                                               {"_source", {{"vulnerability", {{"id", "CVE-2024-0001"}}}}}},
                                              {{"_id", "004_pkg2_CVE-2024-0002"},
                                               {"_source", {{"vulnerability", {{"id", "CVE-2024-0002"}}}}}}})}}}};
                callback(response1);
                ++callCount;

                // Second page
                nlohmann::json response2 = {
                    {"hits",
                     {{"hits",
                       nlohmann::json::array({{{"_id", "004_pkg3_CVE-2024-0003"},
                                               {"_source", {{"vulnerability", {{"id", "CVE-2024-0003"}}}}}}})}}}};
                callback(response2);
                ++callCount;
            }));

    TEventGetContext<MockIndexerConnector, ScanContext> eventGetContext(mockIndexer);
    auto result = eventGetContext.handleRequest(scanContext);

    ASSERT_NE(result, nullptr);
    EXPECT_EQ(result->cveCount(), 3);
    EXPECT_EQ(callCount, 2); // Two page callbacks
}

TEST_F(EventGetContextTest, TestMissingDetectionId)
{
    Context ctx;
    ctx.agentId = "005";
    ctx.agentName = "test-agent-5";
    ctx.agentVersion = "4.5.0";

    auto scanContext = std::make_shared<ScanContext>(ctx);
    auto mockIndexer = std::make_shared<MockIndexerConnector>();

    EXPECT_CALL(*mockIndexer, executeSearchQueryWithPagination(_, _, _))
        .WillOnce(Invoke(
            [](const std::string& index,
               const nlohmann::json& query,
               std::function<void(const nlohmann::json&)> callback)
            {
                nlohmann::json response = {
                    {"hits",
                     {{"hits",
                       nlohmann::json::array({{// Missing _id field
                                               {"_source", {{"vulnerability", {{"id", "CVE-2024-0001"}}}}}}})}}}};
                callback(response);
            }));

    TEventGetContext<MockIndexerConnector, ScanContext> eventGetContext(mockIndexer);
    auto result = eventGetContext.handleRequest(scanContext);

    ASSERT_NE(result, nullptr);
    EXPECT_EQ(result->cveCount(), 0);
}

TEST_F(EventGetContextTest, TestMissingCveId)
{
    Context ctx;
    ctx.agentId = "006";
    ctx.agentName = "test-agent-6";
    ctx.agentVersion = "4.5.0";

    auto scanContext = std::make_shared<ScanContext>(ctx);
    auto mockIndexer = std::make_shared<MockIndexerConnector>();

    EXPECT_CALL(*mockIndexer, executeSearchQueryWithPagination(_, _, _))
        .WillOnce(Invoke(
            [](const std::string& index,
               const nlohmann::json& query,
               std::function<void(const nlohmann::json&)> callback)
            {
                nlohmann::json response = {{"hits",
                                            {{"hits",
                                              nlohmann::json::array({{{"_id", "006_pkg_CVE-2024-0001"},
                                                                      {"_source",
                                                                       {// Missing vulnerability.id field
                                                                        {"package", {{"name", "test-pkg"}}}}}}})}}}};
                callback(response);
            }));

    TEventGetContext<MockIndexerConnector, ScanContext> eventGetContext(mockIndexer);
    auto result = eventGetContext.handleRequest(scanContext);

    ASSERT_NE(result, nullptr);
    EXPECT_EQ(result->cveCount(), 0);
}

TEST_F(EventGetContextTest, TestMalformedResponseMissingHits)
{
    Context ctx;
    ctx.agentId = "007";
    ctx.agentName = "test-agent-7";
    ctx.agentVersion = "4.5.0";

    auto scanContext = std::make_shared<ScanContext>(ctx);
    auto mockIndexer = std::make_shared<MockIndexerConnector>();

    EXPECT_CALL(*mockIndexer, executeSearchQueryWithPagination(_, _, _))
        .WillOnce(Invoke(
            [](const std::string& index,
               const nlohmann::json& query,
               std::function<void(const nlohmann::json&)> callback)
            {
                // Malformed response
                nlohmann::json response = {{"some_other_field", "value"}};
                callback(response);
            }));

    TEventGetContext<MockIndexerConnector, ScanContext> eventGetContext(mockIndexer);
    auto result = eventGetContext.handleRequest(scanContext);

    ASSERT_NE(result, nullptr);
    EXPECT_EQ(result->cveCount(), 0);
}

TEST_F(EventGetContextTest, TestExceptionDuringQuery)
{
    Context ctx;
    ctx.agentId = "008";
    ctx.agentName = "test-agent-8";
    ctx.agentVersion = "4.5.0";

    auto scanContext = std::make_shared<ScanContext>(ctx);
    auto mockIndexer = std::make_shared<MockIndexerConnector>();

    EXPECT_CALL(*mockIndexer, executeSearchQueryWithPagination(_, _, _))
        .WillOnce(Invoke([](const std::string& index,
                            const nlohmann::json& query,
                            std::function<void(const nlohmann::json&)> callback)
                         { throw std::runtime_error("Indexer connection failed"); }));

    TEventGetContext<MockIndexerConnector, ScanContext> eventGetContext(mockIndexer);

    // Should not throw - exception should be caught
    EXPECT_NO_THROW({
        auto result = eventGetContext.handleRequest(scanContext);
        ASSERT_NE(result, nullptr);
        EXPECT_EQ(result->cveCount(), 0);
    });
}

TEST_F(EventGetContextTest, TestOSUpdateQueryExecuted)
{
    Context ctx;
    ctx.agentId = "010";
    ctx.agentName = "test-agent-10";
    ctx.agentVersion = "4.5.0";
    ctx.osname = "Ubuntu";
    ctx.osplatform = "ubuntu";
    ctx.osversion = "20.04";

    auto scanContext = std::make_shared<ScanContext>(ctx);

    OsContextData deletedOS;
    deletedOS.item_id = "some-item-id";
    deletedOS.name = "Ubuntu";
    deletedOS.version = "18.04";
    deletedOS.platform = "ubuntu";
    scanContext->setDeletedOSData(deletedOS);

    auto mockIndexer = std::make_shared<MockIndexerConnector>();

    // Expect OS update query
    bool updateQueryCalled = false;
    EXPECT_CALL(*mockIndexer, executeUpdateByQuery(_, _))
        .WillOnce(Invoke(
            [&updateQueryCalled](const std::vector<std::string>& indices, const nlohmann::json& query)
            {
                updateQueryCalled = true;
                EXPECT_EQ(indices.size(), 1);
                EXPECT_EQ(indices[0], "wazuh-states-vulnerabilities");
            }));

    // Also expect pagination query
    EXPECT_CALL(*mockIndexer, executeSearchQueryWithPagination(_, _, _))
        .WillOnce(Invoke(
            [](const std::string& index,
               const nlohmann::json& query,
               std::function<void(const nlohmann::json&)> callback)
            {
                nlohmann::json response = {{"hits", {{"hits", nlohmann::json::array()}}}};
                callback(response);
            }));

    TEventGetContext<MockIndexerConnector, ScanContext> eventGetContext(mockIndexer);
    auto result = eventGetContext.handleRequest(scanContext);

    ASSERT_NE(result, nullptr);
    EXPECT_TRUE(updateQueryCalled);
}

TEST_F(EventGetContextTest, TestPackageWithAllOptionalFields)
{
    Context ctx;
    ctx.agentId = "011";
    ctx.agentName = "test-agent-11";
    ctx.agentVersion = "4.5.0";

    auto scanContext = std::make_shared<ScanContext>(ctx);

    auto mockIndexer = std::make_shared<MockIndexerConnector>();

    EXPECT_CALL(*mockIndexer, executeSearchQueryWithPagination(_, _, _))
        .WillOnce(Invoke(
            [](const std::string& index,
               const nlohmann::json& query,
               std::function<void(const nlohmann::json&)> callback)
            {
                nlohmann::json response = {{"hits",
                                            {{"hits",
                                              nlohmann::json::array({{{"_id", "011_fullpkg_1.0.0_CVE-2024-0001"},
                                                                      {"_source",
                                                                       {{"vulnerability", {{"id", "CVE-2024-0001"}}},
                                                                        {"package",
                                                                         {{"name", "fullpkg"},
                                                                          {"version", "1.0.0"},
                                                                          {"type", "deb"},
                                                                          {"source", "debian"},
                                                                          {"path", "/usr/lib/fullpkg"},
                                                                          {"architecture", "amd64"},
                                                                          {"multiarch", "same"},
                                                                          {"priority", "optional"},
                                                                          {"vendor", "Debian"},
                                                                          {"install_scope", "libs"},
                                                                          {"description", "Full package description"},
                                                                          {"license", "GPL-3.0"},
                                                                          {"size", 2048000}}}}}}})}}}};
                callback(response);
            }));

    EXPECT_CALL(*mockIndexer, executeSearchQuery(_, _))
        .WillOnce(Invoke(
            [](const std::string& index, const nlohmann::json& query) -> nlohmann::json
            {
                return {{"hits",
                         {{"hits",
                           nlohmann::json::array({{{"_id", "011_fullpkg_1.0.0_CVE-2024-0001"},
                                                   {"_source",
                                                    {{"package",
                                                      {{"name", "fullpkg"},
                                                       {"version", "1.0.0"},
                                                       {"type", "deb"},
                                                       {"architecture", "amd64"},
                                                       {"size", 2048000}}}}}}})}}}};
            }));

    TEventGetContext<MockIndexerConnector, ScanContext> eventGetContext(mockIndexer);
    auto result = eventGetContext.handleRequest(scanContext);

    ASSERT_NE(result, nullptr);
    EXPECT_EQ(result->cveCount(), 1);

    auto pkg = result->findPackageByDetectionBase("011_fullpkg_1.0.0");
    ASSERT_NE(pkg, nullptr);
    EXPECT_EQ(pkg->name, "fullpkg");
    EXPECT_EQ(pkg->version, "1.0.0");
    EXPECT_EQ(pkg->format, "deb");
    EXPECT_EQ(pkg->architecture, "amd64");
    EXPECT_EQ(pkg->size, 2048000);
    EXPECT_EQ(pkg->operation, ElementOperation::Delete);
}

TEST_F(EventGetContextTest, TestChainOfResponsibility)
{
    Context ctx;
    ctx.agentId = "012";
    ctx.agentName = "test-agent-12";
    ctx.agentVersion = "4.5.0";

    auto scanContext = std::make_shared<ScanContext>(ctx);

    auto mockIndexer = std::make_shared<MockIndexerConnector>();

    EXPECT_CALL(*mockIndexer, executeSearchQueryWithPagination(_, _, _))
        .WillOnce(Invoke(
            [](const std::string& index,
               const nlohmann::json& query,
               std::function<void(const nlohmann::json&)> callback)
            {
                nlohmann::json response = {{"hits", {{"hits", nlohmann::json::array()}}}};
                callback(response);
            }));

    TEventGetContext<MockIndexerConnector, ScanContext> eventGetContext(mockIndexer);

    auto result = eventGetContext.handleRequest(scanContext);
    ASSERT_NE(result, nullptr);
    EXPECT_EQ(result->agentId(), scanContext->agentId());
}

TEST_F(EventGetContextTest, TestLargeResultSet)
{
    Context ctx;
    ctx.agentId = "013";
    ctx.agentName = "test-agent-13";
    ctx.agentVersion = "4.5.0";

    auto scanContext = std::make_shared<ScanContext>(ctx);

    auto mockIndexer = std::make_shared<MockIndexerConnector>();

    EXPECT_CALL(*mockIndexer, executeSearchQuery(_, _))
        .WillRepeatedly(testing::Return(nlohmann::json {{"hits", {{"hits", nlohmann::json::array()}}}}));

    EXPECT_CALL(*mockIndexer, executeSearchQueryWithPagination(_, _, _))
        .WillOnce(Invoke(
            [](const std::string& index,
               const nlohmann::json& query,
               std::function<void(const nlohmann::json&)> callback)
            {
                nlohmann::json::array_t hits;
                for (int i = 0; i < 100; ++i)
                {
                    std::string detectionId = "013_pkg" + std::to_string(i) + "_CVE-2024-" +
                                              std::string(4 - std::to_string(i).length(), '0') + std::to_string(i);
                    std::string cveId =
                        "CVE-2024-" + std::string(4 - std::to_string(i).length(), '0') + std::to_string(i);

                    hits.push_back({{"_id", detectionId}, {"_source", {{"vulnerability", {{"id", cveId}}}}}});
                }

                nlohmann::json response = {{"hits", {{"hits", hits}}}};
                callback(response);
            }));

    TEventGetContext<MockIndexerConnector, ScanContext> eventGetContext(mockIndexer);
    auto result = eventGetContext.handleRequest(scanContext);

    ASSERT_NE(result, nullptr);
    EXPECT_EQ(result->cveCount(), 100);
}

TEST_F(EventGetContextTest, TestMultipleCVEsSamePackageOneFetch)
{
    Context ctx;
    ctx.agentId = "014";
    ctx.agentName = "test-agent-14";
    ctx.agentVersion = "4.5.0";

    auto scanContext = std::make_shared<ScanContext>(ctx);

    auto mockIndexer = std::make_shared<MockIndexerConnector>();

    // Pagination query returns 3 CVEs for same package base
    EXPECT_CALL(*mockIndexer, executeSearchQueryWithPagination(_, _, _))
        .WillOnce(Invoke(
            [](const std::string& index,
               const nlohmann::json& query,
               std::function<void(const nlohmann::json&)> callback)
            {
                nlohmann::json response = {
                    {"hits",
                     {{"hits",
                       nlohmann::json::array({{{"_id", "014_curl_7.68.0_CVE-2024-0001"},
                                               {"_source",
                                                {{"vulnerability", {{"id", "CVE-2024-0001"}}},
                                                 {"package", {{"name", "curl"}, {"version", "7.68.0"}}}}}},
                                              {{"_id", "014_curl_7.68.0_CVE-2024-0002"},
                                               {"_source",
                                                {{"vulnerability", {{"id", "CVE-2024-0002"}}},
                                                 {"package", {{"name", "curl"}, {"version", "7.68.0"}}}}}},
                                              {{"_id", "014_curl_7.68.0_CVE-2024-0003"},
                                               {"_source",
                                                {{"vulnerability", {{"id", "CVE-2024-0003"}}},
                                                 {"package", {{"name", "curl"}, {"version", "7.68.0"}}}}}}})}}}};
                callback(response);
            }));

    // executeSearchQuery should be called once
    int fetchCallCount = 0;
    EXPECT_CALL(*mockIndexer, executeSearchQuery(_, _))
        .WillOnce(Invoke(
            [&fetchCallCount](const std::string& index, const nlohmann::json& query) -> nlohmann::json
            {
                ++fetchCallCount;
                return {{"hits",
                         {{"hits",
                           nlohmann::json::array(
                               {{{"_id", "014_curl_7.68.0_CVE-2024-0001"},
                                 {"_source",
                                  {{"package", {{"name", "curl"}, {"version", "7.68.0"}, {"type", "deb"}}}}}}})}}}};
            }));

    TEventGetContext<MockIndexerConnector, ScanContext> eventGetContext(mockIndexer);
    auto result = eventGetContext.handleRequest(scanContext);

    ASSERT_NE(result, nullptr);
    EXPECT_EQ(result->cveCount(), 3);
    EXPECT_EQ(fetchCallCount, 1); // Only ONE fetch despite 3 CVEs

    // All should be Package type
    auto detectedCVEs = result->detectedCVEs();
    EXPECT_EQ(detectedCVEs.find("014_curl_7.68.0_CVE-2024-0001")->second.componentType, AffectedComponentType::Package);
    EXPECT_EQ(detectedCVEs.find("014_curl_7.68.0_CVE-2024-0002")->second.componentType, AffectedComponentType::Package);
    EXPECT_EQ(detectedCVEs.find("014_curl_7.68.0_CVE-2024-0003")->second.componentType, AffectedComponentType::Package);
}

TEST_F(EventGetContextTest, TestOSUpdateWithAgentHostOsType)
{
    Context ctx;
    ctx.agentId = "015";
    ctx.agentName = "test-agent-15";
    ctx.agentVersion = "4.5.0";
    ctx.osname = "Ubuntu";
    ctx.osplatform = "ubuntu";
    ctx.osversion = "22.04";
    ctx.ostype = "linux";

    auto scanContext = std::make_shared<ScanContext>(ctx);

    // Set deleted OS data
    OsContextData deletedOS;
    deletedOS.item_id = "deleted-os-id";
    deletedOS.name = "Ubuntu";
    deletedOS.platform = "ubuntu";
    scanContext->setDeletedOSData(deletedOS);

    auto mockIndexer = std::make_shared<MockIndexerConnector>();

    nlohmann::json capturedQuery;
    EXPECT_CALL(*mockIndexer, executeUpdateByQuery(_, _))
        .WillOnce(Invoke([&capturedQuery](const std::vector<std::string>& indices, const nlohmann::json& query)
                         { capturedQuery = query; }));

    EXPECT_CALL(*mockIndexer, executeSearchQueryWithPagination(_, _, _))
        .WillOnce(Invoke(
            [](const std::string& index,
               const nlohmann::json& query,
               std::function<void(const nlohmann::json&)> callback)
            {
                nlohmann::json response = {{"hits", {{"hits", nlohmann::json::array()}}}};
                callback(response);
            }));

    TEventGetContext<MockIndexerConnector, ScanContext> eventGetContext(mockIndexer);
    auto result = eventGetContext.handleRequest(scanContext);

    ASSERT_NE(result, nullptr);
    EXPECT_FALSE(capturedQuery.empty());
}

TEST_F(EventGetContextTest, TestOSUpdateWithKernelSysName)
{
    Context ctx;
    ctx.agentId = "016";
    ctx.agentName = "test-agent-16";
    ctx.agentVersion = "4.5.0";
    ctx.osname = "Ubuntu";
    ctx.osplatform = "ubuntu";
    ctx.osversion = "20.04";
    ctx.ostype = "Linux";

    auto scanContext = std::make_shared<ScanContext>(ctx);

    // Set deleted OS data
    OsContextData deletedOS;
    deletedOS.item_id = "deleted-os-id-2";
    deletedOS.name = "Ubuntu";
    deletedOS.platform = "ubuntu";
    scanContext->setDeletedOSData(deletedOS);

    auto mockIndexer = std::make_shared<MockIndexerConnector>();

    bool updateCalled = false;
    EXPECT_CALL(*mockIndexer, executeUpdateByQuery(_, _))
        .WillOnce(Invoke([&updateCalled](const std::vector<std::string>& indices, const nlohmann::json& query)
                         { updateCalled = true; }));

    EXPECT_CALL(*mockIndexer, executeSearchQueryWithPagination(_, _, _))
        .WillOnce(Invoke(
            [](const std::string& index,
               const nlohmann::json& query,
               std::function<void(const nlohmann::json&)> callback)
            {
                nlohmann::json response = {{"hits", {{"hits", nlohmann::json::array()}}}};
                callback(response);
            }));

    TEventGetContext<MockIndexerConnector, ScanContext> eventGetContext(mockIndexer);
    auto result = eventGetContext.handleRequest(scanContext);

    ASSERT_NE(result, nullptr);
    EXPECT_TRUE(updateCalled);
}

TEST_F(EventGetContextTest, TestOSUpdateDarwinToMacOS)
{
    Context ctx;
    ctx.agentId = "017";
    ctx.agentName = "test-agent-17";
    ctx.agentVersion = "4.5.0";
    ctx.osname = "macOS";
    ctx.osplatform = "darwin";
    ctx.osversion = "13.0";

    auto scanContext = std::make_shared<ScanContext>(ctx);

    // Set deleted OS data
    OsContextData deletedOS;
    deletedOS.item_id = "deleted-os-id-3";
    deletedOS.name = "macOS";
    deletedOS.platform = "darwin";
    scanContext->setDeletedOSData(deletedOS);

    auto mockIndexer = std::make_shared<MockIndexerConnector>();

    bool updateCalled = false;
    EXPECT_CALL(*mockIndexer, executeUpdateByQuery(_, _))
        .WillOnce(Invoke(
            [&updateCalled](const std::vector<std::string>& indices, const nlohmann::json& query)
            {
                updateCalled = true;
                // osType should be "macos" (converted from darwin)
            }));

    EXPECT_CALL(*mockIndexer, executeSearchQueryWithPagination(_, _, _))
        .WillOnce(Invoke(
            [](const std::string& index,
               const nlohmann::json& query,
               std::function<void(const nlohmann::json&)> callback)
            {
                nlohmann::json response = {{"hits", {{"hits", nlohmann::json::array()}}}};
                callback(response);
            }));

    TEventGetContext<MockIndexerConnector, ScanContext> eventGetContext(mockIndexer);
    auto result = eventGetContext.handleRequest(scanContext);

    ASSERT_NE(result, nullptr);
    EXPECT_TRUE(updateCalled);
}

TEST_F(EventGetContextTest, TestPackageAlreadyInContextNotDuplicated)
{
    Context ctx;
    ctx.agentId = "018";
    ctx.agentName = "test-agent-18";
    ctx.agentVersion = "4.5.0";

    auto scanContext = std::make_shared<ScanContext>(ctx);

    PackageContextData existingPkg;
    existingPkg.name = "nginx";
    existingPkg.version = "1.20.0";
    existingPkg.format = "deb";
    scanContext->addPackageToContext("018_nginx_1.20.0", existingPkg, ElementOperation::Upsert);

    auto mockIndexer = std::make_shared<MockIndexerConnector>();

    EXPECT_CALL(*mockIndexer, executeSearchQueryWithPagination(_, _, _))
        .WillOnce(Invoke(
            [](const std::string& index,
               const nlohmann::json& query,
               std::function<void(const nlohmann::json&)> callback)
            {
                nlohmann::json response = {
                    {"hits",
                     {{"hits",
                       nlohmann::json::array(
                           {{{"_id", "018_nginx_1.20.0_CVE-2024-0001"},
                             {"_source",
                              {{"vulnerability", {{"id", "CVE-2024-0001"}}},
                               {"package", {{"name", "nginx"}, {"version", "1.20.0"}, {"type", "deb"}}}}}}})}}}};
                callback(response);
            }));

    // executeSearchQuery should NOT be called (package already in context)
    EXPECT_CALL(*mockIndexer, executeSearchQuery(_, _)).Times(0);

    TEventGetContext<MockIndexerConnector, ScanContext> eventGetContext(mockIndexer);
    auto result = eventGetContext.handleRequest(scanContext);

    ASSERT_NE(result, nullptr);
    EXPECT_EQ(result->cveCount(), 1);

    // Verify CVE was added as Package type
    auto detectedCVEs = result->detectedCVEs();
    auto it = detectedCVEs.find("018_nginx_1.20.0_CVE-2024-0001");
    ASSERT_NE(it, detectedCVEs.end());
    EXPECT_EQ(it->second.componentType, AffectedComponentType::Package);
}

TEST_F(EventGetContextTest, TestNoOSUpdateWhenOsNameEmpty)
{
    Context ctx;
    ctx.agentId = "019";
    ctx.agentName = "test-agent-19";
    ctx.agentVersion = "4.5.0";
    // osname intentionally empty

    auto scanContext = std::make_shared<ScanContext>(ctx);

    OsContextData deletedOS;
    deletedOS.item_id = "deleted-os-id-4";
    deletedOS.name = ""; // Empty name
    scanContext->setDeletedOSData(deletedOS);

    auto mockIndexer = std::make_shared<MockIndexerConnector>();

    // executeUpdateByQuery should NOT be called
    EXPECT_CALL(*mockIndexer, executeUpdateByQuery(_, _)).Times(0);

    EXPECT_CALL(*mockIndexer, executeSearchQueryWithPagination(_, _, _))
        .WillOnce(Invoke(
            [](const std::string& index,
               const nlohmann::json& query,
               std::function<void(const nlohmann::json&)> callback)
            {
                nlohmann::json response = {{"hits", {{"hits", nlohmann::json::array()}}}};
                callback(response);
            }));

    TEventGetContext<MockIndexerConnector, ScanContext> eventGetContext(mockIndexer);
    auto result = eventGetContext.handleRequest(scanContext);

    ASSERT_NE(result, nullptr);
}
