cmake_minimum_required(VERSION 3.12.4)

project(vulnerability_scanner)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

add_definitions(-DPROMISE_TYPE=PromiseType::NORMAL)

set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)

if(NOT DEFINED WAZUH_MAIN_PROJECT)
  get_filename_component(SRC_FOLDER ${CMAKE_SOURCE_DIR}/../../ ABSOLUTE)
endif()

if(NOT SHARED_MODULES)
  get_filename_component(SHARED_MODULES ${SRC_FOLDER}/shared_modules/ ABSOLUTE)
endif()

# If VERSION and REVISION are manually set, use them.

if(VERSION AND REVISION)
  add_definitions(-DVERSION="${VERSION}")
  add_definitions(-DREVISION="${REVISION}")
endif()

# Include directories
include_directories(include)
include_directories(src/databaseFeedManager)

include_directories(${SRC_FOLDER})
include_directories(${SRC_FOLDER}/headers)
include_directories(${SRC_FOLDER}/external/cJSON)
include_directories(${SRC_FOLDER}/external/nlohmann)
include_directories(${SRC_FOLDER}/external/simdjson/include)
include_directories(${SRC_FOLDER}/external/rocksdb/include)
include_directories(${SRC_FOLDER}/external/flatbuffers/include)
include_directories(${SRC_FOLDER}/external/libarchive/libarchive/)
include_directories(${SRC_FOLDER}/external/lzma/src/liblzma/api)
include_directories(${SRC_FOLDER}/wazuh_modules/)
include_directories(${SRC_FOLDER}/wazuh_modules/inventory_sync/include)
include_directories(${SRC_FOLDER}/wazuh_modules/inventory_sync/src)
include_directories(
  ${SRC_FOLDER}/wazuh_modules/vulnerability_scanner/src/scanOrchestrator/)

include_directories(${SHARED_MODULES}/common)
include_directories(${SHARED_MODULES}/utils)
include_directories(${SHARED_MODULES}/router/include)
include_directories(${SHARED_MODULES}/content_manager/include)
include_directories(${SHARED_MODULES}/indexer_connector/include)
include_directories(${SHARED_MODULES}/http-request/include)
include_directories(${SHARED_MODULES}/schema_validator/include)

# Ensure schema_validator target is available when building this module standalone or in tests.
if(NOT TARGET schema_validator)
  add_subdirectory(
    ${SHARED_MODULES}/schema_validator
    ${CMAKE_BINARY_DIR}/shared_modules/schema_validator
    EXCLUDE_FROM_ALL
  )
endif()

# Link directories
link_directories(${SRC_FOLDER}/external/rocksdb/build)
link_directories(${SHARED_MODULES}/router/build)
link_directories(${SHARED_MODULES}/content_manager/build)
link_directories(${SHARED_MODULES}/indexer_connector/build)
link_directories(${SHARED_MODULES}/http-request/build)
link_directories(${SRC_FOLDER}/external/flatbuffers/build/)
link_directories(${SHARED_MODULES}/schema_validator/build)

list(
  APPEND
  SchemasVD
  cve5
  vulnerabilityCandidate
  vulnerabilityDescription
  vulnerabilityRemediations
  packageTranslation)

# Verify flatc exists (should be built by src/Makefile)
set(FLATC_EXECUTABLE ${SRC_FOLDER}/external/flatbuffers/build/flatc)
if(NOT EXISTS ${FLATC_EXECUTABLE})
  message(FATAL_ERROR "flatc not found at ${FLATC_EXECUTABLE}.")
endif()
message(STATUS "Using flatc from: ${FLATC_EXECUTABLE}")

message("Compiling schemas")
add_custom_target(compile_schemas_vd)
foreach(schema IN LISTS SchemasVD)
  set(FILE "${CMAKE_CURRENT_SOURCE_DIR}/schemas/${schema}.fbs")
  set(VULNERABILITY_OUTPUT_HEADER_GENERATED
      "${CMAKE_CURRENT_BINARY_DIR}/include/${schema}_generated.h")
  set(VULNERABILITY_OUTPUT_HEADER
      "${CMAKE_CURRENT_BINARY_DIR}/include/${schema}_schema.h")

  # Create include directory in build
  file(MAKE_DIRECTORY "${CMAKE_CURRENT_BINARY_DIR}/include")

  add_custom_command(
    OUTPUT "${VULNERABILITY_OUTPUT_HEADER_GENERATED}"
    COMMAND ${FLATC_EXECUTABLE} --cpp -o
            "${CMAKE_CURRENT_BINARY_DIR}/include" "${FILE}" --no-warnings
    COMMENT "Building C++ header for ${schema} schema."
    DEPENDS ${FILE}
    VERBATIM)

  add_custom_command(
    OUTPUT "${VULNERABILITY_OUTPUT_HEADER}"
    COMMAND
      bash -c
      "echo -e '// This file was generated from ${FILE} , do not modify \\n#ifndef ${schema}_HEADER\\n#define ${schema}_HEADER\\nauto constexpr ${schema}_SCHEMA = R\"('`cat ${FILE}`')\" ;\\n#endif // ${schema}_HEADER\\n ' > ${VULNERABILITY_OUTPUT_HEADER}"
    COMMENT "Creating header from schema file: '${schema}'"
    DEPENDS ${VULNERABILITY_OUTPUT_HEADER_GENERATED}
    VERBATIM)

  add_custom_target(${schema}_schema_vd_target
                    DEPENDS ${VULNERABILITY_OUTPUT_HEADER})
  add_dependencies(compile_schemas_vd ${schema}_schema_vd_target)
endforeach()

add_subdirectory("src/scanOrchestrator")
add_subdirectory("src/databaseFeedManager")

file(GLOB VULNERABILITY_SCANNER_SRC "src/*.cpp")

add_library(vulnerability_scanner SHARED ${VULNERABILITY_SCANNER_SRC})

target_include_directories(
  vulnerability_scanner
  PUBLIC ${CMAKE_CURRENT_SOURCE_DIR}/src
         ${CMAKE_CURRENT_SOURCE_DIR}/include
         ${CMAKE_CURRENT_BINARY_DIR}/include
         ${CMAKE_CURRENT_SOURCE_DIR}/src/databaseFeedManager
         ${CMAKE_CURRENT_SOURCE_DIR}/src/scanOrchestrator)

target_compile_options(
  vulnerability_scanner
  PRIVATE -Wall
          -Wextra
          -Wshadow
          -Wnon-virtual-dtor
          -Woverloaded-virtual
          -Wunused
          -Wcast-align
          -Wformat=2)

if(TARGET compile_schemas_input)
  add_dependencies(database_feed compile_schemas_vd compile_schemas_input)
else()
  # If target isn't defined, only this project is being built and not the whole
  # Wazuh project. The schemas must be compiled manually before building this
  # project in that case.
  add_dependencies(database_feed compile_schemas_vd)
endif()

target_link_libraries(
  vulnerability_scanner PUBLIC
  scan_orchestrator
  database_feed
  content_manager
  indexer_connector
  router
  urlrequest
  schema_validator
  gcc_s
  flatbuffers)

set_target_properties(
  vulnerability_scanner PROPERTIES BUILD_RPATH_USE_ORIGIN TRUE BUILD_RPATH
                                                               "$ORIGIN/../lib")

if(UNIT_TEST)
  enable_testing()
  add_coverage_libraries(vulnerability_scanner)
  add_subdirectory(tests)
endif(UNIT_TEST)

add_subdirectory(testtool)
