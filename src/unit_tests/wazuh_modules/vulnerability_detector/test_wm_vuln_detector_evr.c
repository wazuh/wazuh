/*
 * Copyright (C) 2015-2020, Wazuh Inc.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#include <stdarg.h>
#include <stddef.h>
#include <setjmp.h>
#include <cmocka.h>
#include <stdio.h>

#include "../../wazuh_modules/wmodules.h"
#include "../../headers/shared.h"
#include "mocks_wm_vuln_detector.h"

#define REPORT_CVE_VULDET_POS 0
#define REPORT_CVE_REPORT_POS 1

int pkg_version_compare(const struct pkg_version *a, const struct pkg_version *b);
bool pkg_version_relate(const struct pkg_version *a, enum pkg_relation rel, const struct pkg_version *b, version_type vertype);

/* redefinitons/wrapping */



/* setup/teardown */

static int setup_versions(void **state) {
    struct pkg_version *version_a;
    struct pkg_version *version_b;

    os_calloc(1, sizeof(struct pkg_version), version_a);
    os_calloc(1, sizeof(struct pkg_version), version_b);

    if(!version_a || !version_b) {
        return -1;
    }

    state[0] = version_a;
    state[1] = version_b;

    return 0;
}

static int teardown_versions(void **state) {
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    if(version_a) {
        free(version_a);
    }

    if(version_b) {
        free(version_b);
    }

    return 0;
}

/* tests */

void test_pkg_version_relate_epoch_NONE(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 1;
    version_a->version = "";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_GT, version_b, VER_TYPE_NONE);
    assert_int_equal(ret, 1);
}

void test_pkg_version_relate_epoch_VER_TYPE_unknown(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 1;
    version_a->version = "";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "";
    version_b->revision = "";

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "unknown version_type 4");

    int ret = pkg_version_relate(version_a, PKG_RELATION_GT, version_b, 4);
    assert_int_equal(ret, 0);
}

void test_pkg_version_relate_epoch_RELATION_unknown(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 1;
    version_a->version = "";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "";
    version_b->revision = "";

    expect_string(__wrap__mterror, tag, "wazuh-modulesd:vulnerability-detector");
    expect_string(__wrap__mterror, formatted_msg, "unknown pkg_relation 6");

    int ret = pkg_version_relate(version_a, 6, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
}

void test_pkg_version_relate_epoch_GT(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 1;
    version_a->version = "";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_GT, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 1);
}

void test_pkg_version_relate_epoch_GE(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 1;
    version_a->version = "";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_GE, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 1);
}

void test_pkg_version_relate_epoch_EQ(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 1;
    version_a->version = "";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_EQ, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
}

void test_pkg_version_relate_epoch_LE(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 1;
    version_a->version = "";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_LE, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
}

void test_pkg_version_relate_epoch_LT(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 1;
    version_a->version = "";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_LT, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
}

void test_pkg_version_relate_epoch_negative_nvd(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = -1;
    version_a->version = "1";
    version_a->revision = "";
    version_b->epoch = -1;
    version_b->version = "2";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_EQ, version_b, VER_TYPE_NVD);
    assert_int_equal(ret, 0);
}

void test_pkg_version_relate_version_deb_GT(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "4.18.1";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_GT, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 1);
}

void test_pkg_version_relate_version_deb_GT_zero_ending(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "5.3";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_GT, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 1);
}

void test_pkg_version_relate_version_deb_GE(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "4.18.1";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_GE, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 1);
}

void test_pkg_version_relate_version_deb_EQ(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "4.18.1";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_EQ, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
}

void test_pkg_version_relate_version_deb_LE(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "4.18.1";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_LE, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
}

void test_pkg_version_relate_version_deb_LT(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "4.18.1";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_LT, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
}

void test_pkg_version_relate_version_rpm_GT(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "4.18.1";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_GT, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 1);
}

void test_pkg_version_relate_version_rpm_GT_zero_ending(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "5.3";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_GT, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 1);
}

void test_pkg_version_relate_version_rpm_GE(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "4.18.1";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_GE, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 1);
}

void test_pkg_version_relate_version_rpm_EQ(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "4.18.1";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_EQ, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 0);
}

void test_pkg_version_relate_version_rpm_LE(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "4.18.1";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_LE, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 0);
}

void test_pkg_version_relate_version_nvd_GE(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "t32.10";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "t5.10";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_GE, version_b, VER_TYPE_NVD);
    assert_int_equal(ret, 1);
}

void test_pkg_version_relate_version_nvd_LE(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "6.3.0";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "6.3.0r1";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_LE, version_b, VER_TYPE_NVD);
    assert_int_equal(ret, 1);
}

void test_pkg_version_relate_version_rpm_LT(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "";
    version_b->epoch = 0;
    version_b->version = "4.18.1";
    version_b->revision = "";

    int ret = pkg_version_relate(version_a, PKG_RELATION_LT, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 0);
}

void test_pkg_version_relate_revision_deb_GT(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "2+2ubuntu1.2";
    version_b->epoch = 0;
    version_b->version = "5.3.0.45";
    version_b->revision = "2+2ubuntu1.1";

    int ret = pkg_version_relate(version_a, PKG_RELATION_GT, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 1);
}

void test_pkg_version_relate_revision_deb_GE(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "2+2ubuntu1.2";
    version_b->epoch = 0;
    version_b->version = "5.3.0.45";
    version_b->revision = "2+2ubuntu1.1";

    int ret = pkg_version_relate(version_a, PKG_RELATION_GE, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 1);
}

void test_pkg_version_relate_revision_deb_EQ(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "2+2ubuntu1.2";
    version_b->epoch = 0;
    version_b->version = "5.3.0.45";
    version_b->revision = "2+2ubuntu1.1";

    int ret = pkg_version_relate(version_a, PKG_RELATION_EQ, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
}

void test_pkg_version_relate_revision_deb_LE(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "2+2ubuntu1.2";
    version_b->epoch = 0;
    version_b->version = "5.3.0.45";
    version_b->revision = "2+2ubuntu1.1";

    int ret = pkg_version_relate(version_a, PKG_RELATION_LE, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
}

void test_pkg_version_relate_revision_deb_LT(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "2+2ubuntu1.2";
    version_b->epoch = 0;
    version_b->version = "5.3.0.45";
    version_b->revision = "2+2ubuntu1.1";

    int ret = pkg_version_relate(version_a, PKG_RELATION_LT, version_b, VER_TYPE_DEB);
    assert_int_equal(ret, 0);
}

void test_pkg_version_relate_revision_rpm_GT(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "12.9";
    version_b->epoch = 0;
    version_b->version = "5.3.0.45";
    version_b->revision = "2.el8";

    int ret = pkg_version_relate(version_a, PKG_RELATION_GT, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 1);
}

void test_pkg_version_relate_revision_rpm_GE(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "12.9";
    version_b->epoch = 0;
    version_b->version = "5.3.0.45";
    version_b->revision = "2.el8";

    int ret = pkg_version_relate(version_a, PKG_RELATION_GE, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 1);
}

void test_pkg_version_relate_revision_rpm_EQ(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "12.9";
    version_b->epoch = 0;
    version_b->version = "5.3.0.45";
    version_b->revision = "2.el8";

    int ret = pkg_version_relate(version_a, PKG_RELATION_EQ, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 0);
}

void test_pkg_version_relate_revision_rpm_LE(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "12.9";
    version_b->epoch = 0;
    version_b->version = "5.3.0.45";
    version_b->revision = "2.el8";

    int ret = pkg_version_relate(version_a, PKG_RELATION_LE, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 0);
}

void test_pkg_version_relate_revision_rpm_LT(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "5.3.0.45";
    version_a->revision = "12.9";
    version_b->epoch = 0;
    version_b->version = "5.3.0.45";
    version_b->revision = "2.el8";

    int ret = pkg_version_relate(version_a, PKG_RELATION_LT, version_b, VER_TYPE_RPM);
    assert_int_equal(ret, 0);
}

void test_pkg_version_relate_revision_nvd_null(void **state)
{
    struct pkg_version *version_a = state[0];
    struct pkg_version *version_b = state[1];

    version_a->epoch = 0;
    version_a->version = "1";
    version_a->revision = NULL;
    version_b->epoch = 0;
    version_b->version = "1";
    version_b->revision = NULL;

    int ret = pkg_version_relate(version_a, PKG_RELATION_EQ, version_b, VER_TYPE_NVD);
    assert_int_equal(ret, 1);
}

int main(void) {
    const struct CMUnitTest tests[] = {
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_epoch_NONE, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_epoch_VER_TYPE_unknown, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_epoch_RELATION_unknown, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_epoch_GT, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_epoch_GE, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_epoch_EQ, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_epoch_LE, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_epoch_LT, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_epoch_negative_nvd, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_version_deb_GT, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_version_deb_GT_zero_ending, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_version_deb_GE, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_version_deb_EQ, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_version_deb_LE, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_version_deb_LT, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_version_rpm_GT, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_version_rpm_GT_zero_ending, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_version_rpm_GE, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_version_rpm_EQ, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_version_rpm_LE, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_version_nvd_GE, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_version_nvd_LE, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_version_rpm_LT, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_revision_deb_GT, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_revision_deb_GE, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_revision_deb_EQ, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_revision_deb_LE, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_revision_deb_LT, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_revision_rpm_GT, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_revision_rpm_GE, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_revision_rpm_EQ, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_revision_rpm_LE, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_revision_rpm_LT, setup_versions, teardown_versions),
        cmocka_unit_test_setup_teardown(test_pkg_version_relate_revision_nvd_null, setup_versions, teardown_versions)
    };
    return cmocka_run_group_tests(tests, NULL, NULL);
}