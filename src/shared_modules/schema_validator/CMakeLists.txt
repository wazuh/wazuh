cmake_minimum_required(VERSION 3.12.4)
project(schema_validator)

# C++17 standard
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Get SRC_FOLDER for Windows resources
if(NOT DEFINED WAZUH_MAIN_PROJECT)
  get_filename_component(SRC_FOLDER ${CMAKE_SOURCE_DIR}/../../ ABSOLUTE)
endif()

# Compiler flags
set(CMAKE_CXX_FLAGS
    "-Wall -Wextra -Wshadow -Wnon-virtual-dtor -Woverloaded-virtual -Wunused -Wcast-align -Wformat=2 -fPIC"
)

# Address/UB sanitizer (optional)

# Set output directories
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)

# Find schema files in external/indexer-plugins
set(SCHEMA_DIR "${CMAKE_CURRENT_SOURCE_DIR}/../../external/indexer-plugins")
file(GLOB SCHEMA_FILES "${SCHEMA_DIR}/*.json")

if(NOT SCHEMA_FILES)
  message(
    WARNING
      "No schema files found in ${SCHEMA_DIR}. Schemas will not be embedded.")
endif()

# Generate schemaResources.cpp from JSON schemas using CMake
set(GENERATED_RESOURCES ${CMAKE_CURRENT_BINARY_DIR}/schemaResources.cpp)

# Create a CMake script to generate the resources file
file(
  WRITE ${CMAKE_CURRENT_BINARY_DIR}/generate_resources.cmake
  "
# Auto-generated CMake script to embed JSON schemas

set(OUTPUT_FILE \"${GENERATED_RESOURCES}\")
set(SCHEMA_FILES \"${SCHEMA_FILES}\")

# Write header
file(WRITE \${OUTPUT_FILE} \"// Auto-generated file - DO NOT EDIT\\n\")
file(APPEND \${OUTPUT_FILE} \"// Generated by CMake\\n\\n\")
file(APPEND \${OUTPUT_FILE} \"#include \\\"schemaResources.hpp\\\"\\n\")
file(APPEND \${OUTPUT_FILE} \"#include <map>\\n\")
file(APPEND \${OUTPUT_FILE} \"#include <string>\\n\\n\")
file(APPEND \${OUTPUT_FILE} \"namespace SchemaValidator {\\n\")
file(APPEND \${OUTPUT_FILE} \"namespace Resources {\\n\\n\")
file(APPEND \${OUTPUT_FILE} \"// Embedded schema data\\n\")

set(SCHEMA_COUNT 0)
set(SCHEMA_ENTRIES \"\")

# Process each schema file
foreach(SCHEMA_FILE \${SCHEMA_FILES})
  if(EXISTS \${SCHEMA_FILE})
    # Get filename without path
    get_filename_component(FILENAME \${SCHEMA_FILE} NAME)
    get_filename_component(BASENAME \${SCHEMA_FILE} NAME_WE)

    # Create valid C++ variable name
    string(REPLACE \"-\" \"_\" VAR_NAME \"schema_\${BASENAME}\")

    # Read and minify JSON content (remove newlines and extra spaces)
    file(READ \${SCHEMA_FILE} CONTENT)
    string(REGEX REPLACE \"\\n\" \"\" CONTENT \"\${CONTENT}\")
    string(REGEX REPLACE \"  +\" \" \" CONTENT \"\${CONTENT}\")

    # Escape special characters for raw string literal
    # We use R\"SCHEMA(...)SCHEMA\" syntax

    # Write variable
    file(APPEND \${OUTPUT_FILE} \"static const char* \${VAR_NAME} = R\\\"SCHEMA(\\n\")
    file(APPEND \${OUTPUT_FILE} \"\${CONTENT}\")
    file(APPEND \${OUTPUT_FILE} \"\\n)SCHEMA\\\";\\n\\n\")

    # Add to map entries
    set(SCHEMA_ENTRIES \"\${SCHEMA_ENTRIES}        {\\\"\${FILENAME}\\\", \${VAR_NAME}},\\n\")

    math(EXPR SCHEMA_COUNT \"\${SCHEMA_COUNT} + 1\")
  endif()
endforeach()

# Write map function
file(APPEND \${OUTPUT_FILE} \"\\n// Map of schema files\\n\")
file(APPEND \${OUTPUT_FILE} \"const std::map<std::string, std::string>& getEmbeddedSchemas() {\\n\")
file(APPEND \${OUTPUT_FILE} \"    static const std::map<std::string, std::string> schemas = {\\n\")
file(APPEND \${OUTPUT_FILE} \"\${SCHEMA_ENTRIES}\")
file(APPEND \${OUTPUT_FILE} \"    };\\n\")
file(APPEND \${OUTPUT_FILE} \"    return schemas;\\n\")
file(APPEND \${OUTPUT_FILE} \"}\\n\\n\")
file(APPEND \${OUTPUT_FILE} \"} // namespace Resources\\n\")
file(APPEND \${OUTPUT_FILE} \"} // namespace SchemaValidator\\n\")

message(STATUS \"Generated \${OUTPUT_FILE} with \${SCHEMA_COUNT} schemas\")
")

# Add custom command to generate the resources file
add_custom_command(
  OUTPUT ${GENERATED_RESOURCES}
  COMMAND ${CMAKE_COMMAND} -P
          ${CMAKE_CURRENT_BINARY_DIR}/generate_resources.cmake
  DEPENDS ${SCHEMA_FILES}
  COMMENT "Embedding JSON schemas into C++ source"
  VERBATIM)

# Build the schema_validator library
add_library(
  schema_validator SHARED src/schemaValidator.cpp src/schemaValidator_c.cpp
                          ${GENERATED_RESOURCES} ${SRC_FOLDER}/${RESOURCE_OBJ})

if(CMAKE_SYSTEM_NAME STREQUAL "Windows")
  add_definitions(-DWIN_EXPORT)
  set_target_properties(
    schema_validator
    PROPERTIES PREFIX ""
               SUFFIX ".dll"
               LINK_FLAGS "-Wl,--add-stdcall-alias"
               POSITION_INDEPENDENT_CODE 0 # this is to avoid MinGW warning;
               # MinGW generates position-independent-code for DLL by default
  )
elseif(UNIX AND NOT APPLE)
  string(APPEND CMAKE_SHARED_LINKER_FLAGS " -Wl,-rpath=$ORIGIN")
endif(CMAKE_SYSTEM_NAME STREQUAL "Windows")

target_include_directories(
  schema_validator
  PUBLIC ${CMAKE_CURRENT_SOURCE_DIR}/include
  PRIVATE ${CMAKE_CURRENT_SOURCE_DIR}/src ${CMAKE_CURRENT_BINARY_DIR}
          ${CMAKE_CURRENT_SOURCE_DIR}/../../external/nlohmann)

# Link against stdc++fs for filesystem support (needed for older compilers)
if(CMAKE_CXX_COMPILER_ID STREQUAL "GNU" AND CMAKE_CXX_COMPILER_VERSION
                                            VERSION_LESS "9.0")
  target_link_libraries(schema_validator PRIVATE stdc++fs)
endif()

if(UNIT_TEST)
  enable_testing()
  add_coverage_libraries(schema_validator)
  add_subdirectory(tests)
endif()
