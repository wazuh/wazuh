---
name: decoder/aws-elb/0

metadata:
  title: Wazuh integration of AWS ELB Decoder
  description: Decoder for wazuh integration of Amazon ELB (ALB, CLB, NLB) logs
  module: AWS
  compatibility: >
    This decoder has been tested on Wazuh version 4.4
  references:
    - https://documentation.wazuh.com/current/amazon/services/supported-services/elastic-load-balancing/alb.html#amazon-alb
    - https://documentation.wazuh.com/current/amazon/services/supported-services/elastic-load-balancing/clb.html#amazon-clb
    - https://documentation.wazuh.com/current/amazon/services/supported-services/elastic-load-balancing/nlb.html#amazon-nlb
    - https://docs.aws.amazon.com/elasticloadbalancing/latest/classic/access-log-collection.html
    - https://docs.aws.amazon.com/elasticloadbalancing/latest/network/load-balancer-access-logs.html
    - https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-access-logs.html
  versions:
    - "4.4"
  author:
      name: Wazuh, Inc.
      url: https://wazuh.com
      date: 2023/01/20

sources:
  - decoder/aws-json/0

check: +string_equal/~json.aws.source/alb OR +string_equal/~json.aws.source/elb OR +string_equal/~json.aws.source/nlb
  #TODO: Once the events arrive tagged, uncomment these lines below and remove the above line
  # - event.module: aws
  # - event.dataset: aws-elb

normalize:
  - logpar:
      - ~json.aws.request: <http.request.method> <url.original> HTTP/<http.version>
      - ~json.aws.ssl_protocol: <tls.version>v<tls.version_protocol>

  - map:
      - wazuh.decoders: +array_append/aws-elb
      - event.module: aws
      - event.dataset: aws-elb
      - event.kind: event
      - event.type: +array_append/connection

      - event.end: $~json.aws.time
      - event.start: $~json.aws.request_creation_time

      - cloud.provider: aws
      - service.type: aws
      - trace.id: $~json.aws.trace_id
      - tls.cipher: $~json.aws.ssl_cipher

      - client.port: $~json.aws.client_port
      - client.address: $~json.aws.client_ip

      - event.action: $~json.aws.action_executed
      - event.reason: $~json.aws.classification_reason
      # can event.duration be calculated as a sum of request_processing_time, target_processing_time,
      # response_processing_time ?

      - http.response.status_code: $~json.aws.target_status_code
      - destination.bytes: $~json.aws.received_bytes
      - source.bytes: $~json.aws.sent_bytes

      - destination.port: $~json.aws.target_port
      - destination.address: $~json.aws.target_ip

      - related.ip: '+split/$~json.aws.target_ip_list/ '
      - url.domain: $~json.aws.domain_name
      - process.exit_code: $~json.aws.elb_status_code
      - process.name: $~json.aws.elb

      - error.message: $~json.aws.error_reason
      - user_agent.original: $~json.aws.user_agent
      - log.file.path: $~json.aws.log_info.log_file

      # Temporary and custom fields
      - ~json.temp_value_status_code: +parse_long/$~json.aws.target_status_code
      - ~aws_elb.related_ports: $~json.aws.target_port_list
      - ~aws_elb.target_group_arn: $~json.aws.target_group_arn
      - ~aws_elb.classification: $~json.aws.classification
      - ~aws_elb.redirect_url: $~json.aws.redirect_url
      - ~aws_elb.bucket: $~json.aws.log_info.s3bucket

    logpar:
      - url.original: 'http://<source.ip>:<source.port>/'

  - check: +string_equal/~json.aws.type/http
    map:
      - event.category: +array_append/web

  - check: +string_not_equal/~json.aws.type/http
    map:
      - event.category: +array_append/network

  - check:
      - ~json.temp_value_status_code: +int_less/400
    map:
      - event.outcome: success

  - check:
      - ~json.temp_value_status_code: +int_greater_or_equal/400
    map:
      - event.outcome: failure

  - map:
      - ~json: +delete
      - ~aws_elb: +delete
      # ~aws_elb.related_ports: +delete
      # ~aws_elb.classification: +delete
      # ~aws_elb.redirect_url: +delete
      # ~aws_elb.bucket: +delete
