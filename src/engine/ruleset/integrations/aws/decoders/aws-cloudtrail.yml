---
name: decoder/aws-cloudtrail/0

metadata:
  title: Wazuh integration of AWS Cloudtrail Decoder
  description: Decoder for wazuh integration of AWS CloudTrail Logs
  references:
    - https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-event-reference-record-contents.html
    - https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-log-file-examples.html
  product.name: Wazuh integration AWS CloudTrail
  author:
      name: Wazuh, Inc.
      url: https://wazuh.com
      date: 2023/01/18

# Example of Wazuh's integration with AWS Cloudtrail log:
# {"aws":{"source":"cloudtrail","eventVersion":"some-event-version","eventID":"some-event-id","eventTime":"2018-08-24T17:20:08Z","log_file":"some-log-file.json.gz","additionalEventData":{"MFAUsed":"No","LoginTo":"https://console.aws.amazon.com/console/home","MobileVersion":"No"},"eventType":"AwsConsoleSignIn","errorMessage":"Failed authentication","responseElements":{"ConsoleLogin":"Failure"},"awsRegion":"us-east-1","eventName":"ConsoleLogin","userIdentity":{"userName":"some-user-name","accessKeyId":"some-access-key","type":"IAMUser","principalId":"some-principal-id","accountId":"0303456"},"eventSource":"signin.amazonaws.com","userAgent":"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0","sourceIPAddress":"7.222.123.101","recipientAccountId":"1020304050607080"},"integration":"aws"}

sources:
  - decoder/aws/0

check:
  - wazuh.modules.aws.source: cloudtrail
  #TODO: Once the events arrive tagged, uncomment these lines below and remove the above line
  # - event.module: aws
  # - event.dataset: aws.cloudtrail

normalize:
  - check:
      - ~json.aws.previousDigestHashAlgorithm: SHA-256
    map:
      - file.hash.sha256: $~json.aws.previousDigestSignature

  - map:
      - aws.cloudtrail.additional_eventdata: $~json.aws.additionalEventData
      - aws.cloudtrail.api_version: $~json.aws.apiVersion
      - aws.cloudtrail.digest.end_time: $~json.aws.digestEndTime
      - aws.cloudtrail.digest.log_files: $~json.aws.logFiles
      - aws.cloudtrail.digest.newest_event_time: $~json.aws.newestEventTime
      - aws.cloudtrail.digest.oldest_event_time: $~json.aws.oldestEventTime
      - aws.cloudtrail.digest.previous_hash_algorithm: $~json.aws.previousDigestHashAlgorithm
      - aws.cloudtrail.digest.previous_s3_bucket: $~json.aws.previousDigestS3Bucket
      - aws.cloudtrail.digest.public_key_fingerprint: $~json.aws.publicKeyFingerprint
      - aws.cloudtrail.digest.s3_bucket: $~json.aws.digestS3Bucket
      - aws.cloudtrail.digest.signature_algorithm: $~json.aws.digestSignatureAlgorithm
      - aws.cloudtrail.digest.start_time: $~json.aws.digestStartTime
      - aws.cloudtrail.error_code: $~json.aws.errorCode
      - aws.cloudtrail.error_message: $~json.aws.errorMessage
      - aws.cloudtrail.event_category: $~json.aws.eventCategory
      - aws.cloudtrail.event_type: $~json.aws.eventType
      - aws.cloudtrail.event_version: $~json.aws.eventVersion
      - aws.cloudtrail.insight_details: $~json.aws.insightDetails
      - aws.cloudtrail.management_event: $~json.aws.managementEvent
      - aws.cloudtrail.read_only: $~json.aws.readOnly
      - aws.cloudtrail.recipient_account_id: $~json.aws.recipientAccountId
      - aws.cloudtrail.request_id: $~json.aws.requestId
      - aws.cloudtrail.request_parameters: $~json.aws.requestParameters
      - aws.cloudtrail.resources.account_id: $~json.aws.resources.accountId
      - aws.cloudtrail.resources.arn: $~json.aws.resources.ARN
      - aws.cloudtrail.resources.type: $~json.aws.resources.type
      - aws.cloudtrail.response_elements: $~json.aws.responseElements
      - aws.cloudtrail.service_event_details: $~json.aws.serviceEventDetails
      - aws.cloudtrail.shared_event_id: $~json.aws.sharedEventId
      - aws.cloudtrail.user_identity.access_key_id: $~json.aws.userIdentity.accessKeyId
      - aws.cloudtrail.user_identity.arn: $~json.aws.userIdentity.arn
      - aws.cloudtrail.user_identity.invoked_by: $~json.aws.userIdentity.invokedBy
      - aws.cloudtrail.user_identity.session_context.creation_date: $~json.aws.userIdentity.sessionContext.attributes.creationDate
      - aws.cloudtrail.user_identity.session_context.mfa_authenticated: $~json.aws.userIdentity.sessionContext.attributes.mfaAuthenticated
      - aws.cloudtrail.user_identity.session_context.session_issuer.account_id: $~json.aws.userIdentity.sessionContext.sessionIssuer.accountId
      - aws.cloudtrail.user_identity.session_context.session_issuer.arn: $~json.aws.userIdentity.sessionContext.sessionIssuer.arn
      - aws.cloudtrail.user_identity.session_context.session_issuer.principal_id: $~json.aws.userIdentity.sessionContext.sessionIssuer.principalId
      - aws.cloudtrail.user_identity.session_context.session_issuer.type: $~json.aws.userIdentity.sessionContext.sessionIssuer.type
      - aws.cloudtrail.user_identity.type: $~json.aws.userIdentity.type
      - aws.cloudtrail.vpc_endpoint_id: $~json.aws.vpcEndpointId

      - cloud.account.id: $~json.aws.userIdentity.accountId
      - cloud.account.id: $~json.aws.awsAccountId
      - user.name: $~json.aws.userIdentity.sessionContext.sessionIssuer.userName
      - user.name: $~json.aws.userIdentity.userName

      - cloud.region: $~json.aws.awsRegion

      - event.action: $~json.aws.eventName
      - event.id: $~json.aws.eventID
      - event.provider: $~json.aws.eventSource
      - event.outcome: success

      - file.path: $~json.aws.previousDigestS3Object

      - related.hash: $~json.aws.previousDigestSignature

      - related.user: +array_append/$~json.aws.requestParameters.userName
      - related.user: +array_append/$~json.aws.cloudtrail.flattened.request_parameters.userName
      - related.user: +array_append/$~json.aws.requestParameters.newUserName
      - related.user: +array_append/$~json.aws.cloudtrail.flattened.request_parameters.newUserName

      - source.address: $~json.aws.sourceIPAddress #TODO: does it add any value to parse it with ip?
      - source.ip: $~json.aws.sourceIPAddress
      # TODO: implement geolocalization
      # source.geo: +geo/$source.ip
      # source.as: +geo/$source.ip # database_file: GeoLite2-ASN.mmdb | properties:[asn, organization_name]

      - timestamp: $~json.aws.eventTime

      - user_agent: $~json.aws.userAgent
      - user_agent.original: $~json.aws.userAgent
      - user.id: $~json.aws.userIdentity.principalId

      - wazuh.decoders: +array_append/aws-cloudtrail

  - check:
      # TODO: need a HF to check a string length, used by flattened should be less than 32766
      - aws.cloudtrail.request_parameters: +exists
    map:
      - aws.cloudtrail.flattened.request_parameters: $~json.aws.requestParameters
      - aws.cloudtrail.flattened.response_elements: $~json.aws.responseElements
      - aws.cloudtrail.flattened.additional_eventdata: $~json.aws.additionalEventData
      - aws.cloudtrail.flattened.service_event_details: $~json.aws.serviceEventDetails
      - aws.cloudtrail.console_login.login_to: $~json.aws.additionalEventData.MobileVersion.LoginTo
      - aws.cloudtrail.console_login.mobile_version: true
      - aws.cloudtrail.console_login.mfa_used: true
      - user.changes.name: $~json.aws.cloudtrail.flattened.request_parameters.newUserName
      - user.target.name: $~json.aws.cloudtrail.flattened.request_parameters.userName
      - group.name: $~json.aws.cloudtrail.flattened.request_parameters.groupName
      - group.id: $~json.aws.cloudtrail.flattened.response_elements.group.groupId
      - user.target.id: $~json.aws.cloudtrail.flattened.response_elements.user.userId

  - check:
      - ~json.aws.additionalEventData.MobileVersion: No
    map:
      - aws.cloudtrail.console_login.mobile_version: false

  - check:
      - ~json.aws.additionalEventData.MobileVersion.MFAUsed: No
    map:
      - aws.cloudtrail.console_login.mfa_used: false

  - check: +exists/aws.cloudtrail.error_code OR +exists/aws.cloudtrail.error_message
    map:
      - event.outcome: failure

  - check:
      - ~json.aws.responseElements.ConsoleLogin: ConsoleLogin
    map:
      - event.outcome: +downcase/aws.cloudtrail.flattened.response_elements.ConsoleLogin

  - map:
      - ~json: +delete
