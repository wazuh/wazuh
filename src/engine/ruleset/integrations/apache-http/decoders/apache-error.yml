name: decoder/apache-error/0

metadata:
  module: apache-http
  title: Apache HTTP Server error logs decoder
  description: Decoder for Apache HTTP Server error logs.
  versions: ["2.2.31", "2.4.16"]
  compatibility: The Apache datasets were tested with Apache 2.4.12 and 2.4.46 and are expected to work with all versions >= 2.2.31 and >= 2.4.16 (independent from operating system).
  author:
    name: Wazuh Inc.
    date: 2023-11-29
  references:
    - https://httpd.apache.org/docs/2.4/logs.html
    - https://httpd.apache.org/docs/2.4/custom-error.html

check:
  - wazuh.location: /var/log/apache2/access.log
#TODO: Once the events arrive tagged, uncomment these lines below and remove the above regex
# - event.module: apache-http
# - event.dataset: apache-error

parse|event.original:
  - "[<event.created/%a %b %d %T %Y/en_US.UTF-8>] [<log.logger>:<log.level>] [pid <process.pid>(?:tid <process.thread.id>)] [client <source.address>(?:<source.port>)] <message>"
  - "[<event.created/%a %b %d %T %Y/en_US.UTF-8>] [<log.logger>:<log.level>] [pid <process.pid>(?:tid <process.thread.id>)] <message>"
  - "[<event.created/Mon Dec 26 16:22:00 2016>] [<log.level>] [client <source.address>(?:<source.port>)] <message>"
  - "[<event.created/Mon Dec 26 16:22:00 2016>] [<log.level>] <message>"

normalize:
  - map:
      - event.category: array_append(web)
      - event.dataset: apache-error
      - event.kind: event
      - event.module: apache-http
      - service.type: apache
      - wazuh.decoders: array_append(apache-error)

      - source.ip: $source.address

  - check:
      - log.level: regex_match(^(?:emerg|alert|crit|error|warn\)$)
    map:
      - event.type: array_append(error)
  - check:
      - log.level: regex_not_match(^(?:emerg|alert|crit|error|warn\)?$)
    map:
      - event.type: array_append(info)

  - parse|message:
      - "File does not exist: <file.path>(?, referer: <http.request.referrer>)"

  - check:
      - source.ip: not_exists()
    map:
    # TODO: Is it necessary to perform the parse?
      - source.domain: parse_fqdn($source.address)
