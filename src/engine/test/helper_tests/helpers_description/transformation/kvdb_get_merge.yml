# Name of the helper function
name: kvdb_get_merge

metadata:
  description: |
    Looks up the value of a given key in the KVDB named "db_name".
    If the key exists and the value type matches the current type of the target field,
    both values are merged:
      - If both are objects, the result is a shallow merge where keys from the KVDB
        overwrite keys from the target field on conflict.
      - If both are arrays, the result is the concatenation of the target array with
        the array obtained from the KVDB.
    If the database or key do not exist, or the types are incompatible,
    the operation is a no-op and evaluates to false (but must not fail).
    This helper function is typically used in the map stage.

  keywords:
    - kvdb

helper_type: transformation

# Indicates whether the helper function supports a variable number of arguments
is_variadic: false

# Arguments expected by the helper function
arguments:
  db_name:
    type: string
    generate: string
    source: value   # DB name is always a literal
  key:
    type: string
    generate: string
    source: both    # literal or reference ($...)

skipped:
  - success_cases

# Target field must be an object or an array to be mergeable
target_field:
  type:
    - object
    - array

test:
  # Database does not exist -> no-op (helper returns false)
  - arguments:
      db_name: non-existing-db
      key: "0x0"
    target_field:
      merged:
        status: "INITIAL"
    should_pass: false
    expected:
      merged:
        status: "INITIAL"
    description: No-op when the KVDB does not exist

  # Database exists but key does not exist -> no-op (helper returns false)
  - arguments:
      db_name: windows_kerberos_status_code_to_code_name
      key: "0x99"
    target_field:
      merged:
        status: "INITIAL"
    should_pass: false
    expected:
      merged:
        status: "INITIAL"
    description: No-op when the key does not exist in the KVDB

  # Type mismatch: target object vs KVDB string -> no-op
  - arguments:
      db_name: windows_kerberos_status_code_to_code_name
      key: "0x0"
    target_field:
      status: "INITIAL"
    should_pass: false
    expected:
      status: "INITIAL"
    description: No-op when KVDB value is a string and target field is an object

  # Type mismatch: target array vs KVDB string -> no-op
  - arguments:
      db_name: windows_kerberos_status_code_to_code_name
      key: "0x1"
    target_field: ["KDC_ERR_OLD"]
    should_pass: false
    expected: ["KDC_ERR_OLD"]
    description: No-op when KVDB value is a string and target field is an array

  # Same type-mismatch scenario but resolving the key via reference
  - arguments:
      db_name:
        source: value
        value: "windows_kerberos_status_code_to_code_name"
      key:
        source: reference
        value: "0x2"
    target_field:
      status: "INITIAL"
    should_pass: false
    expected:
      status: "INITIAL"
    description: No-op when KVDB value is a string and target field is an object, using a referenced key

  # Recursive merge of objects: KVDB "access_mask" overrides and extends the target object
  - arguments:
      db_name: windows_kerberos_status_code_to_code_name
      key: "access_mask"
    target_field:
      "0": "LOCAL_OVERRIDE"
      "99": "LOCAL_CUSTOM"
    should_pass: true
    expected:
      "0": "Create Child"                         # overridden by KVDB
      "1": "Delete Child"
      "2": "List Contents"
      "3": "SELF"
      "4": "Read Property"
      "5": "Write Property"
      "6": "Delete Tree"
      "7": "List Object"
      "8": "Control Access"
      "16": "DELETE"
      "17": "READ_CONTROL"
      "18": "WRITE_DAC"
      "19": "WRITE_OWNER"
      "20": "SYNCHRONIZE"
      "24": "ADS_RIGHT_ACCESS_SYSTEM_SECURITY"
      "31": "ADS_RIGHT_GENERIC_READ"
      "30": "ADS_RIGHT_GENERIC_WRITE"
      "29": "ADS_RIGHT_GENERIC_EXECUTE"
      "28": "ADS_RIGHT_GENERIC_ALL"
      "99": "LOCAL_CUSTOM"                        # preserved from target
    description: Recursively merges object from KVDB into target object, overriding shared keys and preserving local-only keys

  # Recursive merge of arrays: append KVDB array to existing array
  - arguments:
      db_name: windows_kerberos_status_code_to_code_name
      key: "bitmask_test_values"
    target_field:
      - -1
    should_pass: true
    expected:
      - -1
      - 0
      - 1
      - 2
      - 3
      - 4
      - 16
      - 17
      - 18
      - 19
      - 20
      - 24
      - 28
      - 29
      - 30
      - 31
    description: Recursively merges array from KVDB into target array, appending elements without clearing existing ones
