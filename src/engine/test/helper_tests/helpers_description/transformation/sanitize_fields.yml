# Name of the helper function
name: sanitize_fields

metadata:
  description: |
    Normalize object keys, standalone strings, and strings inside arrays using basicNormalize:
    lowercase ASCII, separators (space, '/', '.', '-', '\', ':') collapsed to a single '_',
    trailing '_' trimmed, and non [a-z0-9_] characters dropped.
    Fails on empty sanitized keys or key collisions. Values other than strings are not modified.
  keywords:
    - sanitize
    - rename
    - normalize

helper_type: transformation

is_variadic: false

target_field:
  type:
    - object
    - array
    - string

test:
  # 1) Identity (no change expected)
  - target_field: {"a":1,"b":2}
    should_pass: true
    expected: {"a":1,"b":2}
    description: Keys already normalized

  # 2) Basic snake-case for keys
  - target_field: {"Full Name":"Ana","e-mail":"x","Pais":"AR"}
    should_pass: true
    expected: {"full_name":"Ana","e_mail":"x","pais":"AR"}
    description: Keys lowercased and separators mapped to underscores

  # 3) Collision after sanitization -> fail
  - target_field: {"hello world":1,"hello-world":2}
    should_pass: false
    expected: ""
    description: Both map to 'hello_world' -> collision

  # 4) Leading digit (no digit guard here) -> unchanged
  - target_field: {"123abc":1,"x":2}
    should_pass: true
    expected: {"123abc":1,"x":2}
    description: basicNormalize does not prefix underscores for leading digits

  # 5) Array of strings is normalized element-wise
  - target_field: ["Hello world","hello-world","HELLO  world"]
    should_pass: true
    expected: ["hello_world","hello_world","hello_world"]
    description: Strings in arrays normalized

  # 6) Array of objects is normalized object-wise
  - target_field: [{"Full Name":"Ana"},{"e-mail":"x"}]
    should_pass: true
    expected: [{"full_name":"Ana"},{"e_mail":"x"}]
    description: Object keys inside arrays normalized

  # 7) Mixed array (string + object)
  - target_field: ["Hello world", {"Full Name":"Ana"}]
    should_pass: true
    expected: ["hello_world", {"full_name":"Ana"}]
    description: Mixed string/object array supported

  # 8) Arrays with unsupported primitives -> fail (policy)
  - target_field: [1, {"a":1}]
    should_pass: false
    expected: ""
    description: Numbers in arrays not allowed by policy
  - target_field: [true, {"a":1}]
    should_pass: false
    expected: ""
    description: Booleans in arrays not allowed by policy
  - target_field: [null, {"a":1}]
    should_pass: false
    expected: ""
    description: Nulls in arrays not allowed by policy

  # 9) Nested arrays and objects
  - target_field: [["Hello world","hello-world"], [{"Full Name":"Ana"}]]
    should_pass: true
    expected: [["hello_world","hello_world"], [{"full_name":"Ana"}]]
    description: Nested arrays/objects processed recursively

  # 10) Nested objects
  - target_field: {"a":{"B-C":{"D E":1}}}
    should_pass: true
    expected: {"a":{"b_c":{"d_e":1}}}
    description: Deep object keys normalized

  # 11) Duplicate strings allowed in arrays after normalization
  - target_field: ["a b","a-b","a_b"]
    should_pass: true
    expected: ["a_b","a_b","a_b"]
    description: Duplicated normalized strings in arrays are allowed

  # 12) Key becomes empty after normalization -> fail
  - target_field: {"***": 1}
    should_pass: false
    expected: ""
    description: All characters dropped -> empty key is invalid

  # 13) Multiple mixed separators collapse to single underscore
  - target_field: {"a\\\\b///c::d  e": 1}
    should_pass: true
    expected: {"a_b_c_d_e": 1}
    description: Mixed '\\', '/', ':', spaces collapse to single underscores

  # 14) Trailing separator is trimmed (no trailing underscore)
  - target_field: {"name:": 1}
    should_pass: true
    expected: {"name": 1}
    description: Trailing ':' produces '_' then it is trimmed at the end

  # 15) Only separators -> becomes empty -> fail
  - target_field: {":\\ /- .": 1}
    should_pass: false
    expected: ""
    description: All characters are separators; normalized key becomes empty

  # 16) Arrays of strings with backslash and colon
  - target_field: ["A\\B:C", "X:Y\\Z"]
    should_pass: true
    expected: ["a_b_c", "x_y_z"]
    description: Backslash and colon in strings become underscores

  # 17) Standalone string is normalized
  - target_field: "HELLO-world\\TEST"
    should_pass: true
    expected: "hello_world_test"
    description: Single string node normalized directly

  # 18) Standalone string becomes empty after normalization -> fail
  - target_field: "::::"
    should_pass: false
    expected: ""
    description: Only separators -> sanitized string becomes empty
