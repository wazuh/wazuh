# Name of the helper function
name: array_obj_to_mapkv

metadata:
  description: |
    Builds a map (object) from an array of objects. Each element provides the key
    (via a JSON pointer) and the value (another pointer, optionally `/` for the full object).
    Keys are normalized to lowercase snake_case unless `skipSerializer` is true, in which
    case keys are kept verbatim. Entries missing a key/value or producing an empty key
    are skipped. The helper returns an error when no entries are inserted.
  keywords:
    - array
    - map
    - key-value

helper_type: map

skipped:
  - success_cases

is_variadic: false

arguments:
  source_array:
    type: array
    source: reference
  key_pointer:
    type: string
    source: value
  value_pointer:
    type: string
    source: value
  skip_serializer:
    type: boolean
    source: value
    optional: true

output:
  type: object

test:
  - arguments:
      source_array:
        source: reference
        value:
          - Name: UserAgent
            Value: Mozilla/5.0
          - Name: Request.Type
            Value: OAuth2:Authorize
          - Name: Included Updated Properties
            Value: RequiredResourceAccess
      key_pointer:
        source: value
        value: "/Name"
      value_pointer:
        source: value
        value: "/Value"
      skip_serializer:
        source: value
        value: false
    should_pass: true
    expected:
      useragent: Mozilla/5.0
      request_type: OAuth2:Authorize
      included_updated_properties: RequiredResourceAccess
    description: Normalizes keys and extracts values using `/Value` pointer
    context: |
      {
        "ExtendedProperties": [
          {"Name": "UserAgent", "Value": "Mozilla/5.0"},
          {"Name": "Request.Type", "Value": "OAuth2:Authorize"},
          {"Name": "Included Updated Properties", "Value": "RequiredResourceAccess"}
        ]
      }

  - arguments:
      source_array:
        source: reference
        value:
          - Name: UserAgent
            Value: Mozilla/5.0
          - Name: KeepMeSignedIn
            Value: true
          - Name: OptionalField
            Value: null
          - Name: Roles
            Value:
              - admin
              - user
          - Name: Meta
            Value:
              os: linux
              arch: x64
      key_pointer:
        source: value
        value: "/Name"
      value_pointer:
        source: value
        value: "/Value"
      skip_serializer:
        source: value
        value: true
    should_pass: true
    expected:
      UserAgent: Mozilla/5.0
      KeepMeSignedIn: true
      OptionalField: null
      Roles:
        - admin
        - user
      Meta:
        os: linux
        arch: x64
    description: Keeps keys verbatim when `skipSerializer` is true
    context: |
      {
        "ExtendedProperties": [
          {"Name": "UserAgent", "Value": "Mozilla/5.0"},
          {"Name": "KeepMeSignedIn", "Value": true},
          {"Name": "OptionalField", "Value": null},
          {"Name": "Roles", "Value": ["admin", "user"]},
          {"Name": "Meta", "Value": {"os": "linux", "arch": "x64"}}
        ]
      }

  - arguments:
      source_array:
        source: reference
        value: null
      key_pointer:
        source: value
        value: "/Name"
      value_pointer:
        source: value
        value: "/Value"
      skip_serializer:
        source: value
        value: false
    should_pass: false
    description: Fails when array does not exist in the context
    context: |
      {}
