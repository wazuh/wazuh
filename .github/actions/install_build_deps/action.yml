name: "Install Wazuh build dependencies"
description: "This action installs all the requirements to test and build Wazuh agent/server in Ubuntu Linux"
inputs:
   target:
     required: true
     description: "Wazuh target to decide if install or not custom dependencies"
runs:
  using: "composite"
  steps:
    - name: Update apt-get
      shell: bash
      run: sudo apt-get update -y
    - name: Install tools and libraries
      shell: bash
      run: sudo apt-get install cppcheck astyle valgrind lcov clang-tools -y
    - name: Install mingw
      shell: bash
      run: |
        if [[ "${{ inputs.target }}" == "winagent" ]]; then
          sudo apt-get install gcc-mingw-w64 g++-mingw-w64-i686 g++-mingw-w64-x86-64 -y
          # Ensure the POSIX threading runtime is selected so std::thread/condition_variable work
          if [[ -x /usr/bin/i686-w64-mingw32-gcc-posix ]]; then
            sudo update-alternatives --set i686-w64-mingw32-gcc /usr/bin/i686-w64-mingw32-gcc-posix
          fi
          if [[ -x /usr/bin/i686-w64-mingw32-g++-posix ]]; then
            sudo update-alternatives --set i686-w64-mingw32-g++ /usr/bin/i686-w64-mingw32-g++-posix
          fi
          if [[ -x /usr/bin/x86_64-w64-mingw32-gcc-posix ]]; then
            sudo update-alternatives --set x86_64-w64-mingw32-gcc /usr/bin/x86_64-w64-mingw32-gcc-posix
          fi
          if [[ -x /usr/bin/x86_64-w64-mingw32-g++-posix ]]; then
            sudo update-alternatives --set x86_64-w64-mingw32-g++ /usr/bin/x86_64-w64-mingw32-g++-posix
          fi
        else
          echo "Skipping mingw installation for this target"
        fi
    - name: Install wine
      shell: bash
      run: |
        if [[ "${{ inputs.target }}" == "winagent" ]]; then
          sudo dpkg --add-architecture i386
          sudo apt-get update
          # Install only 32-bit Wine to avoid WOW64 issues with Azure kernel
          sudo apt-get install -y wine32:i386
          wine --version
          # Initialize Wine prefix with 32-bit architecture for i686-w64-mingw32 tests
          WINEARCH=win32 WINEDLLOVERRIDES="mscoree,mshtml=" wine wineboot --init 2>&1 | head -10 || true
        else
          echo "Skipping wine installation for this target"
        fi
    - name: Install CMocka
      shell: bash
      run: |
        if [[ "${{ inputs.target }}" == "winagent" ]]; then
          echo "Installing CMocka by sources with 'winagent' required flags"
          curl -L --retry 3 --retry-delay 2 -o /tmp/stable-1.1.tar.gz https://git.cryptomilk.org/projects/cmocka.git/snapshot/stable-1.1.tar.gz
          # Verify if the download was successful
          if [ $? -ne 0 ]; then
              echo "Error during download. Exiting..."
              exit 1
          fi
          tar -zxf /tmp/stable-1.1.tar.gz -C /tmp/
          sed -i "s|ON|OFF|g" /tmp/stable-1.1/DefineOptions.cmake
          mkdir /tmp/stable-1.1/build
          cd /tmp/stable-1.1/build
          cmake -DCMAKE_C_COMPILER=i686-w64-mingw32-gcc -DCMAKE_C_LINK_EXECUTABLE=i686-w64-mingw32-ld -DCMAKE_INSTALL_PREFIX=/usr/i686-w64-mingw32/ -DCMAKE_SYSTEM_NAME=Windows -DCMAKE_BUILD_TYPE=Release ..
          make
          sudo make install
          cd $GITHUB_WORKSPACE
        else
          echo "Installing CMocka directly from apt-get"
          sudo apt-get install libcmocka-dev -y
        fi
