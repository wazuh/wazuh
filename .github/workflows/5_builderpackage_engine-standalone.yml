name: 5.X - Engine Standalone

on:
  # Triggers the workflow on demand
  workflow_dispatch:
    inputs:
      wazuh-branch:
        description: 'Wazuh branch'
        required: false
        type: string
        default: 'main'

      build-type:
        type: choice
        description: 'Choose the CMake build type'
        required: false
        default: 'release'
        options:
          - debug
          - release

  workflow_call:
    inputs:
      wazuh-branch:
        description: 'Wazuh branch'
        required: false
        type: string
        default: 'main'

      build-type:
        description: 'Choose the CMake build type (debug or release)'
        required: false
        type: string
        default: 'release'

  # Triggers the workflow on pull request but only changes in the src/engine/ directory.
  pull_request:
    types: [synchronize, opened, reopened, ready_for_review]
    paths:
      - 'src/engine/**'
      - '.github/workflows/5_builderpackage_engine-standalone.yml'

# Ensures only one instance of this workflow is running per PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name == 'workflow_call' && 'called' || 'trigger' }}
  cancel-in-progress: true

env:
  ENGINE_DIR: ${{github.workspace}}/src/engine
  WAZUH_BRANCH: ${{ inputs.wazuh-branch || 'main' }}
  BUILD_TYPE: ${{ inputs.build-type || 'release' }}

jobs:
  build:
    name: Build Server (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    outputs:
      version: ${{ steps.set_version.outputs.version }}
    strategy:
      matrix:
        arch: [amd64, arm64]
        include:
          - arch: amd64
            runner: ubuntu-latest
            container_name: pkg_rpm_manager_builder_amd64
          - arch: arm64
            runner: ubuntu-24.04-arm
            container_name: pkg_rpm_manager_builder_arm64
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || env.WAZUH_BRANCH }}

      - name: Set tag and container name
        id: set_version
        run: |
          VERSION="$(grep '"version"' $GITHUB_WORKSPACE/VERSION.json | sed -E 's/.*"version": *"([^"]+)".*/\1/')"
          echo "TAG=$VERSION" >> $GITHUB_ENV;
          echo "version=$VERSION" >> $GITHUB_OUTPUT;
          echo "CONTAINER_NAME=${{ matrix.container_name }}" >> $GITHUB_ENV;

      - name: Download docker image for package building
        run: |
          bash $GITHUB_WORKSPACE/.github/actions/ghcr-pull-and-push/pull_image_from_ghcr.sh ${{ secrets.GITHUB_TOKEN }} ${{ github.actor}} ${CONTAINER_NAME} ${TAG}

      - name: Build standalone package
        run: |
          cd ${{ env.ENGINE_DIR }}/standalone
          FLAGS="--dont-build-docker --tag ${TAG} -a ${{ matrix.arch }}"
          if [ "${{ env.BUILD_TYPE }}" == "debug" ]; then FLAGS+=" -d"; fi
          echo "Running: ./generate_package.sh $FLAGS"
          bash generate_package.sh $FLAGS

      - name: Upload standalone package
        uses: actions/upload-artifact@v4
        with:
          name: wazuh-engine-${{ env.TAG }}-linux-${{ matrix.arch }}
          path: ${{ env.ENGINE_DIR }}/standalone/output/*.tar.gz

  check_standalone_engine:
    name: Test standalone engine (${{ matrix.arch }})

    runs-on: ${{ matrix.runner }}
    needs: build
    timeout-minutes: 60
    strategy:
      matrix:
        arch: [amd64, arm64]
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm

    steps:
    - name: Download compressed tar.gz file
      uses: actions/download-artifact@v4
      with:
        name: wazuh-engine-${{ needs.build.outputs.version }}-linux-${{ matrix.arch }}
        path: /tmp/standalone-test

    - name: Extract standalone package
      run: |
        cd /tmp/standalone-test
        tar xzf wazuh-engine-${{ needs.build.outputs.version }}-linux-${{ matrix.arch }}.tar.gz
        mv wazuh-engine-standalone-${{ needs.build.outputs.version }} wazuh-engine-standalone

    - name: Verify artifact structure
      run: |
        echo "=== Artifact structure verification ==="
        echo "Contents of /tmp/standalone-test:"
        find /tmp/standalone-test -type f -o -type d | head -20
        echo ""
        echo "Looking for wazuh-engine-standalone directory..."
        if [ -d "/tmp/standalone-test/wazuh-engine-standalone" ]; then
          echo "✓ Found wazuh-engine-standalone directory"
          echo "Contents of wazuh-engine-standalone:"
          ls -la /tmp/standalone-test/wazuh-engine-standalone/
          echo ""
          echo "Checking for required files:"
          [ -f "/tmp/standalone-test/wazuh-engine-standalone/run_engine.sh" ] && echo "✓ run_engine.sh found" || echo "✗ run_engine.sh missing"
          [ -f "/tmp/standalone-test/wazuh-engine-standalone/bin/wazuh-engine" ] && echo "✓ wazuh-engine binary found" || echo "✗ wazuh-engine binary missing"
          [ -d "/tmp/standalone-test/wazuh-engine-standalone/data" ] && echo "✓ data directory found" || echo "✗ data directory missing"
          echo ""
          echo "Checking directory permissions:"
          if [ -d "/tmp/standalone-test/wazuh-engine-standalone/sockets" ]; then
            echo "sockets directory permissions:"
            ls -ld /tmp/standalone-test/wazuh-engine-standalone/sockets
          else
            echo "sockets directory not found"
          fi
          if [ -d "/tmp/standalone-test/wazuh-engine-standalone/logs" ]; then
            echo "logs directory permissions:"
            ls -ld /tmp/standalone-test/wazuh-engine-standalone/logs
          else
            echo "logs directory not found"
          fi
          if [ -d "/tmp/standalone-test/wazuh-engine-standalone/data/kvdb" ]; then
            echo "kvdb directory permissions:"
            ls -ld /tmp/standalone-test/wazuh-engine-standalone/data/kvdb
          else
            echo "kvdb directory not found"
          fi
        else
          echo "✗ wazuh-engine-standalone directory not found!"
          echo "Available files and directories:"
          find /tmp/standalone-test -type f -o -type d
          exit 1
        fi

    - name: Basic communication test
      run: |
        cd /tmp/standalone-test/wazuh-engine-standalone
        chmod +x run_engine.sh
        chmod +x bin/wazuh-engine
        ls -la
        ./run_engine.sh > engine_stdout.log 2> engine_stderr.log &
        ENGINE_PID=$!
        sleep 5
        cat engine_stderr.log
        curl --silent --unix-socket sockets/engine-api.sock \
            -X POST -H "Content-Type: application/json" \
            -d '{"name":"default"}' \
            http://localhost/router/route/get
        if [ $? -eq 0 ]; then
            echo "Engine started successfully"
            kill $ENGINE_PID
        else
            echo "Engine failed to start"
            kill $ENGINE_PID
            exit 1
        fi
