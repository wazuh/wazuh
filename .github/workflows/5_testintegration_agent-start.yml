name: 5.X - Agent Startup Smoke Test

on:
  workflow_dispatch:
    inputs:
      base_branch:
        description: 'Base branch'
        required: true
        default: 'main'

  workflow_run:
    workflows:
      - "5.X - Build Wazuh agent Linux (DEB/RPM)"
      - "5.X - Build Wazuh agent Windows (MSI)"
      - "5.X - Build Wazuh agent macOS (PKG)"
    types:
      - completed

jobs:
  test-linux-deb-amd64:
    if: |
      (github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.name == '5.X - Build Wazuh agent Linux (DEB/RPM)') ||
      github.event_name != 'workflow_run'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    name: Test Linux Agent DEB (amd64) startup
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine branch/commit for artifact download
        id: artifact_source
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Using base_branch from input: ${{ inputs.base_branch }}"
            echo "branch=${{ inputs.base_branch }}" >> $GITHUB_OUTPUT
            echo "use_branch=true" >> $GITHUB_OUTPUT
          else
            # workflow_run trigger
            echo "Using commit from workflow_run: ${{ github.event.workflow_run.head_sha }}"
            echo "commit=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
            echo "use_branch=false" >> $GITHUB_OUTPUT
          fi

      - name: Download DEB package artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: 5_builderpackage_agent-linux.yml
          workflow_conclusion: success
          name_is_regexp: true
          name: 'wazuh-agent.*amd64.*\.deb'
          path: /tmp/packages
          if_no_artifact_found: fail
          check_artifacts: true
          search_artifacts: true
          branch: ${{ steps.artifact_source.outputs.use_branch == 'true' && steps.artifact_source.outputs.branch || '' }}
          commit: ${{ steps.artifact_source.outputs.use_branch == 'false' && steps.artifact_source.outputs.commit || '' }}

      - name: Get package name and version
        id: package
        run: |
          PACKAGE_NAME=$(find /tmp/packages -type f -name "wazuh-agent*amd64*.deb" ! -name "*dbg*" -exec basename {} \; | head -n1)
          if [ -z "$PACKAGE_NAME" ]; then
            echo "ERROR: No package found"
            exit 1
          fi
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV
          echo "Found package: $PACKAGE_NAME"
          VERSION=$(echo $PACKAGE_NAME | grep -oP '\d+\.\d+\.\d+' | head -n 1)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "CONTAINER_NAME=pkg_deb_agent_builder_amd64" >> $GITHUB_ENV
          echo "TAG=$VERSION" >> $GITHUB_ENV

      - name: Download docker image
        run: |
          bash .github/actions/ghcr-pull-and-push/pull_image_from_ghcr.sh ${{ secrets.CI_WAZUH_AGENT_PACKAGES_CLASSIC }} ${{ github.actor}} ${{ env.CONTAINER_NAME }} ${{ env.TAG }}

      - name: Run smoke test in Docker
        run: |
          TESTS_PATH=$GITHUB_WORKSPACE/.github/actions/5_testintegration_agent-start/
          docker run --rm \
            -v $TESTS_PATH:/tests \
            -v /tmp/packages:/packages \
            --entrypoint '/tests/smoke_startup_test.sh' \
            ${{ env.CONTAINER_NAME }}:${{ env.TAG }}

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb-amd64-logs-${{ github.run_id }}
          path: /tmp/packages/*.log
          retention-days: 7

  test-linux-rpm-x86_64:
    if: |
      (github.event_name == 'workflow_run' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.name == '5.X - Build Wazuh agent Linux (DEB/RPM)') ||
      github.event_name != 'workflow_run'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    name: Test Linux Agent RPM (x86_64) startup
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine branch/commit for artifact download
        id: artifact_source
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Using base_branch from input: ${{ inputs.base_branch }}"
            echo "branch=${{ inputs.base_branch }}" >> $GITHUB_OUTPUT
            echo "use_branch=true" >> $GITHUB_OUTPUT
          else
            # workflow_run trigger
            echo "Using commit from workflow_run: ${{ github.event.workflow_run.head_sha }}"
            echo "commit=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
            echo "use_branch=false" >> $GITHUB_OUTPUT
          fi

      - name: Download RPM package artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: 5_builderpackage_agent-linux.yml
          workflow_conclusion: success
          name_is_regexp: true
          name: 'wazuh-agent.*x86_64.*\.rpm'
          path: /tmp/packages
          if_no_artifact_found: fail
          check_artifacts: true
          search_artifacts: true
          branch: ${{ steps.artifact_source.outputs.use_branch == 'true' && steps.artifact_source.outputs.branch || '' }}
          commit: ${{ steps.artifact_source.outputs.use_branch == 'false' && steps.artifact_source.outputs.commit || '' }}

      - name: Get package name and version
        id: package
        run: |
          PACKAGE_NAME=$(find /tmp/packages -type f -name "wazuh-agent*x86_64*.rpm" ! -name "*dbg*" ! -name "*debug*" ! -name "*debuginfo*" -exec basename {} \; | head -n1)
          if [ -z "$PACKAGE_NAME" ]; then
            echo "ERROR: No package found"
            exit 1
          fi
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV
          echo "Found package: $PACKAGE_NAME"
          VERSION=$(echo $PACKAGE_NAME | grep -oP '\d+\.\d+\.\d+' | head -n 1)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "CONTAINER_NAME=pkg_rpm_agent_builder_x86_64" >> $GITHUB_ENV
          echo "TAG=$VERSION" >> $GITHUB_ENV

      - name: Download docker image
        run: |
          bash .github/actions/ghcr-pull-and-push/pull_image_from_ghcr.sh ${{ secrets.CI_WAZUH_AGENT_PACKAGES_CLASSIC }} ${{ github.actor}} ${{ env.CONTAINER_NAME }} ${{ env.TAG }}

      - name: Run smoke test in Docker
        run: |
          TESTS_PATH=$GITHUB_WORKSPACE/.github/actions/5_testintegration_agent-start/
          docker run --rm \
            -v $TESTS_PATH:/tests \
            -v /tmp/packages:/packages \
            --entrypoint '/tests/smoke_startup_test.sh' \
            ${{ env.CONTAINER_NAME }}:${{ env.TAG }}

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: linux-rpm-x86_64-logs-${{ github.run_id }}
          path: /tmp/packages/*.log
          retention-days: 7

  test-windows:
    if: |
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.name == '5.X - Build Wazuh agent Windows (MSI)') ||
      github.event_name != 'workflow_run'
    runs-on: windows-2022
    timeout-minutes: 30
    name: Test Windows Agent startup
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine branch/commit for artifact download
        id: artifact_source
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Using base_branch from input: ${{ inputs.base_branch }}"
            echo "branch=${{ inputs.base_branch }}" >> $GITHUB_OUTPUT
            echo "use_branch=true" >> $GITHUB_OUTPUT
          else
            # workflow_run trigger
            echo "Using commit from workflow_run: ${{ github.event.workflow_run.head_sha }}"
            echo "commit=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
            echo "use_branch=false" >> $GITHUB_OUTPUT
          fi

      - name: Download MSI package artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: 5_builderpackage_agent-windows.yml
          workflow_conclusion: success
          name_is_regexp: true
          name: 'wazuh-agent.*windows.*\.msi'
          path: C:\packages
          if_no_artifact_found: fail
          check_artifacts: true
          search_artifacts: true
          branch: ${{ steps.artifact_source.outputs.use_branch == 'true' && steps.artifact_source.outputs.branch || '' }}
          commit: ${{ steps.artifact_source.outputs.use_branch == 'false' && steps.artifact_source.outputs.commit || '' }}

      - name: Get package name
        id: package
        shell: pwsh
        run: |
          $PACKAGE = Get-ChildItem -Path "C:\packages" -Filter "wazuh-agent*windows*.msi" -Recurse | Where-Object { $_.Name -notmatch 'debug' } | Select-Object -First 1 -ExpandProperty FullName
          if (-not $PACKAGE) {
            Write-Host "ERROR: No MSI package found"
            Get-ChildItem -Path "C:\packages" -Recurse | Format-Table Name, FullName
            exit 1
          }
          echo "package-path=$PACKAGE" >> $env:GITHUB_OUTPUT
          Write-Host "Found package: $PACKAGE"

      - name: Install Wazuh agent
        shell: pwsh
        run: |
          Write-Host "Installing package from: ${{ steps.package.outputs.package-path }}"

          # Install MSI with WAZUH_MANAGER variable (official method from Wazuh documentation)
          $msiPath = "${{ steps.package.outputs.package-path }}"
          $arguments = @(
            "/i"
            "`"$msiPath`""
            "/q"
            "WAZUH_MANAGER=`"1.2.3.4`""
          )

          Start-Process msiexec.exe -ArgumentList $arguments -Wait -NoNewWindow

          # Verify installation
          if (Test-Path "C:\Program Files (x86)\ossec-agent") {
            Write-Host "✓ Agent installed successfully"
          } else {
            Write-Host "ERROR: Installation failed"
            exit 1
          }

      - name: Start Wazuh agent service
        shell: pwsh
        run: |
          Write-Host "Starting Wazuh agent service..."
          Start-Service -Name wazuh

      - name: Wait for agent to initialize
        shell: pwsh
        run: Start-Sleep -Seconds 10

      - name: Verify agent is running
        shell: pwsh
        run: |
          Write-Host "Checking agent status..."
          $service = Get-Service -Name wazuh

          if ($service.Status -ne 'Running') {
            Write-Host "ERROR: Service is not running. Status: $($service.Status)"
            exit 1
          }

          Write-Host "✓ Agent service is running"
          Write-Host "Service Status: $($service.Status)"

      - name: Stop Wazuh agent service
        shell: pwsh
        run: |
          Write-Host "Stopping Wazuh agent service..."
          Stop-Service -Name wazuh

          # Verify it stopped
          $service = Get-Service -Name wazuh
          if ($service.Status -ne 'Stopped') {
            Write-Host "WARNING: Service did not stop cleanly. Status: $($service.Status)"
          } else {
            Write-Host "✓ Agent service stopped successfully"
          }

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: windows-logs-${{ github.run_id }}
          path: C:\Program Files (x86)\ossec-agent\*.log
          retention-days: 7

  test-macos-arm64:
    if: |
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.name == '5.X - Build Wazuh agent macOS (PKG)') ||
      github.event_name != 'workflow_run'
    runs-on: macos-14
    timeout-minutes: 30
    name: Test macOS Agent (arm64) startup
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine branch/commit for artifact download
        id: artifact_source
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Using base_branch from input: ${{ inputs.base_branch }}"
            echo "branch=${{ inputs.base_branch }}" >> $GITHUB_OUTPUT
            echo "use_branch=true" >> $GITHUB_OUTPUT
          else
            # workflow_run trigger
            echo "Using commit from workflow_run: ${{ github.event.workflow_run.head_sha }}"
            echo "commit=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
            echo "use_branch=false" >> $GITHUB_OUTPUT
          fi

      - name: Download PKG package artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: 5_builderpackage_agent-macos.yml
          workflow_conclusion: success
          name_is_regexp: true
          name: 'wazuh-agent.*arm64.*\.pkg'
          path: /tmp/packages
          if_no_artifact_found: fail
          check_artifacts: true
          search_artifacts: true
          branch: ${{ steps.artifact_source.outputs.use_branch == 'true' && steps.artifact_source.outputs.branch || '' }}
          commit: ${{ steps.artifact_source.outputs.use_branch == 'false' && steps.artifact_source.outputs.commit || '' }}

      - name: Get package name
        id: package
        run: |
          PACKAGE=$(find /tmp/packages -type f -name "wazuh-agent*.pkg" ! -name "*debug*" | head -n1)
          echo "package-path=$PACKAGE" >> $GITHUB_OUTPUT
          echo "Found package: $PACKAGE"

      - name: Install Wazuh agent
        run: |
          echo "Installing package from: ${{ steps.package.outputs.package-path }}"

          # Install PKG with WAZUH_MANAGER variable (official method from Wazuh documentation)
          echo "WAZUH_MANAGER='1.2.3.4'" > /tmp/wazuh_envs
          sudo installer -pkg "${{ steps.package.outputs.package-path }}" -target /

          # Verify installation
          if [ -d "/Library/Ossec" ]; then
            echo "✓ Agent installed successfully"
          else
            echo "ERROR: Installation failed"
            exit 1
          fi

      - name: Test daemons with -t flag
        run: |
          # Test each daemon binary with -t flag (test configuration)
          DAEMONS="wazuh-modulesd wazuh-logcollector wazuh-syscheckd wazuh-agentd wazuh-execd"

          echo "Testing daemons with -t flag..."
          for daemon in $DAEMONS; do
            echo "Testing ${daemon}..."
            if ! sudo /Library/Ossec/bin/${daemon} -t; then
              echo "ERROR: ${daemon} -t failed with exit code $?"
              exit 1
            fi
            echo "✓ ${daemon} -t passed"
          done

      - name: Start Wazuh agent
        run: |
          echo "Starting Wazuh agent..."
          sudo /Library/Ossec/bin/wazuh-control start

      - name: Wait for agent to initialize
        run: sleep 10

      - name: Verify agent is running
        run: |
          echo "Checking agent status..."
          if ! sudo /Library/Ossec/bin/wazuh-control status; then
            echo "ERROR: Agent status check failed"
            exit 1
          fi
          echo "✓ Agent is running"

      - name: Stop Wazuh agent
        run: |
          echo "Stopping Wazuh agent..."
          sudo /Library/Ossec/bin/wazuh-control stop
          echo "✓ Agent stopped successfully"

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-logs-${{ github.run_id }}
          path: /Library/Ossec/logs/
          retention-days: 7
