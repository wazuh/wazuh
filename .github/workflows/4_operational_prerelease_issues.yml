name: Create Release Suite Issues

permissions:
  issues: write
  contents: read

on:
  workflow_dispatch:
    inputs:
      release:
        description: 'Release version (e.g., 4.7.1)'
        required: true
        type: string
      stage:
        description: 'Stage (e.g., RC 3, Alpha 1)'
        required: true
        type: string
      main_issue:
        description: 'Main issue number'
        required: true
        type: string
      prev_ut:
        description: 'Previous Unit Tests issue number (or blank)'
        required: false
        type: string
        default: ''
      prev_cov:
        description: 'Previous Coverity issue number (or blank)'
        required: false
        type: string
        default: ''
      prev_it:
        description: 'Previous Integration Tests issue number (or blank)'
        required: false
        type: string
        default: ''
      prev_wpk:
        description: 'Previous WPK Tests issue number (or blank)'
        required: false
        type: string
        default: ''

jobs:
  create-unit-tests-issue:
    name: "Create Unit Tests Issue"
    if: ${{ inputs.prev_ut != '' }}
    runs-on: ubuntu-latest
    outputs:
      issue_url: ${{ steps.create-ut-issue.outputs.issue_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Unit Tests Issue
        id: create-ut-issue
        uses: ./.github/actions/4_operational_prerelease_unit_tests_issue
        with:
          release: ${{ inputs.release }}
          stage: ${{ inputs.stage }}
          main_issue: ${{ inputs.main_issue }}
          prev_issue: ${{ inputs.prev_ut }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

  create-coverity-issue:
    name: "Create Coverity Analysis Issue"
    if: ${{ inputs.prev_cov != '' }}
    runs-on: ubuntu-latest
    outputs:
      issue_url: ${{ steps.create-cov-issue.outputs.issue_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Coverity Issue
        id: create-cov-issue
        uses: ./.github/actions/4_operational_prerelease_coverity_issue
        with:
          release: ${{ inputs.release }}
          stage: ${{ inputs.stage }}
          main_issue: ${{ inputs.main_issue }}
          prev_issue: ${{ inputs.prev_cov }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

  create-integration-tests-issue:
    name: "Create Integration Tests Issue"
    if: ${{ inputs.prev_it != '' }}
    runs-on: ubuntu-latest
    outputs:
      issue_url: ${{ steps.create-it-issue.outputs.issue_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Integration Tests Issue
        id: create-it-issue
        uses: ./.github/actions/4_operational_prerelease_agent_integration_tests_issue
        with:
          release: ${{ inputs.release }}
          stage: ${{ inputs.stage }}
          main_issue: ${{ inputs.main_issue }}
          prev_issue: ${{ inputs.prev_it }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

  create-wpk-tests-issue:
    name: "Create WPK Tests Issue"
    if: ${{ inputs.prev_wpk != '' }}
    runs-on: ubuntu-latest
    outputs:
      issue_url: ${{ steps.create-wpk-issue.outputs.issue_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create WPK Tests Issue
        id: create-wpk-issue
        uses: ./.github/actions/4_operational_prerelease_wpk_tests_issue
        with:
          release: ${{ inputs.release }}
          stage: ${{ inputs.stage }}
          main_issue: ${{ inputs.main_issue }}
          prev_issue: ${{ inputs.prev_wpk }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: "Workflow Result"
    needs: [create-unit-tests-issue, create-coverity-issue, create-integration-tests-issue, create-wpk-tests-issue]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Release Suite Issues Creation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** ${{ inputs.release }}" >> $GITHUB_STEP_SUMMARY
          echo "**Stage:** ${{ inputs.stage }}" >> $GITHUB_STEP_SUMMARY
          echo "**Main Issue:** https://github.com/${{ github.repository }}/issues/${{ inputs.main_issue }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Issues Created" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ inputs.prev_ut }}" != "" ]]; then
            if [[ "${{ needs.create-unit-tests-issue.result }}" == "success" ]]; then
              UT_URL="${{ needs.create-unit-tests-issue.outputs.issue_url }}"
              echo "- ✅ Unit Tests Issue: ${UT_URL}" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ Unit Tests Issue (Failed)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          if [[ "${{ inputs.prev_cov }}" != "" ]]; then
            if [[ "${{ needs.create-coverity-issue.result }}" == "success" ]]; then
              COV_URL="${{ needs.create-coverity-issue.outputs.issue_url }}"
              echo "- ✅ Coverity Issue: ${COV_URL}" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ Coverity Issue (Failed)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          if [[ "${{ inputs.prev_it }}" != "" ]]; then
            if [[ "${{ needs.create-integration-tests-issue.result }}" == "success" ]]; then
              IT_URL="${{ needs.create-integration-tests-issue.outputs.issue_url }}"
              echo "- ✅ Integration Tests Issue: ${IT_URL}" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ Integration Tests Issue (Failed)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          if [[ "${{ inputs.prev_wpk }}" != "" ]]; then
            if [[ "${{ needs.create-wpk-tests-issue.result }}" == "success" ]]; then
              WPK_URL="${{ needs.create-wpk-tests-issue.outputs.issue_url }}"
              echo "- ✅ WPK Tests Issue: ${WPK_URL}" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ WPK Tests Issue (Failed)" >> $GITHUB_STEP_SUMMARY
            fi
          fi
