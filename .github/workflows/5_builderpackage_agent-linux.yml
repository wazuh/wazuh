run-name: Build Wazuh agent Linux - ${{ github.event_name == 'pull_request' && github.event.pull_request.head.ref || github.ref_name }} - ${{ inputs.system || 'deb,rpm' }} - ${{ inputs.architecture || 'amd64,i386' }}
name: 5.X - Build Wazuh agent Linux (DEB/RPM)

on:
  pull_request:
    types: [synchronize, opened, reopened, ready_for_review]
    paths:
      - "src/**"
      - "packages/**"
      - ".github/workflows/5_builderpackage_agent-linux-amd64.yml"
  workflow_dispatch:
    inputs:
      architecture:
        type: choice
        description: Package architecture [x86_64, amd64, i386].
        required: true
        default: amd64
        options:
          - x86_64
          - amd64
          - i386
      system:
        type: choice
        description: Package OS [deb, rpm].
        required: true
        default: deb
        options:
          - deb
          - rpm
      revision:
        description: |
          Package revision (name and metadata).
          Default is '0'.
        required: false
        default: '0'
      debug:
        type: boolean
        description: |
          Build the binaries as debug (without optimizations).
          Default is 'false'.
        required: false
        default: false
      checksum:
        type: boolean
        description: |
          Generate package checksum.
          Default is 'false'.
        required: false
        default: false

jobs:
  # ===================== DEB JOBS =====================
  build-deb:
    if: github.event_name == 'pull_request' || inputs.system == 'deb'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    name: Build DEB ${{ matrix.arch }} package
    strategy:
      matrix:
        arch: ${{ github.event_name == 'pull_request' && fromJSON('["amd64", "i386"]') || fromJSON(format('["{{0}}"]', inputs.architecture == 'x86_64' && 'amd64' || inputs.architecture)) }}
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set ARCH
        id: set-arch
        run: |
          arch="${{ matrix.arch }}"
          echo "ARCH=$arch" >> $GITHUB_ENV
          echo "arch=$arch" >> $GITHUB_OUTPUT

      - name: Set VERSION and CONTAINER_NAME
        run: |
          VERSION="$(sed -n 's/.*"version"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p' VERSION.json)"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TAG=$VERSION" >> $GITHUB_ENV
          echo "CONTAINER_NAME=pkg_deb_agent_builder_${{ env.ARCH }}" >> $GITHUB_ENV
          echo "SYSTEM=deb" >> $GITHUB_ENV

      - name: Download docker image for package building
        run: |
          bash .github/actions/ghcr-pull-and-push/pull_image_from_ghcr.sh ${{ secrets.CI_WAZUH_AGENT_PACKAGES_CLASSIC }} ${{ github.actor}} ${{ env.CONTAINER_NAME }} ${{ env.TAG }}

      - name: Append short commit to VERSION file
        run: |
          SHORT_COMMIT=$(git rev-parse --short=7 HEAD)
          if [ -z "$SHORT_COMMIT" ]; then echo "No commit found"; exit 1; fi
          echo "Found commit: $SHORT_COMMIT"
          sed -i '/"stage":/s/$/,/; /"stage":/a \    "commit": "'"$SHORT_COMMIT"'"' VERSION.json || exit 1
          cat VERSION.json

      - name: Build DEB ${{ env.ARCH }} package
        id: build
        run: |
          REVISION=${{ inputs.revision || '0' }}
          FLAGS="--verbose -t agent -s /tmp --dont-build-docker -j $(nproc) "
          FLAGS+="-r $REVISION "
          if [ "${{ inputs.checksum }}" == "true" ]; then FLAGS+="--checksum "; fi
          if [ "${{ inputs.debug }}" == "true" ]; then FLAGS+="--debug "; fi
          echo "generate_package.sh -a ${{ env.ARCH }} --tag ${{ env.TAG }} --system ${{ env.SYSTEM }} $FLAGS"
          bash packages/generate_package.sh -a ${{ env.ARCH }} --tag ${{ env.TAG }} --system ${{ env.SYSTEM }} $FLAGS

          PACKAGE_NAME=$(find /tmp -maxdepth 1 -type f -name *agent*.deb -exec basename {} 2>/dev/null \;| grep -v -E "^wazuh-agent-dbg")
          PACKAGE_SYMBOLS_NAME=$(find /tmp -maxdepth 1 -type f -name *agent*.deb -exec basename {} 2>/dev/null \;| grep -E "^wazuh-agent-dbg")

          echo "package-name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "package-symbols-name=$PACKAGE_SYMBOLS_NAME" >> $GITHUB_OUTPUT
          echo "version=${{ env.VERSION }}" >> $GITHUB_OUTPUT
          echo "container-name=${{ env.CONTAINER_NAME }}" >> $GITHUB_OUTPUT
          echo "tag=${{ env.TAG }}" >> $GITHUB_OUTPUT

      - name: Upload package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.package-name }}
          path: /tmp/${{ steps.build.outputs.package-name }}
          retention-days: 7

      - name: Upload debug symbols as artifact
        if: steps.build.outputs.package-symbols-name != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.package-symbols-name }}
          path: /tmp/${{ steps.build.outputs.package-symbols-name }}
          retention-days: 7

      - name: Upload checksums as artifacts
        if: inputs.checksum == true
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.package-name }}-checksums
          path: |
            /tmp/${{ steps.build.outputs.package-name }}.sha512
            /tmp/${{ steps.build.outputs.package-symbols-name }}.sha512
          retention-days: 7

  test-deb:
    needs: build-deb
    runs-on: ubuntu-latest
    timeout-minutes: 30
    name: Test DEB ${{ matrix.arch }} package
    strategy:
      matrix:
        arch: ${{ github.event_name == 'pull_request' && fromJSON('["amd64", "i386"]') || fromJSON(format('["{{0}}"]', inputs.architecture == 'x86_64' && 'amd64' || inputs.architecture)) }}
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get build outputs
        id: build-info
        run: |
          # Los outputs de jobs con matriz no están disponibles directamente
          # Usamos los nombres de artefactos construidos dinámicamente
          echo "ARCH=${{ matrix.arch }}" >> $GITHUB_ENV
          echo "SYSTEM=deb" >> $GITHUB_ENV

      - name: Download package artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "wazuh-agent*${{ matrix.arch }}*.deb"
          path: /tmp
          merge-multiple: true

      - name: Set PACKAGE_NAME from downloaded files
        run: |
          PACKAGE_NAME=$(find /tmp -maxdepth 1 -type f -name "wazuh-agent*${{ matrix.arch }}*.deb" -exec basename {} \; | grep -v -E "^wazuh-agent-dbg" | head -n 1)
          if [ -z "$PACKAGE_NAME" ]; then
            echo "No package found for ${{ matrix.arch }}!"
            exit 1
          fi
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV
          VERSION=$(echo $PACKAGE_NAME | grep -oP '\d+\.\d+\.\d+' | head -n 1)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "CONTAINER_NAME=pkg_deb_agent_builder_${{ matrix.arch }}" >> $GITHUB_ENV
          echo "TAG=$VERSION" >> $GITHUB_ENV

      - name: Download docker image for testing
        run: |
          bash .github/actions/ghcr-pull-and-push/pull_image_from_ghcr.sh ${{ secrets.CI_WAZUH_AGENT_PACKAGES_CLASSIC }} ${{ github.actor}} ${{ env.CONTAINER_NAME }} ${{ env.TAG }}

      - name: Test install package
        run: |
          TESTS_PATH=$GITHUB_WORKSPACE/.github/actions/test-install-components/
          if [ -z "${{ env.PACKAGE_NAME }}" ]; then
            echo "No package found!"
            exit 1
          fi
          sudo docker run \
            -v $TESTS_PATH/:/tests \
            -v /tmp/:/packages \
            -v /var/ossec:/var/ossec \
            -e ARCH="${{ env.ARCH }}" \
            -e SYSTEM="${{ env.SYSTEM }}" \
            --entrypoint '/tests/install_component.sh' \
            ${{ env.CONTAINER_NAME }}:${{ env.TAG }} \
            ${{ env.PACKAGE_NAME }} agent
          if grep -iq " installed.*wazuh-agent" /tmp/status.log ; then
            echo "Installation successfully."
          else
            echo "The installation could not be completed."
            exit 1
          fi

      - name: Test uninstall package
        uses: ./.github/actions/5_builderpackage_linux-smoke-uninstall-test
        with:
          tested_docker: "${{ env.CONTAINER_NAME }}:${{ env.TAG }}"

      - name: Get last stable version
        id: last-stable-version
        uses: ./.github/actions/5_builderpackage_get-last-stable-version
        with:
          repo_owner: wazuh
          repo_name: wazuh
          testing_version: ${{ env.VERSION }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get package url of the last stable version
        id: upgrade-package-url
        uses: ./.github/actions/5_builderpackage_get-upgrade-test-package-url
        with:
          component: agent
          os: linux
          system: ${{ env.SYSTEM }}
          version: ${{ steps.last-stable-version.outputs.latest_stable_version }}
          architecture: ${{ env.ARCH }}

      - name: Test upgrade from ${{ steps.last-stable-version.outputs.latest_stable_version }} to ${{ env.VERSION }}
        uses: ./.github/actions/5_builderpackage_linux-smoke-upgrade-test
        with:
          old_package_url: ${{ steps.upgrade-package-url.outputs.testing_package_url }}
          expected_upgrade_version: ${{ env.VERSION }}
          tested_docker: "${{ env.CONTAINER_NAME }}:${{ env.TAG }}"

  upload-deb-to-s3:
    needs: [build-deb, test-deb]
    if: success()
    runs-on: ubuntu-latest
    timeout-minutes: 15
    name: Upload DEB ${{ matrix.arch }} to S3
    strategy:
      matrix:
        arch: ${{ github.event_name == 'pull_request' && fromJSON('["amd64", "i386"]') || fromJSON(format('["{{0}}"]', inputs.architecture == 'x86_64' && 'amd64' || inputs.architecture)) }}
      fail-fast: false

    steps:
      - name: Download all artifacts for this architecture
        uses: actions/download-artifact@v4
        with:
          pattern: "*${{ matrix.arch }}*"
          path: /tmp
          merge-multiple: true

      - name: Set up AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.CI_INTERNAL_DEVELOPMENT_BUCKET_USER_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.CI_INTERNAL_DEVELOPMENT_BUCKET_USER_SECRET_KEY }}
          aws-region: ${{ secrets.CI_AWS_REGION }}

      - name: Find and upload packages to S3
        run: |
          S3_URI="s3://xdrsiem-packages-dev-internal/development/wazuh/5.x/main/packages"
          
          # Find and upload main package
          PACKAGE_NAME=$(find /tmp -maxdepth 1 -type f -name "wazuh-agent*${{ matrix.arch }}*.deb" -exec basename {} \; | grep -v -E "^wazuh-agent-dbg" | head -n 1)
          if [ -n "$PACKAGE_NAME" ] && [ -s "/tmp/$PACKAGE_NAME" ]; then
            aws s3 cp /tmp/$PACKAGE_NAME $S3_URI/
            echo "S3 URI: $S3_URI/$PACKAGE_NAME"
            
            # Upload checksum if exists
            if [ -s "/tmp/$PACKAGE_NAME.sha512" ]; then
              aws s3 cp /tmp/$PACKAGE_NAME.sha512 $S3_URI/
            fi
          else
            echo "Package file not found or empty."
            exit 1
          fi
          
          # Find and upload debug symbols
          SYMBOLS_NAME=$(find /tmp -maxdepth 1 -type f -name "wazuh-agent-dbg*${{ matrix.arch }}*.deb" -exec basename {} \; | head -n 1)
          if [ -n "$SYMBOLS_NAME" ] && [ -s "/tmp/$SYMBOLS_NAME" ]; then
            aws s3 cp /tmp/$SYMBOLS_NAME $S3_URI/
            echo "Uploaded debug symbols: $SYMBOLS_NAME"
            
            # Upload debug symbols checksum if exists
            if [ -s "/tmp/$SYMBOLS_NAME.sha512" ]; then
              aws s3 cp /tmp/$SYMBOLS_NAME.sha512 $S3_URI/
            fi
          fi
          S3_URI="s3://xdrsiem-packages-dev-internal/development/wazuh/5.x/main/packages"
          if [ -s "/tmp/$SYMBOLS_NAME.sha512" ]; then
            aws s3 cp /tmp/$SYMBOLS_NAME.sha512 $S3_URI/
          else
            echo "Warning: Debug symbols checksum file not found, skipping"
          fi

  # ===================== RPM JOBS =====================
  build-rpm:
    if: github.event_name == 'pull_request' || inputs.system == 'rpm'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    name: Build RPM ${{ matrix.arch }} package
    strategy:
      matrix:
        arch: ${{ github.event_name == 'pull_request' && fromJSON('["amd64", "i386"]') || fromJSON(format('["{{0}}"]', inputs.architecture == 'x86_64' && 'amd64' || inputs.architecture)) }}
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set ARCH
        id: set-arch
        run: |
          arch="${{ matrix.arch }}"
          echo "ARCH=$arch" >> $GITHUB_ENV
          echo "arch=$arch" >> $GITHUB_OUTPUT

      - name: Set VERSION and CONTAINER_NAME
        run: |
          VERSION="$(sed -n 's/.*"version"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p' VERSION.json)"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TAG=$VERSION" >> $GITHUB_ENV
          echo "CONTAINER_NAME=pkg_rpm_agent_builder_${{ env.ARCH }}" >> $GITHUB_ENV
          echo "SYSTEM=rpm" >> $GITHUB_ENV

      - name: Download docker image for package building
        run: |
          bash .github/actions/ghcr-pull-and-push/pull_image_from_ghcr.sh ${{ secrets.CI_WAZUH_AGENT_PACKAGES_CLASSIC }} ${{ github.actor}} ${{ env.CONTAINER_NAME }} ${{ env.TAG }}

      - name: Append short commit to VERSION file
        run: |
          SHORT_COMMIT=$(git rev-parse --short=7 HEAD)
          if [ -z "$SHORT_COMMIT" ]; then echo "No commit found"; exit 1; fi
          echo "Found commit: $SHORT_COMMIT"
          sed -i '/"stage":/s/$/,/; /"stage":/a \    "commit": "'"$SHORT_COMMIT"'"' VERSION.json || exit 1
          cat VERSION.json

      - name: Build RPM ${{ env.ARCH }} package
        id: build
        run: |
          REVISION=${{ inputs.revision || '0' }}
          FLAGS="--verbose -t agent -s /tmp --dont-build-docker -j $(nproc) "
          FLAGS+="-r $REVISION "
          if [ "${{ inputs.checksum }}" == "true" ]; then FLAGS+="--checksum "; fi
          if [ "${{ inputs.debug }}" == "true" ]; then FLAGS+="--debug "; fi
          echo "generate_package.sh -a ${{ env.ARCH }} --tag ${{ env.TAG }} --system ${{ env.SYSTEM }} $FLAGS"
          bash packages/generate_package.sh -a ${{ env.ARCH }} --tag ${{ env.TAG }} --system ${{ env.SYSTEM }} $FLAGS

          PACKAGE_NAME=$(find /tmp -maxdepth 1 -type f -name *agent*.rpm -exec basename {} 2>/dev/null \;| grep -v -E "^wazuh-agent-debuginfo")
          PACKAGE_SYMBOLS_NAME=$(find /tmp -maxdepth 1 -type f -name *agent*.rpm -exec basename {} 2>/dev/null \;| grep -E "^wazuh-agent-debuginfo")

          echo "package-name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "package-symbols-name=$PACKAGE_SYMBOLS_NAME" >> $GITHUB_OUTPUT
          echo "version=${{ env.VERSION }}" >> $GITHUB_OUTPUT
          echo "container-name=${{ env.CONTAINER_NAME }}" >> $GITHUB_OUTPUT
          echo "tag=${{ env.TAG }}" >> $GITHUB_OUTPUT

      - name: Upload package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.package-name }}
          path: /tmp/${{ steps.build.outputs.package-name }}
          retention-days: 7

      - name: Upload debug symbols as artifact
        if: steps.build.outputs.package-symbols-name != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.package-symbols-name }}
          path: /tmp/${{ steps.build.outputs.package-symbols-name }}
          retention-days: 7

      - name: Upload checksums as artifacts
        if: inputs.checksum == true
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.package-name }}-checksums
          path: |
            /tmp/${{ steps.build.outputs.package-name }}.sha512
            /tmp/${{ steps.build.outputs.package-symbols-name }}.sha512
          retention-days: 7

  test-rpm:
    needs: build-rpm
    runs-on: ubuntu-latest
    timeout-minutes: 30
    name: Test RPM ${{ matrix.arch }} package
    strategy:
      matrix:
        arch: ${{ github.event_name == 'pull_request' && fromJSON('["amd64", "i386"]') || fromJSON(format('["{{0}}"]', inputs.architecture == 'x86_64' && 'amd64' || inputs.architecture)) }}
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get build outputs
        id: build-info
        run: |
          echo "ARCH=${{ matrix.arch }}" >> $GITHUB_ENV
          echo "SYSTEM=rpm" >> $GITHUB_ENV

      - name: Download package artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "wazuh-agent*${{ matrix.arch }}*.rpm"
          path: /tmp
          merge-multiple: true

      - name: Set PACKAGE_NAME from downloaded files
        run: |
          PACKAGE_NAME=$(find /tmp -maxdepth 1 -type f -name "wazuh-agent*${{ matrix.arch }}*.rpm" -exec basename {} \; | grep -v -E "^wazuh-agent-debuginfo" | head -n 1)
          if [ -z "$PACKAGE_NAME" ]; then
            echo "No package found for ${{ matrix.arch }}!"
            exit 1
          fi
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV
          VERSION=$(echo $PACKAGE_NAME | grep -oP '\d+\.\d+\.\d+' | head -n 1)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "CONTAINER_NAME=pkg_rpm_agent_builder_${{ matrix.arch }}" >> $GITHUB_ENV
          echo "TAG=$VERSION" >> $GITHUB_ENV

      - name: Download docker image for testing
        run: |
          bash .github/actions/ghcr-pull-and-push/pull_image_from_ghcr.sh ${{ secrets.CI_WAZUH_AGENT_PACKAGES_CLASSIC }} ${{ github.actor}} ${{ env.CONTAINER_NAME }} ${{ env.TAG }}

      - name: Test install package
        run: |
          TESTS_PATH=$GITHUB_WORKSPACE/.github/actions/test-install-components/
          if [ -z "${{ env.PACKAGE_NAME }}" ]; then
            echo "No package found!"
            exit 1
          fi
          sudo docker run \
            -v $TESTS_PATH/:/tests \
            -v /tmp/:/packages \
            -v /var/ossec:/var/ossec \
            -e ARCH="${{ env.ARCH }}" \
            -e SYSTEM="${{ env.SYSTEM }}" \
            --entrypoint '/tests/install_component.sh' \
            ${{ env.CONTAINER_NAME }}:${{ env.TAG }} \
            ${{ env.PACKAGE_NAME }} agent
          if grep -iq " installed.*wazuh-agent" /tmp/status.log ; then
            echo "Installation successfully."
          else
            echo "The installation could not be completed."
            exit 1
          fi

      - name: Test uninstall package
        uses: ./.github/actions/5_builderpackage_linux-smoke-uninstall-test
        with:
          tested_docker: "${{ env.CONTAINER_NAME }}:${{ env.TAG }}"

      - name: Get last stable version
        id: last-stable-version
        uses: ./.github/actions/5_builderpackage_get-last-stable-version
        with:
          repo_owner: wazuh
          repo_name: wazuh
          testing_version: ${{ env.VERSION }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get package url of the last stable version
        id: upgrade-package-url
        uses: ./.github/actions/5_builderpackage_get-upgrade-test-package-url
        with:
          component: agent
          os: linux
          system: ${{ env.SYSTEM }}
          version: ${{ steps.last-stable-version.outputs.latest_stable_version }}
          architecture: ${{ env.ARCH }}

      - name: Test upgrade from ${{ steps.last-stable-version.outputs.latest_stable_version }} to ${{ env.VERSION }}
        uses: ./.github/actions/5_builderpackage_linux-smoke-upgrade-test
        with:
          old_package_url: ${{ steps.upgrade-package-url.outputs.testing_package_url }}
          expected_upgrade_version: ${{ env.VERSION }}
          tested_docker: "${{ env.CONTAINER_NAME }}:${{ env.TAG }}"

  upload-rpm-to-s3:
    needs: [build-rpm, test-rpm]
    if: success()
    runs-on: ubuntu-latest
    timeout-minutes: 15
    name: Upload RPM ${{ matrix.arch }} to S3
    strategy:
      matrix:
        arch: ${{ github.event_name == 'pull_request' && fromJSON('["amd64", "i386"]') || fromJSON(format('["{{0}}"]', inputs.architecture == 'x86_64' && 'amd64' || inputs.architecture)) }}
      fail-fast: false

    steps:
      - name: Download all artifacts for this architecture
        uses: actions/download-artifact@v4
        with:
          pattern: "*${{ matrix.arch }}*"
          path: /tmp
          merge-multiple: true

      - name: Set up AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.CI_INTERNAL_DEVELOPMENT_BUCKET_USER_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.CI_INTERNAL_DEVELOPMENT_BUCKET_USER_SECRET_KEY }}
          aws-region: ${{ secrets.CI_AWS_REGION }}

      - name: Find and upload packages to S3
        run: |
          S3_URI="s3://xdrsiem-packages-dev-internal/development/wazuh/5.x/main/packages"
          
          # Find and upload main package
          PACKAGE_NAME=$(find /tmp -maxdepth 1 -type f -name "wazuh-agent*${{ matrix.arch }}*.rpm" -exec basename {} \; | grep -v -E "^wazuh-agent-debuginfo" | head -n 1)
          if [ -n "$PACKAGE_NAME" ] && [ -s "/tmp/$PACKAGE_NAME" ]; then
            aws s3 cp /tmp/$PACKAGE_NAME $S3_URI/
            echo "S3 URI: $S3_URI/$PACKAGE_NAME"
            
            # Upload checksum if exists
            if [ -s "/tmp/$PACKAGE_NAME.sha512" ]; then
              aws s3 cp /tmp/$PACKAGE_NAME.sha512 $S3_URI/
            fi
          else
            echo "Package file not found or empty."
            exit 1
          fi
          
          # Find and upload debug symbols
          SYMBOLS_NAME=$(find /tmp -maxdepth 1 -type f -name "wazuh-agent-debuginfo*${{ matrix.arch }}*.rpm" -exec basename {} \; | head -n 1)
          if [ -n "$SYMBOLS_NAME" ] && [ -s "/tmp/$SYMBOLS_NAME" ]; then
            aws s3 cp /tmp/$SYMBOLS_NAME $S3_URI/
            echo "Uploaded debug symbols: $SYMBOLS_NAME"
            
            # Upload debug symbols checksum if exists
            if [ -s "/tmp/$SYMBOLS_NAME.sha512" ]; then
              aws s3 cp /tmp/$SYMBOLS_NAME.sha512 $S3_URI/
            fi
          fi
          S3_URI="s3://xdrsiem-packages-dev-internal/development/wazuh/5.x/main/packages"
          if [ -s "/tmp/$SYMBOLS_NAME.sha512" ]; then
            aws s3 cp /tmp/$SYMBOLS_NAME.sha512 $S3_URI/
          else
            echo "Warning: Debug symbols checksum file not found, skipping"
          fi
