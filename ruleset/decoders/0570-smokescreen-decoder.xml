<!--
###########################

- Smokescreen Deception decoder
- Author : Kaviarasan Asokan

###########################

Extracted Fields:

    - MITM decoder      : type, sub_type, kill_chain_phase, timestamp, decoy.ip, srcip, mitm.qtype, mitm.server, mitm.hostname, decoy.id, decoy.personality, decoy.name, decoy.group, decoy.type, decoy.network_name, decoy.vlan_id, decoy.appliance.id, decoy.appliance.name, attacker.name, attacker.id, decoy.client.id, decoy.client.name, mitre_ids, severity, score, threat_parse_ids, whitelisted, id, record_type, attacker.score, attacker.threat_parse_ids

    - Email decoder     : timestamp, attacker.id, attacker.name, email.subject, email.body.plain, email.body.attachments, decoy.id, decoy.name, decoy.group, decoy.type, type, kill_chain_phase, decoy.client.id, decoy.client.name, decoy.appliance.id, decoy.appliance.name, email.evidence_id

    - Endpoint decoder  : decoy.id, decoy.name, decoy.group, decoy.type, type, kill_chain_phase, sub_type, attacker.name, attacker.id, timestamp, decoy.client.id, decoy.client.name, decoy.appliance.id, decoy.appliance.name, attacker.process.id, attacker.process.tree, attacker.process.parent, attacker.process.user_name, attacker.process.domain_name, attacker.process.user_sid, attacker.process.name, attacker.process.command_line, attacker.process.exit_code, file.name, file.operation, srcip, mitre_ids, severity, score, threat_parse_ids, whitelisted, id, record_type, attacker.score, attacker.threat_parse_ids

###########################

Sample Logs: 
    
    - MITM decoder      : <9>1 2021-01-16T07:19:49.000Z bluebee-connector IllusionBLACK 953 2021-01-16T07:21:20.615862-mitm-92e5e499-687f-48a1-a8d8-1f67faf7257e - {"type":"mitm","sub_type":"mdns","kill_chain_phase":"Privilege Escalation","timestamp":"2021-01-16T07:19:49Z","decoy.ip":"10.10.10.100","attacker.ip":"10.10.10.101","mitm.qtype":"A","mitm.server":"10.10.10.101","mitm.hostname":"BLUEBEEMGMT2016","decoy.id":"2","decoy.personality":"Generic - Windows - Database","decoy.name":"MGMT2016SERVER","decoy.group":"Server Zone","decoy.type":"network","decoy.network_name":"VLAN 455","decoy.vlan_id":455,"decoy.appliance.id":"1","decoy.appliance.name":"bluebeesmokescreen","attacker.name":"10.10.10.101","attacker.id":"10.10.10.101","decoy.client.id":"bluebeesaturn","decoy.client.name":"bluebeesaturn","mitre_ids":["T1557.001"],"severity":"high","score":100,"threat_parse_ids":["mitm"],"whitelisted":false,"id":"2021-01-16T07:21:20.615862-mitm-92e5e499-687f-48a1-a8d8-1f67faf7257e","record_type":"event","attacker.score":200,"attacker.threat_parse_ids":["lm_mitm","mitm"]}

    - Email decoder     : <9>1 2021-01-16T04:44:44.000Z bluebee-connector IllusionBLACK 953 2021-01-16T04:45:02.454255-email-5d2380cd-6395-4611-85f3-54e1e4b36a18 - {"timestamp":"2021-01-16T04:44:44Z","attacker.id":"noreply@yammer.com","attacker.name":"BlueBee LLC on Yammer","email.subject":"New Company is started","email.body.plain":["\n==Updates from your Yammer communities==\n\n1 of your communities has new activity\n\n===All Company===\nIvy Arive - 08:44 AM - Aug 1\n08 Years of Service, Congratulations!!!"],"email.body.attachments":["s_0_3","r_0_3","s_0_4"],"decoy.id":"1","decoy.name":"Email Decoy","decoy.group":"Email","decoy.type":"email","type":"email","kill_chain_phase":"Exploitation","decoy.client.id":"bluebeesaturn","decoy.client.name":"bluebeesaturn","decoy.appliance.id":"bbm","decoy.appliance.name":"bbm","email.evidence_id":"15802"

    - Endpoint decoder  : <9>1 2021-01-16T08:02:48.000Z bluebee-connector IllusionBLACK 953 2021-01-16T08:02:42.830769-endpoint-61a2cd52-7b92-4b81-a120-f9468d47fb21 - {"decoy.id":"endpoint:"MGMT-AK2016","decoy.name":"MGMT-AK2016","decoy.group":"Endpoint","decoy.type":"endpoint","type":"endpoint","kill_chain_phase":"Data Theft","sub_type":"file","attacker.name":"MGMT-AK2016","attacker.id":"nt authority\\system","timestamp":"2021-01-16T08:02:48Z","decoy.client.id":"bluebeesaturn","decoy.client.name":"bluebeesaturn","decoy.appliance.id":"bbm","decoy.appliance.name":"bbm","attacker.process.id":5880,"attacker.process.tree":["bbagent.exe","services.exe","wininit.exe"],"attacker.process.parent":1000,"attacker.process.user_name":"SYSTEM","attacker.process.domain_name":"NT AUTHORITY","attacker.process.user_sid":"S-1-5-18","attacker.process.name":"bbagent.exe","attacker.process.command_line":"","attacker.process.exit_code":"-1","file.name":"c:\\users\\bluebeadmin\\data\\files\\credentials.docx","file.operation":"Read","attacker.ip":"10.10.100.100","mitre_ids":["T1005"],"severity":"high","score":75,"threat_parse_ids":["lm_file_open"],"whitelisted":false,"id":"2021-01-16T08:02:42.830769-endpoint-61a2cd52-7b92-4b81-a120-f9468d47fb21","record_type":"event","attacker.score":250,"attacker.threat_parse_ids":["lm_file_active_monitoring","lm_file_open","filetheft_unattend"]}

###########################
-->

<decoder name="smokescreen-deception">
    <prematch>\S+\s\S+\sIllusionBLACK</prematch>
</decoder>

<decoder name="smokescreen-extract">
   <parent>smokescreen-deception</parent>
   <regex>(\S+)T(\S+)\s(\S+)\s(IllusionBLACK)</regex>
   <order>Date, Time, Hostname, Device.Type</order>
</decoder>

<!--
    MITM decoder
-->
<decoder name="smokescreen-extract">
   <parent>smokescreen-deception</parent>
   <regex type="pcre2">"type":"(\S+)","sub_type":"(.*?)","kill_chain_phase":"(.*?)","timestamp":"(\S+)","decoy.ip":"(\S+)","attacker.ip":"(\S+)","mitm.qtype":"(\S+)","mitm.server":"(\S+)","mitm.hostname":"(\S+)","decoy.id":"(\S+)","decoy.personality":"(.*?)","decoy.name":"(.*?)","decoy.group":"(.*?)","decoy.type":"(\S+)","decoy.network_name":"(.*?)","decoy.vlan_id":(\d+),"decoy.appliance.id":"(\S+)","decoy.appliance.name":"(.*?)","attacker.name":"(\S+)","attacker.id":"(\S+)","decoy.client.id":"(.*?)","decoy.client.name":"(.*?)","mitre_ids":\["(.*?)"\],"severity":"(.*?)","score":(.*?),"threat_parse_ids":\["(.*?)"\],"whitelisted":(.*?),"id":"(.*?)","record_type":"(\S+)","attacker.score":(.*?),"attacker.threat_parse_ids":\[(.*?)\]</regex>
   <order>type, sub_type, kill_chain_phase, timestamp, decoy.ip, srcip, mitm.qtype, mitm.server, mitm.hostname, decoy.id, decoy.personality, decoy.name, decoy.group, decoy.type, decoy.network_name, decoy.vlan_id, decoy.appliance.id, decoy.appliance.name, attacker.name, attacker.id, decoy.client.id, decoy.client.name, mitre_ids, severity, score, threat_parse_ids, whitelisted, id, record_type, attacker.score, attacker.threat_parse_ids</order>
</decoder>

<!--
    Email decoder
-->

<decoder name="smokescreen-extract">
   <parent>smokescreen-deception</parent>
   <regex type="pcre2">"timestamp":"(\S+)","attacker.id":"(\S+)","attacker.name":"(.*?)","email.subject":"(.*?)","email.body.plain":\["(.*?)"\],"email.body.attachments":\[(.*?)\],"decoy.id":"(\S+)","decoy.name":"(.*?)","decoy.group":"(\S+)","decoy.type":"(\S+)","type":"(\S+)","kill_chain_phase":"(.*?)","decoy.client.id":"(\S+)","decoy.client.name":"(\S+)","decoy.appliance.id":"(\S+)","decoy.appliance.name":"(.*?)","email.evidence_id":"(.*?)"</regex>
   <order>timestamp, attacker.id, attacker.name, email.subject, email.body.plain, email.body.attachments, decoy.id, decoy.name, decoy.group, decoy.type, type, kill_chain_phase, decoy.client.id, decoy.client.name, decoy.appliance.id, decoy.appliance.name, email.evidence_id</order>
</decoder>

<!--
    Endpoint decoder
-->

<decoder name="smokescreen-extract">
    <parent>smokescreen-deception</parent>
    <regex type="pcre2">"decoy.id":"(\S+)","decoy.name":"(\S+)","decoy.group":"(\S+)","decoy.type":"(\S+)","type":"(\S+)","kill_chain_phase":"(.*?)","sub_type":"(\S+)","attacker.name":"(\S+)","attacker.id":"(.*?)","timestamp":"(.*?)","decoy.client.id":"(\S+)","decoy.client.name":"(\S+)","decoy.appliance.id":"(\S+)","decoy.appliance.name":"(\S+)","attacker.process.id":(\S+),"attacker.process.tree":\["(\S+)"\],"attacker.process.parent":(\S+),"attacker.process.user_name":"(\S+)","attacker.process.domain_name":"(.*?)","attacker.process.user_sid":"(\S+)","attacker.process.name":"(\S+)","attacker.process.command_line":"(\S*)","attacker.process.exit_code":"(\S+)","file.name":"(\S+)","file.operation":"(\S+)","attacker.ip":"(\S+)","mitre_ids":\["(\S+)"\],"severity":"(\S+)","score":(\S+),"threat_parse_ids":\["(\S+)"\],"whitelisted":(\S+),"id":"(\S+)","record_type":"(\S+)","attacker.score":(\S+),"attacker.threat_parse_ids":\["(\S+)"\]</regex>
    <order>decoy.id, decoy.name, decoy.group, decoy.type, type, kill_chain_phase, sub_type, attacker.name, attacker.id, timestamp, decoy.client.id, decoy.client.name, decoy.appliance.id, decoy.appliance.name, attacker.process.id, attacker.process.tree, attacker.process.parent, attacker.process.user_name, attacker.process.domain_name, attacker.process.user_sid, attacker.process.name, attacker.process.command_line, attacker.process.exit_code, file.name, file.operation, srcip, mitre_ids, severity, score, threat_parse_ids, whitelisted, id, record_type, attacker.score, attacker.threat_parse_ids</order>
 </decoder>