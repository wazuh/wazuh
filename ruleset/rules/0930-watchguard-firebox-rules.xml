<!--
  -  Decoders for watchguard-firebox
  -  Created by FMI Groupe (ph3nix, Orsiris de Jong) for Wazuh, Inc.
  -  Copyright (C) 2021, FMI Groupe, Wazuh Inc.
  -  This program is a free software; you can redistribute it and/or modify it under the terms of GPLv2.

   Changelog
   2021/09/14 - Orsiris de Jong - Revised some security alert levels, fix some typos, made unhandled logs rule work
   2021/07/08 - Orsiris de Jong - Added security event rules
                                - Added TSC compliance mapping
                                - Various sanitizations
   2021/07/05 - Orsiris de Jong - Added various correlation rules
                                - Added possible traffic and proxy rules
   2021/06/10 - Orsiris de Jong - Added various attack rules (port scan, ddos, ids, flooding, spoofing)
                                - Added possible tunnel attack rules high ICMP, DNS & NTP payloads
                                - Added multiple attack grouping
                                
   2021/04/21 - ph3nix          - Initial release
                                - Authentication, VPN and traffic rules
-->

<!-- Using ID range 91000-91500 -->

<!-- SETTING this to 1 fill filter FIN TCP connections that are very noisy -->
<var name="VERBOSE">0</var>

<!-- Which words are used in security event logs that should produce a warning -->
<var name="SIGD_BAD_WORDS">[Ff]ailed|crash|shutdown</var>

<group name="syslog,firewall,watchguard,watchguard-fw">
  <rule id="91000" level="0">
    <decoded_as>watchguard-firebox-firewall</decoded_as>
    <description>Grouping of Watchguard Firebox authentication rules</description>
  </rule>
  
  <!-- ## BASIC RULES ## -->
  
  <!-- startup / shutdown rules -->
  <rule id="91001" level="2">
    <if_sid>91000</if_sid>
    <id type="pcre2">3000-002[7|8]</id>
    <description>Watchguard: $(reason)</description>
  </rule>
 
  <!-- licence / features missing or malfunction-->
  <rule id="91002" level="12">
    <if_sid>91000</if_sid>
     <id type="pcre2">(3000-000[4|5])|3000-003A</id>
    <description>Watchguard: $(reason)</description>
  </rule>
  
  <!-- ## ATTACK DETECTION RULES ## -->
  
  <!-- Port scan & Syn flood -->
  <rule id="91011" level="6">
    <if_sid>91000</if_sid>
    <id type="pcre2">3000-0(159|162)</id>
    <description>Watchguard: $(reason) detected from $(srcip) to $(dstip)</description>
    <group>port_scan</group>
  </rule>
  
  <!-- DDoS to -->
  <rule id="91012" level="6">
    <if_sid>91000</if_sid>
    <id>3000-0160</id>
    <description>Watchguard: $(reason) detected against $(dstip)</description>
    <group>ddos</group>
  </rule>
  
  <!-- DDoS from -->
  <rule id="91013" level="6">
    <if_sid>91000</if_sid>
    <id>3000-0161</id>
    <description>Watchguard: $(reason) detected from $(dstip)</description>
    <group>ddos</group>
  </rule>
  
  <!-- Unwanted traffic rules -->
  <rule id="91014" level="5">
    <if_sid>91000</if_sid>
    <id>3000-0168</id>
    <description>Watchguard: Blocked site: Traffic detected from $(srcip) to $(dstip)</description>
    <group>unwanted_traffic,access_denied,pci_dss_10.2.4,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <rule id="91015" level="10" frequency="20" timeframe="300" ignore="90">
    <if_matched_sid>91014</if_matched_sid>
    <same_srcip />
    <description>Watchguard: Blocked site: Recidiving traffic received from $(srcip)</description>
    <group>unwanted_traffic,access_denied,pci_dss_10.2.4,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <rule id="91016" level="6">
    <if_sid>91000</if_sid>
    <id>3000-0169</id>
    <description>Watchguard: IP spoofing: Traffic detected from $(srcip) to $(dstip)</description>
    <group>unwanted_traffic,access_denied,pci_dss_10.2.4,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <rule id="91017" level="10" frequency="20" timeframe="300" ignore="90">
    <if_matched_sid>91016</if_matched_sid>
    <same_srcip />
    <description>Watchguard: IP spoofing: Recidiving traffic received from $(srcip)</description>
    <group>unwanted_traffic,access_denied,pci_dss_10.2.4,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <rule id="91018" level="6">
    <if_sid>91000</if_sid>
    <id>3000-0172</id>
    <description>Watchguard: Blocked port: Traffic detected from $(srcip) to $(dstip) on port $(dstport)</description>
    <group>unwanted_traffic,access_denied,pci_dss_10.2.4,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <rule id="91019" level="10" frequency="20" timeframe="300" ignore="90">
    <if_matched_sid>91018</if_matched_sid>
    <same_srcip />
    <description>Watchguard: Blocked port: Recidiving traffic received from $(srcip)</description>
    <group>unwanted_traffic,access_denied,pci_dss_10.2.4,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <!-- correlation rule for unwanted traffic -->
  <rule id="91020" level="14" frequency="10" timeframe="240" ignore="90">
    <if_matched_group>unwanted_traffic</if_matched_group>
    <description>Watchguard: Multiple unwanted traffic received. Possible attack ongoing</description>
    <group>unwanted_traffic,access_denied,pci_dss_10.2.4,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <rule id="91021" level="12">
    <if_sid>91000</if_sid>
    <id>3000-012C</id>
    <description>Watchguard: ARP spoofing attack detected, ip=$(srcip), mac=$(srcmac), interface=$(src)</description>
    <group>spoofing,pci_dss_10.6.1,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <rule id="91022" level="14">
    <if_matched_sid>91021</if_matched_sid>
    <description>Watchguard: Multiple ARP spoofing attacks detected. Possible attack ongoing</description>
    <group>spoofing,pci_dss_10.6.1,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <rule id="91023" level="12">
    <if_sid>91000</if_sid>
    <id>3000-012E</id>
    <description>Watchguard: Cannot relearn system MAC address, possible loop or MAC spoofing, ip=$(srcip), mac=$(srcmac), interface=$(src)</description>
    <group>spoofing,pci_dss_10.6.1,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <rule id="91024" level="14">
    <if_matched_sid>91023</if_matched_sid>
    <description>Watchguard: Multiple possible loops or MAC spoofing. Possible attack ongoing</description>
    <group>spoofing,pci_dss_10.6.1,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <!-- ## DIAGNOSTIC RULES ## -->
  <rule id="91040" level="7">
    <if_sid>91000</if_sid>
    <id type="pcre2">3000-00C[9|B]</id>
    <description>Watchguard: Load Balance Server $(dstip) is offline, protocol $(protocol)</description>
    <group>service_availability,pci_dss_10.6.1,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <rule id="91041" level="7">
    <if_sid>91000</if_sid>
    <id type="pcre2">4900-0001</id>
    <description>Watchguard: Link Monitor: $(src) unable to resolve domain name $(dst)</description>
    <group>service_availability,pci_dss_10.6.1,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <rule id="91042" level="7">
    <if_sid>91000</if_sid>
    <id type="pcre2">4900-0002</id>
    <description>Watchguard: Link Monitor: No response received on $(src) from $(protocol) host $(dstip) $(dstport)</description>
    <group>service_availability,pci_dss_10.6.1,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <rule id="91043" level="7">
    <if_sid>91000</if_sid>
    <id type="pcre2">4900-0003</id>
    <description>Watchguard: Link Monitor: $(src) interface $(reason)</description>
    <group>service_availability,pci_dss_10.6.1,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <!-- ## BLOCKED SITE NORMAL OPERATIONS ## -->
  <rule id="91050" level="3">
    <if_sid>91000</if_sid>
    <id>3000-0029</id>
    <description>Watchguard: $(srcip) will not be added to the blocked sites list because it is exempt</description>
  </rule>
  
  <rule id="91051" level="3">
    <if_sid>91000</if_sid>
    <id>3000-0040</id>
    <description>Watchguard: Idle timeout has occurred for blocked site $(srcip)</description>
  </rule>
 
  <rule id="91052" level="13">
    <if_sid>91000</if_sid>
    <id>3001-1002</id>
    <description>Watchguard: The Temporary Blocked Sites list is full (capacity=1000). The oldest entry $(srcip) was removed</description>
    <group>unwanted_traffic,access_denied,pci_dss_10.2.4,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <rule id="91053" level="14" frequency="5" timeframe="300" ignore="90">
    <if_matched_sid>91052</if_matched_sid>
    <description>Watchguard: The Temporary Blocked Sites list cannot hold all the blocked sites. Probable DDoS attack ongoing</description>
    <group>unwanted_traffic,access_denied,pci_dss_10.2.4,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
    <group>ddos</group>
  </rule>
 
  <rule id="91054" level="6">
    <if_sid>91000</if_sid>
    <id>3001-1001</id>
    <description>Watchguard: Temporarily blocking host $(srcip) - $(reason)</description>
    <group>unwanted_traffic,access_denied,pci_dss_10.2.4,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <rule id="91055" level="14" frequency="10" timeframe="240" ignore="90">
    <if_matched_sid>91054</if_matched_sid>
    <description>Watchguard: Multiple blocked hosts in short timespan. Probable DDoS attack ongoing</description>
    <group>unwanted_traffic,access_denied,pci_dss_10.2.4,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
    <group>ddos</group>
  </rule>
  
  <!-- ## PACKET FILTER RULES ## -->
  
  <!-- Normal allowed traffic -->
  <!-- For the sake of disk space, we will match Allow packets with level 0 NOOK nolaert -->
  <rule id="91060" level="$VERBOSE">
    <if_sid>91000</if_sid>
    <id>3000-0148</id>
    <action type="pcre2">[Aa]llow</action>
    <description>Watchguard: firewall: $(action) $(src) $(dst) packetlen=$(packetlen) $(protocol) iphlen=$(iphlen) ttl=$(ttl) from $(srcip):$(srcport) to $(dstip):$(dstport) - $(reason)</description>
    <group>packet_filter</group>
  </rule>

  <!-- layer 2 denied traffic / don't bother to keep, so set level=0 -->
  <rule id="91061" level="0">
    <if_sid>91000</if_sid>
    <id>3000-0148</id>
    <action type="pcre2">[Dd]eny</action>
    <match type="pcre2">0.0.0.0\s0.0.0.0\s</match>
    <description>Watchguard: firewall: Layer2 $(action) $(src) $(dst) packetlen=$(packetlen) $(protocol) iphlen=$(iphlen) ttl=$(ttl) from $(srcip):$(srcport) to $(dstip):$(dstport) - $(reason)</description>
    <group>packet_filter</group>
  </rule>
 
  <!-- Normal denied traffic -->
  <rule id="91062" level="5">
    <if_sid>91000</if_sid>
    <id>3000-0148</id>
    <action type="pcre2">[Dd]eny</action>
	<match type="pcre2" negate="yes">0.0.0.0\s0.0.0.0\s</match>
    <description>Watchguard: firewall: $(action) $(src) $(dst) packetlen=$(packetlen) $(protocol) iphlen=$(iphlen) ttl=$(ttl) from $(srcip):$(srcport) to $(dstip):$(dstport) - $(reason)</description>
    <group>packet_filter,packet_filter_deny</group>
  </rule>
  
    <!-- allowed App Control -->
  <rule id="91063" level="0">
    <if_sid>91000</if_sid>
    <id>3000-0149</id>
    <action type="pcre2">[Aa]llow</action>
    <description>Watchguard: App control: $(action) $(src) $(dst) packetlen=$(packetlen) $(protocol) iphlen=$(iphlen) ttl=$(ttl) from $(srcip):$(srcport) to $(dstip):$(dstport) - $(reason)</description>
    <group>packet_filter,app_control</group>
  </rule>
  
    <!--denied  App Control -->
  <rule id="91064" level="5">
    <if_sid>91000</if_sid>
    <id>3000-0149</id>
    <action type="pcre2">[Dd]eny</action>
    <description>Watchguard: App control: $(action) $(src) $(dst) packetlen=$(packetlen) $(protocol) iphlen=$(iphlen) ttl=$(ttl) from $(srcip):$(srcport) to $(dstip):$(dstport) - $(reason)</description>
    <group>packet_filter,packet_filter_deny,app_control</group>
  </rule>
  
  <!-- allowed IPS Traffic -->
  <rule id="91065" level="0">
    <if_sid>91000</if_sid>
    <id>3000-0150</id>
    <action type="pcre2">[Aa]llow</action>
    <description>Watchguard: App control: $(action) $(src) $(dst) packetlen=$(packetlen) $(protocol) iphlen=$(iphlen) ttl=$(ttl) from $(srcip):$(srcport) to $(dstip):$(dstport) - $(reason)</description>
    <group>packet_filter,ips</group>
  </rule>
  
  <!-- denied IPS Traffic -->
  <rule id="91066" level="6">
    <if_sid>91000</if_sid>
    <id>3000-0150</id>
    <action type="pcre2">[Dd]eny</action>
    <description>Watchguard: App control: $(action) $(src) $(dst) packetlen=$(packetlen) $(protocol) iphlen=$(iphlen) ttl=$(ttl) from $(srcip):$(srcport) to $(dstip):$(dstport) - $(reason)</description>
    <group>packet_filter,packet_filter_deny,ips</group>
  </rule>
  
  <!-- Multiple denied generic traffic -->
  <rule id="91067" level="10" frequency="5" timeframe="300">
    <if_matched_group>packet_filter_deny</if_matched_group>
    <same_srcip />
    <description>Watchguard: firewall: Multiple denied traffic from same source $(srcip)</description>
    <group>firewall,access_denied,pci_dss_10.2.4,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <!-- Traffic connection terminated, very verbose, hence noalert -->
  <rule id="91068" level="$VERBOSE">
    <if_sid>91000</if_sid>
    <id>3000-0151</id>
    <description>Watchguard: firewall: Traffic connection terminated: $(action) $(src) $(dst)  $(protocol) from $(srcip):$(srcport) to $(dstip):$(dstport) - $(reason)</description>
    <group>firewall</group>
  </rule>
  
  <!-- Hostile traffic -->
  <rule id="91069" level="9">
    <if_sid>91000</if_sid>
    <id>3000-0173</id>
    <description>Watchguard: firewall: Hostile traffic $(action) $(src) $(dst) packetlen=$(packetlen) $(protocol) iphlen=$(iphlen) ttl=$(ttl) from $(srcip):$(srcport) to $(dstip):$(dstport) - $(reason)</description>
    <group>firewall</group>
  </rule>
  
  <!-- Multiple hostile traffic -->
  <rule id="91070" level="13" frequency="10" timeframe="240" ignore="90">
    <if_matched_sid>91069</if_matched_sid>
    <same_srcip />
    <description>Watchguard: firewall: Multiple hostile traffic from same source</description>
    <group>firewall,access_denied,pci_dss_10.2.4,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <!-- ICMP hidden tunnel detection when too much packets are larger than standard ICMP packet size

Generic ping max packet size calculation
PING = 56 + 40 + 8 = 104
Windows ping packet size is smaller than on linux, hence we'll use the latter
Default linux ping packet size + IPv6 Header + ICMP Header

2021 Mar 21 22:01:42 FW-125852->192.168.100.254 Mar 21 23:01:42 FW-125852 FVE1032175935 firewall: msg_id="3000-0148" Allow Trusted Firebox 1300 icmp 20 128 192.168.100.99 192.168.100.254 8 0 id=1 seq=2  (Ping-00)
2021 Mar 21 22:01:42 FW-125852->192.168.100.254 Mar 21 23:01:42 FW-125852 FVE1032175935 firewall: msg_id="3000-0148" Allow Trusted Firebox 60 icmp 20 128 192.168.100.99 192.168.100.254 8 0 id=1 seq=2  (Ping-00)
-->
  <rule id="91080" level="8">
    <if_sid>91060</if_sid>
    <protocol>icmp</protocol>
    <field name="packetlen" type="pcre2">([0-9]{4,}|[1-9]0[5-9]|1[1-9][0-9]|[2-9][0-9]{2})</field>
    <description>Watchguard: firewall: $(action) from $(srcip) to $(dstip) using protocol $(protocol) [icmp] packet size is bigger than usual: $(packetlen)</description>
  </rule>
  
  <rule id="91081" level="13" frequency="10" timeframe="240" ignore="90">
    <if_matched_sid>91080</if_matched_sid>
    <same_srcip />
    <description>Watchguard: firewall: Possible $(protocol) tunnel attack from $(srcip) on interface $(src) to $(dstip) on interface $(dst)</description>
    <group>hidden_tunnel,pci_dss_10.6.1,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC7.2,tsc_CC7.3,tsc_CC6.1,tsc_CC6.8,</group>
  </rule>
  
   <!--DNS hidden tunnel detection when too much packets are larger than standard DNS request size
  
IPv4 request size = 112 
Adding IPv6 20 bytes header = 112 + 20 = 132
Domain names are max 63 characters
(63 letters).(63 letters).(63 letters).(62 letters) = 260 IPv4 (FQDN max length)
https://devblogs.microsoft.com/oldnewthing/20120412-00/?p=7873

Mar 21 23:43:20 FW-125852 FVE1032175935 firewall: msg_id="3000-0148" Allow Firebox External 156 udp 20 64 10.0.1.2 213.133.99.99 47189 53  (Any From Firebox-00)
Mar 21 23:47:28 FW-125852 FVE1032175935 firewall: msg_id="3000-0148" Allow Firebox External 60 udp 20 64 fe80::20c:29ff:fe59:7afa ac::d0:::1 47189 53  (Any From Firebox-00)
-->

  <rule id="91082" level="8">
    <if_sid>91060</if_sid>
    <dstport>53</dstport>
    <field name="packetlen" type="pcre2">([0-9]{4,}|[1-9]3[3-9]|1[4-9][0-9]|[2-9][0-9]{2})</field>
    <description>Watchguard: firewall: $(action) from $(srcip) to $(dstip) using protocol $(protocol):$(dstport) [dns] packet size is bigger than usual: $(packetlen)</description>
  </rule>
  
  <rule id="91083" level="13" frequency="10" timeframe="240" ignore="90">
    <if_matched_sid>91082</if_matched_sid>
    <same_srcip />
    <description>Watchguard: firewall: Possible $(protocol) tunnel attack from $(srcip) on interface $(src) to $(dstip) on interface $(dst)</description>
    <group>hidden_tunnel,pci_dss_10.6.1,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC7.2,tsc_CC7.3,tsc_CC6.1,tsc_CC6.8,</group>
  </rule>

  <!--NTP hidden tunnel detection when too much packets are larger than standard NTP packet size

NTP request size IPv4 = 76
Adding IPv6 20 bytes header = 76 + 20 = 96

Apr 15 12:10:53 FW-125852 FVE1032175935 firewall: msg_id="3000-0148" Allow Trusted External 176 udp 20 63 192.168.100.250 162.159.200.123 48216 123  (Outgoing-00)
Apr 15 12:10:53 FW-125852 FVE1032175935 firewall: msg_id="3000-0148" Allow Trusted External 76 udp 20 63 fe80::20c:29ff:fe59:7afa ac::d0:::1 48216 123  (Outgoing-00)
-->

  <rule id="91084" level="8">
    <if_sid>91060</if_sid>
    <dstport>123</dstport>
    <field name="packetlen" type="pcre2">([1-9][0-9]{2,}|[2-9][0-9]|1[0-9])[0-9]{1}|([9-9][7-9])</field>
    <description>Watchguard: firewall: $(action) from $(srcip) to $(dstip) using protocol $(protocol):$(dstport) [ntp] packet size is bigger than usual: $(packetlen)</description>
  </rule>
  
  <rule id="91085" level="13" frequency="10" timeframe="240" ignore="90">
    <if_matched_sid>91084</if_matched_sid>
    <same_srcip />
    <description>Watchguard: firewall: Possible $(protocol) tunnel attack from $(srcip) on interface $(src) to $(dstip) on interface $(dst)</description>
    <group>hidden_tunnel,pci_dss_10.6.1,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC7.2,tsc_CC7.3,tsc_CC6.1,tsc_CC6.8,</group>
  </rule>

  <rule id="91086" level="14" frequency="3" timeframe="240" ignore="90">
    <if_matched_group>hidden_tunnel</if_matched_group>
    <description>Watchguard: Possible multiple tunnel attacks ongoing. Please have a look</description>
    <group>pci_dss_10.6.1,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC7.2,tsc_CC7.3,tsc_CC6.1,tsc_CC6.8,</group>
  </rule>

    
  <!-- ## PROXY FILTER RULES ## -->
  
  <!-- allowed proxy traffic is level 0 for disk space reasons -->
  <rule id="91090" level="$VERBOSE">
    <if_sid>91000</if_sid>
    <id type="pcre2">[1-2][0-9A-F]FF-[0-F]{4}</id>
    <action type="pcre2">[Aa]llow</action>
    <description>Watchguard: proxy: $(action) from $(src) to $(dst), $(protocol) from $(srcip):$(srcport) to $(dstip):$(dstport) - $(reason)</description>
    <group>proxy</group>
  </rule>
  
  <!-- denied proxy traffic -->
  <rule id="91091" level="5">
    <if_sid>91000</if_sid>
    <id type="pcre2">[1-2][0-9A-F]FF-[0-F]{4}</id>
    <action type="pcre2">[Dd]eny</action>
    <description>Watchguard: proxy: $(action) from $(src) to $(dst), $(protocol) from $(srcip):$(srcport) to $(dstip):$(dstport) - $(reason)</description>
    <group>proxy</group>
  </rule>
  
  <!-- Multiple denied proxy traffic -->
  <rule id="91092" level="10" frequency="10" timeframe="240" ignore="90">
    <if_matched_sid>91091</if_matched_sid>
    <same_srcip />
    <description>Watchguard: proxy: Multiple denied traffic from same source $(srcip) on interface $(src)</description>
    <group>proxy,access_denied,pci_dss_10.2.4,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <!-- Possible DDoS or botnet attack -->
  <rule id="91093" level="14" frequency="3" timeframe="240" ignore="90">
    <if_matched_sid>91092</if_matched_sid>
    <description>Watchguard: proxy: Multiple recidiving traffic sent from same sources. Possible DDoS attack</description>
    <group>proxy,ids,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <!-- APT THREAT -->
  <rule id="91030" level="6">
    <if_sid>91000</if_sid>
    <id>0F01-0015</id>
    <description>Watchguard: $(reason) from $(srcip):$(srcport) to $(dstip):$(dstport) - $(data)</description>
    <group>ids,pci_dss_11.4,gpg13_4.12,gdpr_IV_35.7.d,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <!-- ## UNHANDLED LOGS -->
  <rule id="91100" level="1">
    <if_sid>91000</if_sid>
    <description>Watchguard: Unhandled $(id) log recorded</description>
    <group>firewall</group>
  </rule>
  

</group>

<group name="syslog,watchguard,watchguard-auth">
  <rule id="91200" level="0">
    <decoded_as>watchguard-firebox-auth</decoded_as>
    <description>Grouping of Watchguard Firebox firewall rules</description>
  </rule>
  
  <rule id="91201" level="5">
    <if_sid>91200</if_sid>
    <id type="pcre2">1100-0005|5000-0001</id>
    <action>rejected</action>
    <description>Watchguard: $(account_type) $(srcuser) login $(action) from $(srcip) - $(reason)</description>
    <mitre>
      <id>T1133</id>
    </mitre>
    <group>wg_userloginfailed,authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,gpg13_7.8,gdpr_IV_35.7.d,gdpr_IV_32.2,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
  
  <rule id="91202" level="10" frequency="5" timeframe="60" ignore="30">
    <if_matched_sid>91201</if_matched_sid>
    <same_source_ip/>
    <description>Watchguard: Multiple $(action) login for $(account_type) $(srcuser) from $(srcip) - $(reason)</description>
    <mitre>
      <id>T1110</id>
      <id>T1133</id>
    </mitre>
    <group>wg_loginforce,authentication_failures,pci_dss_10.2.4,pci_dss_10.2.5,gpg13_7.8,gdpr_IV_35.7.d,gdpr_IV_32.2,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3</group>
  </rule>

  <rule id="91205" level="3">
    <if_sid>91200</if_sid>
    <id>3E00-0002</id>
    <action>logged in</action>
    <field name="account_type" negate="yes">SSL VPN</field>
    <description>Watchguard: $(account_type) $(srcuser) login $(action) from $(srcip)</description>
    <mitre>
      <id>T1078</id>
      <id>T1133</id>
    </mitre>
    <group>wg_loginsuccess,authentication_success,pci_dss_10.2.5,gpg13_7.8,gdpr_IV_32.2,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <rule id="91206" level="3">
    <if_sid>91200</if_sid>
    <id>2500-0000</id>
    <action>logged in</action>
    <description>Watchguard: Mobile VPN user $(srcuser) login $(action) from $(srcip) - Virtual IP is $(dstip)</description>
    <mitre>
      <id>T1078</id>
      <id>T1133</id>
    </mitre>
    <group>wg_vpnloginsuccess,authentication_success,pci_dss_10.2.5,gpg13_7.8,gdpr_IV_32.2,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>

  <rule id="91207" level="5">
    <if_sid>91200</if_sid>
    <id>SSL VPN</id>
    <action>rejected</action>
    <description>Watchguard: SSL VPN user $(srcuser) connection $(action) from $(srcip) - $(reason)</description>
    <mitre>
      <id>T1133</id>
    </mitre>
    <group>wg_vpnloginfailed,authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,gpg13_7.8,gdpr_IV_35.7.d,gdpr_IV_32.2,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
  </rule>
</group>

<group name="syslog,watchguard,watchguard-sigd">
  <rule id="91300" level="0">
    <decoded_as>watchguard-firebox-sigd</decoded_as>
    <description>Grouping of Watchguard Firebox security event rules</description>
  </rule>
  
  <!-- msg_id does not allow to determine the security event log level, hence we cannot decide of a reasonable alert level easily, we need to match keywords -->
  <rule id="91301" level="7">
    <if_sid>91300</if_sid>
    <match type="pcre2">$SIGD_BAD_WORDS</match>
    <description>Watchguard: Security event ERROR: $(reason)</description>
    <group>system_error,pci_dss_10.6.1,pci_dss_11.4,gpg13_4.3,gdpr_IV_35.7.d,tsc_CC7.2,tsc_CC7.3,tsc_CC6.1,tsc_CC6.8,</group>
    <mitre>
      <id>T1489</id>
    </mitre>
  </rule>

  <rule id="91302" level="3">
    <if_sid>91300</if_sid>
    <description>Watchguard: Security event: $(reason)</description>
  </rule>
</group>
 
