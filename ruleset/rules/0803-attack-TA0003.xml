<!--
  -  Grouping of TA0003 "Persistence" rules
  -  Author: Fabricio Brunetti
  -  Updated by Wazuh, Inc.
  -  Copyright (C) 2015-2021, Wazuh Inc.
  -  This program is a free software; you can redistribute it and/or modify it under the terms of GPLv2.
-->

<!-- Sample: {"win":{"eventdata":{"subjectLogonId":"0x0","targetLinkedLogonId":"0x0","impersonationLevel":"%%1833","ipAddress":"192.168.0.121","authenticationPackageName":"Kerberos","targetLogonId":"0x4cdcc9","logonProcessName":"Kerberos","logonGuid":"{C9208622-EB82-7047-0ED5-5FF1F674AC82}","targetUserName":"Administrator","keyLength":"0","elevatedToken":"%%1842","subjectUserSid":"S-1-0-0","processId":"0x0","ipPort":"49791","targetDomainName":"EXCHANGETEST.COM","targetUserSid":"S-1-5-21-887924094-598891991-956377308-500","virtualAccount":"%%1843","logonType":"3"},"system":{"eventID":"4624","keywords":"0x8020000000000000","providerGuid":"{54849625-5478-4994-A5BA-3E3B0328C30D}","level":"0","channel":"Security","opcode":"0","message":"\"An account was successfully logged on.\r\n\r\nSubject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nLogon Information:\r\n\tLogon Type:\t\t3\r\n\tRestricted Admin Mode:\t-\r\n\tVirtual Account:\t\tNo\r\n\tElevated Token:\t\tYes\r\n\r\nImpersonation Level:\t\tImpersonation\r\n\r\nNew Logon:\r\n\tSecurity ID:\t\tS-1-5-21-887924094-598891991-956377308-500\r\n\tAccount Name:\t\tAdministrator\r\n\tAccount Domain:\t\tEXCHANGETEST.COM\r\n\tLogon ID:\t\t0x4CDCC9\r\n\tLinked Logon ID:\t\t0x0\r\n\tNetwork Account Name:\t-\r\n\tNetwork Account Domain:\t-\r\n\tLogon GUID:\t\t{C9208622-EB82-7047-0ED5-5FF1F674AC82}\r\n\r\nProcess Information:\r\n\tProcess ID:\t\t0x0\r\n\tProcess Name:\t\t-\r\n\r\nNetwork Information:\r\n\tWorkstation Name:\t\r\n\tSource Network Address:\t192.168.0.121\r\n\tSource Port:\t\t49791\r\n\r\nDetailed Authentication Information:\r\n\tLogon Process:\t\tKerberos\r\n\tAuthentication Package:\tKerberos\r\n\tTransited Services:\t-\r\n\tPackage Name (NTLM only):\t-\r\n\tKey Length:\t\t0\r\n\r\nThis event is generated when a logon session is created. It is generated on the computer that was accessed.\r\n\r\nThe subject fields indicate the account on the local system which requested the logon. This is most commonly a service such as the Server service, or a local process such as Winlogon.exe or Services.exe.\r\n\r\nThe logon type field indicates the kind of logon that occurred. The most common types are 2 (interactive) and 3 (network).\r\n\r\nThe New Logon fields indicate the account for whom the new logon was created, i.e. the account that was logged on.\r\n\r\nThe network fields indicate where a remote logon request originated. Workstation name is not always available and may be left blank in some cases.\r\n\r\nThe impersonation level field indicates the extent to which a process in the logon session can impersonate.\r\n\r\nThe authentication information fields provide detailed information about this specific logon request.\r\n\t- Logon GUID is a unique identifier that can be used to correlate this event with a KDC event.\r\n\t- Transited services indicate which intermediate services have participated in this logon request.\r\n\t- Package name indicates which sub-protocol was used among the NTLM protocols.\r\n\t- Key length indicates the length of the generated session key. This will be 0 if no session key was requested.\"","version":"2","systemTime":"2021-05-07T21:36:19.887424400Z","eventRecordID":"1718492","threadID":"1776","computer":"bankdc.ExchangeTest.com","task":"12544","processID":"536","severityValue":"AUDIT_SUCCESS","providerName":"Microsoft-Windows-Security-Auditing"}}} -->
<group name="TA0003,">
    <rule id="92035" level="6">
        <if_sid>60106</if_sid>
        <field name="win.eventdata.ipAddress" type="pcre2">(?:[0-9]{1,3}\.){3}[0-9]{1,3}</field>
        <field name="win.eventdata.ipAddress" type="pcre2" negate="yes">127\.0\.0\.1</field>
        <description>Successful Remote Logon Detected</description>
        <mitre>
            <id>T1078</id>
        </mitre>
        <group>authentication_success,pci_dss_10.2.5,gpg13_7.1,gpg13_7.2,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_AU.14,nist_800_53_AC.7,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"subjectLogonId":"0x0","targetLinkedLogonId":"0x0","impersonationLevel":"%%1833","ipAddress":"192.168.0.218","authenticationPackageName":"NTLM","lmPackageName":"NTLM V2","targetLogonId":"0x30ad3c7","logonProcessName":"NtLmSsp","logonGuid":"{00000000-0000-0000-0000-000000000000}","targetUserName":"Administrator","keyLength":"128","elevatedToken":"%%1842","subjectUserSid":"S-1-0-0","processId":"0x0","ipPort":"51588","targetDomainName":"EXCHANGETEST","targetUserSid":"S-1-5-21-887924094-598891991-956377308-500","virtualAccount":"%%1843","logonType":"3"},"system":{"eventID":"4624","keywords":"0x8020000000000000","providerGuid":"{54849625-5478-4994-A5BA-3E3B0328C30D}","level":"0","channel":"Security","opcode":"0","message":"\"An account was successfully logged on.\r\n\r\nSubject:\r\n\tSecurity ID:\t\tS-1-0-0\r\n\tAccount Name:\t\t-\r\n\tAccount Domain:\t\t-\r\n\tLogon ID:\t\t0x0\r\n\r\nLogon Information:\r\n\tLogon Type:\t\t3\r\n\tRestricted Admin Mode:\t-\r\n\tVirtual Account:\t\tNo\r\n\tElevated Token:\t\tYes\r\n\r\nImpersonation Level:\t\tImpersonation\r\n\r\nNew Logon:\r\n\tSecurity ID:\t\tS-1-5-21-887924094-598891991-956377308-500\r\n\tAccount Name:\t\tAdministrator\r\n\tAccount Domain:\t\tEXCHANGETEST\r\n\tLogon ID:\t\t0x30AD3C7\r\n\tLinked Logon ID:\t\t0x0\r\n\tNetwork Account Name:\t-\r\n\tNetwork Account Domain:\t-\r\n\tLogon GUID:\t\t{00000000-0000-0000-0000-000000000000}\r\n\r\nProcess Information:\r\n\tProcess ID:\t\t0x0\r\n\tProcess Name:\t\t-\r\n\r\nNetwork Information:\r\n\tWorkstation Name:\t\r\n\tSource Network Address:\t192.168.0.218\r\n\tSource Port:\t\t51588\r\n\r\nDetailed Authentication Information:\r\n\tLogon Process:\t\tNtLmSsp \r\n\tAuthentication Package:\tNTLM\r\n\tTransited Services:\t-\r\n\tPackage Name (NTLM only):\tNTLM V2\r\n\tKey Length:\t\t128\r\n\r\nThis event is generated when a logon session is created. It is generated on the computer that was accessed.\r\n\r\nThe subject fields indicate the account on the local system which requested the logon. This is most commonly a service such as the Server service, or a local process such as Winlogon.exe or Services.exe.\r\n\r\nThe logon type field indicates the kind of logon that occurred. The most common types are 2 (interactive) and 3 (network).\r\n\r\nThe New Logon fields indicate the account for whom the new logon was created, i.e. the account that was logged on.\r\n\r\nThe network fields indicate where a remote logon request originated. Workstation name is not always available and may be left blank in some cases.\r\n\r\nThe impersonation level field indicates the extent to which a process in the logon session can impersonate.\r\n\r\nThe authentication information fields provide detailed information about this specific logon request.\r\n\t- Logon GUID is a unique identifier that can be used to correlate this event with a KDC event.\r\n\t- Transited services indicate which intermediate services have participated in this logon request.\r\n\t- Package name indicates which sub-protocol was used among the NTLM protocols.\r\n\t- Key length indicates the length of the generated session key. This will be 0 if no session key was requested.\"","version":"2","systemTime":"2021-06-25T13:42:33.795530000Z","eventRecordID":"2892977","threadID":"588","computer":"bankdc.ExchangeTest.com","task":"12544","processID":"552","severityValue":"AUDIT_SUCCESS","providerName":"Microsoft-Windows-Security-Auditing"}}} -->
    <rule id="92036" level="6">
        <if_sid>92035</if_sid>
        <field name="win.eventdata.authenticationPackageName" type="pcre2">NTLM</field>
        <description>Successful Remote Logon Detected - NTLM authentication, possible pass-the-hash attack</description>
        <mitre>
            <id>T1550.002</id>
        </mitre>
        <group>authentication_success,pci_dss_10.2.5,gpg13_7.1,gpg13_7.2,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_AU.14,nist_800_53_AC.7,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,</group>
    </rule>
</group>