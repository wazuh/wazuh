<!--
  -  Grouping of TA0005 "Defense Evasion" rules
  -  Author: Fabricio Brunetti
  -  Updated by Wazuh, Inc.
  -  Copyright (C) 2015-2021, Wazuh Inc.
  -  This program is a free software; you can redistribute it and/or modify it under the terms of GPLv2.
-->




<group name="TA0005,">
    <!-- Sample: {"win":{"eventdata":{"originalFileName":"csc.exe","image":"C:\\\\Windows\\\\Microsoft.NET\\\\Framework64\\\\v4.0.30319\\\\csc.exe","product":"Microsoft® .NET Framework","parentProcessGuid":"{4dc16835-5bcf-6091-b801-000000003500}","description":"Visual C# Command Line Compiler","logonGuid":"{4dc16835-5948-6091-2f18-2d0000000000}","parentCommandLine":"powershell  -ExecutionPolicy Bypass -NoExit .\\\\meta.ps1","processGuid":"{4dc16835-5bd1-6091-b901-000000003500}","logonId":"0x2d182f","parentProcessId":"5912","processId":"5124","currentDirectory":"C:\\\\Users\\\\AtomicRed\\\\Downloads\\\\","utcTime":"2021-05-04 14:36:01.555","hashes":"SHA1=528973416456C780051889CA1709510B6BF73370,MD5=F65B029562077B648A6A5F6A1AA76A66,SHA256=4A6D0864E19C0368A47217C129B075DDDF61A6A262388F9D21045D82F3423ED7,IMPHASH=EE1E569AD02AA1F7AECA80AC0601D80D","parentImage":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","ruleName":"technique_id=T1127,technique_name=Trusted Developer Utilities Proxy Execution","company":"Microsoft Corporation","commandLine":"\\\"C:\\\\Windows\\\\Microsoft.NET\\\\Framework64\\\\v4.0.30319\\\\csc.exe\\\" /noconfig /fullpaths @\\\"C:\\\\Users\\\\AtomicRed\\\\AppData\\\\Local\\\\Temp\\\\bspmrlpb.cmdline\\\"","integrityLevel":"Medium","fileVersion":"4.8.4084.0 built by: NET48REL1","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1127,technique_name=Trusted Developer Utilities Proxy Execution\r\nUtcTime: 2021-05-04 14:36:01.555\r\nProcessGuid: {4dc16835-5bd1-6091-b901-000000003500}\r\nProcessId: 5124\r\nImage: C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\csc.exe\r\nFileVersion: 4.8.4084.0 built by: NET48REL1\r\nDescription: Visual C# Command Line Compiler\r\nProduct: Microsoft® .NET Framework\r\nCompany: Microsoft Corporation\r\nOriginalFileName: csc.exe\r\nCommandLine: \"C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\csc.exe\" /noconfig /fullpaths @\"C:\\Users\\AtomicRed\\AppData\\Local\\Temp\\bspmrlpb.cmdline\"\r\nCurrentDirectory: C:\\Users\\AtomicRed\\Downloads\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-5948-6091-2f18-2d0000000000}\r\nLogonId: 0x2D182F\r\nTerminalSessionId: 1\r\nIntegrityLevel: Medium\r\nHashes: SHA1=528973416456C780051889CA1709510B6BF73370,MD5=F65B029562077B648A6A5F6A1AA76A66,SHA256=4A6D0864E19C0368A47217C129B075DDDF61A6A262388F9D21045D82F3423ED7,IMPHASH=EE1E569AD02AA1F7AECA80AC0601D80D\r\nParentProcessGuid: {4dc16835-5bcf-6091-b801-000000003500}\r\nParentProcessId: 5912\r\nParentImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nParentCommandLine: powershell  -ExecutionPolicy Bypass -NoExit .\\meta.ps1\"","version":"5","systemTime":"2021-05-04T14:36:01.5571724Z","eventRecordID":"168729","threadID":"3100","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2432","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92050" level="6">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.image" type="pcre2">(?i)\\csc\.exe</field>
        <field name="win.eventdata.parentCommandLine" type="pcre2">(?i)powershell.+ExecutionPolicy\s+bypass</field>
        <description>Powershell script compiling code using CSC.exe, possible malware drop</description>
        <mitre>
            <id>T1027.004</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"Windows PowerShell","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-5ce5-60e3-3601-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"5368","currentDirectory":"C:\\\\Windows\\\\system32\\\\","utcTime":"2021-07-05 19:26:29.887","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.001,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe  Set-MpPreference","integrityLevel":"High","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.001,technique_name=PowerShell\r\nUtcTime: 2021-07-05 19:26:29.887\r\nProcessGuid: {4dc16835-5ce5-60e3-3601-000000004800}\r\nProcessId: 5368\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe  Set-MpPreference -disableRealtimeMonitoring $True\r\nCurrentDirectory: C:\\Windows\\system32\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T19:26:29.8895020Z","eventRecordID":"252295","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92051" level="3">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.image" type="pcre2">(?i)\\powershell\.exe</field>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)Set-MpPreference</field>
        <description>Possible tampering on Windows Defender configuration by Powershell command</description>
        <mitre>
            <id>T1562</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"Windows PowerShell","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-5ce5-60e3-3601-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"5368","currentDirectory":"C:\\\\Windows\\\\system32\\\\","utcTime":"2021-07-05 19:26:29.887","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.001,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe  Set-MpPreference -disableRealtimeMonitoring $True","integrityLevel":"High","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.001,technique_name=PowerShell\r\nUtcTime: 2021-07-05 19:26:29.887\r\nProcessGuid: {4dc16835-5ce5-60e3-3601-000000004800}\r\nProcessId: 5368\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe  Set-MpPreference -disableRealtimeMonitoring $True\r\nCurrentDirectory: C:\\Windows\\system32\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T19:26:29.8895020Z","eventRecordID":"252295","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92052" level="12">
        <if_sid>92051</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)(DisableRealtimeMonitoring|drtm)\s+(\$true|1)</field>
        <description>Windows Defender real time monitoring was disabled by Powershell command</description>
        <mitre>
            <id>T1562.001</id>
        </mitre>
    </rule>



    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"Windows PowerShell","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-604e-60e3-4e01-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"3668","currentDirectory":"C:\\\\Windows\\\\system32\\\\","utcTime":"2021-07-05 19:41:02.965","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.001,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe  Set-MpPreference -DisableIntrusionPreventionSystem $True","integrityLevel":"High","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.001,technique_name=PowerShell\r\nUtcTime: 2021-07-05 19:41:02.965\r\nProcessGuid: {4dc16835-604e-60e3-4e01-000000004800}\r\nProcessId: 3668\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe  Set-MpPreference -DisableIntrusionPreventionSystem $True -drtm $True\r\nCurrentDirectory: C:\\Windows\\system32\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T19:41:02.9670466Z","eventRecordID":"252585","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92053" level="13">
        <if_sid>92051</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)(DisableIntrusionPreventionSystem|dips)\s+(\$true|1)</field>
        <description>Windows Defender Intrusion prevention system was disabled by Powershell command</description>
        <mitre>
            <id>T1562.001</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"Windows PowerShell","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-6122-60e3-5501-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"2412","currentDirectory":"C:\\\\Windows\\\\system32\\\\","utcTime":"2021-07-05 19:44:34.850","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.001,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe  Set-MpPreference -DisableIOAVProtection $true","integrityLevel":"High","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.001,technique_name=PowerShell\r\nUtcTime: 2021-07-05 19:44:34.850\r\nProcessGuid: {4dc16835-6122-60e3-5501-000000004800}\r\nProcessId: 2412\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe  Set-MpPreference -DisableIOAVProtection $true\r\nCurrentDirectory: C:\\Windows\\system32\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T19:44:34.8524432Z","eventRecordID":"252663","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92054" level="13">
        <if_sid>92051</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)(DisableIOAVProtection|dioavp)\s+(\$true|1)</field>
        <description>Windows Defender downloaded file scanning was disabled by Powershell command</description>
        <mitre>
            <id>T1562.001</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"Windows PowerShell","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-6241-60e3-5701-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"3932","currentDirectory":"C:\\\\Windows\\\\system32\\\\","utcTime":"2021-07-05 19:49:21.722","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.001,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe  Set-MpPreference -DisableScriptScanning $true","integrityLevel":"High","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.001,technique_name=PowerShell\r\nUtcTime: 2021-07-05 19:49:21.722\r\nProcessGuid: {4dc16835-6241-60e3-5701-000000004800}\r\nProcessId: 3932\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe  Set-MpPreference -DisableScriptScanning $true\r\nCurrentDirectory: C:\\Windows\\system32\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T19:49:21.7244621Z","eventRecordID":"252777","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92055" level="13">
        <if_sid>92051</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)(DisableScriptScanning|dscrptsc)\s+(\$true|1)</field>
        <description>Windows Defender script scanning was disabled by Powershell command</description>
        <mitre>
            <id>T1562.001</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"Windows PowerShell","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-64a3-60e3-6901-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"4880","currentDirectory":"C:\\\\Windows\\\\system32\\\\","utcTime":"2021-07-05 19:59:31.139","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.001,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe  Set-MpPreference -EnableControlledFolderAccess Disabled","integrityLevel":"High","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.001,technique_name=PowerShell\r\nUtcTime: 2021-07-05 19:59:31.139\r\nProcessGuid: {4dc16835-64a3-60e3-6901-000000004800}\r\nProcessId: 4880\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe  Set-MpPreference -EnableControlledFolderAccess Disabled\r\nCurrentDirectory: C:\\Windows\\system32\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T19:59:31.1448035Z","eventRecordID":"253037","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92056" level="13">
        <if_sid>92051</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)EnableControlledFolderAccess\s+(disabled|AuditMode)</field>
        <description>Windows Defender Controlled folder access was disabled by Powershell command</description>
        <mitre>
            <id>T1562.001</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"Windows PowerShell","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-6568-60e3-6a01-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"1480","currentDirectory":"C:\\\\Windows\\\\system32\\\\","utcTime":"2021-07-05 20:02:48.537","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.001,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe  Set-MpPreference -EnableNetworkProtection AuditMode","integrityLevel":"High","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.001,technique_name=PowerShell\r\nUtcTime: 2021-07-05 20:02:48.537\r\nProcessGuid: {4dc16835-6568-60e3-6a01-000000004800}\r\nProcessId: 1480\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe  Set-MpPreference -EnableNetworkProtection AuditMode\r\nCurrentDirectory: C:\\Windows\\system32\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T20:02:48.5392839Z","eventRecordID":"253061","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92057" level="13">
        <if_sid>92051</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)EnableNetworkProtection\s+(disabled|AuditMode)</field>
        <description>Windows Defender network protection was disabled by Powershell command</description>
        <mitre>
            <id>T1562.001</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"Windows PowerShell","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-65f7-60e3-6c01-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"5996","currentDirectory":"C:\\\\Windows\\\\system32\\\\","utcTime":"2021-07-05 20:05:11.183","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.001,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe  Set-MpPreference -MAPSReporting Disabled","integrityLevel":"High","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.001,technique_name=PowerShell\r\nUtcTime: 2021-07-05 20:05:11.183\r\nProcessGuid: {4dc16835-65f7-60e3-6c01-000000004800}\r\nProcessId: 5996\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe  Set-MpPreference -MAPSReporting Disabled\r\nCurrentDirectory: C:\\Windows\\system32\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T20:05:11.1856889Z","eventRecordID":"253083","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92058" level="13">
        <if_sid>92051</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)MAPSReporting\s+(disabled|AuditMode)</field>
        <description>Microsoft Active Protection Service (MAPS) was disabled by Powershell command</description>
        <mitre>
            <id>T1562.001</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"Windows PowerShell","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-66cb-60e3-7101-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"1492","currentDirectory":"C:\\\\Windows\\\\system32\\\\","utcTime":"2021-07-05 20:08:43.978","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.001,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe Set-MpPreference  -SubmitSamplesConsent NeverSend","integrityLevel":"High","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.001,technique_name=PowerShell\r\nUtcTime: 2021-07-05 20:08:43.978\r\nProcessGuid: {4dc16835-66cb-60e3-7101-000000004800}\r\nProcessId: 1492\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe  -SubmitSamplesConsent NeverSend\r\nCurrentDirectory: C:\\Windows\\system32\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T20:08:43.9804703Z","eventRecordID":"253147","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92059" level="13">
        <if_sid>92051</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)SubmitSamplesConsent\s+NeverSend</field>
        <description>Windows Defender sample submit was disabled by Powershell command</description>
        <mitre>
            <id>T1562.001</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"CertUtil.exe","image":"C:\\\\Windows\\\\cert.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"CertUtil.exe","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-6c17-60e3-8f01-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"3960","currentDirectory":"C:\\\\Windows\\\\","utcTime":"2021-07-05 20:31:19.061","hashes":"SHA1=ED314BE18A50107B404681FA5FD74B6B17109CBE,MD5=AB8F510E2A9B9F932A6AB1BBA4E73ED9,SHA256=97DB9285A916F00B0C8149C7B36438726E227C5DD26E874037734C23B50066DC,IMPHASH=7B7F7ED372C027216AE5100589C424EA","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1202,technique_name=Indirect Command Execution","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\cert.exe","integrityLevel":"High","fileVersion":"10.0.19041.1 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1202,technique_name=Indirect Command Execution\r\nUtcTime: 2021-07-05 20:31:19.061\r\nProcessGuid: {4dc16835-6c17-60e3-8f01-000000004800}\r\nProcessId: 3960\r\nImage: C:\\Windows\\cert.exe\r\nFileVersion: 10.0.19041.1 (WinBuild.160101.0800)\r\nDescription: CertUtil.exe\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: CertUtil.exe\r\nCommandLine: C:\\Windows\\cert.exe  -decode c:\\x\\peer.crt c:\\x\\agent.exe\r\nCurrentDirectory: C:\\Windows\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=ED314BE18A50107B404681FA5FD74B6B17109CBE,MD5=AB8F510E2A9B9F932A6AB1BBA4E73ED9,SHA256=97DB9285A916F00B0C8149C7B36438726E227C5DD26E874037734C23B50066DC,IMPHASH=7B7F7ED372C027216AE5100589C424EA\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T20:31:19.0634236Z","eventRecordID":"253469","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92060" level="13">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.originalFileName" type="pcre2">(?i)CertUtil\.exe</field>
        <field name="win.eventdata.image" type="pcre2" negate="yes">(?i)CertUtil\.exe</field>
        <description>Masqueraded CertUtil.exe with a different file name. Possible use to decode malware</description>
        <mitre>
            <id>T1036.003</id>
            <id>T1140</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"CertUtil.exe","image":"C:\\\\Windows\\\\cert.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"CertUtil.exe","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-6c17-60e3-8f01-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"3960","currentDirectory":"C:\\\\Windows\\\\","utcTime":"2021-07-05 20:31:19.061","hashes":"SHA1=ED314BE18A50107B404681FA5FD74B6B17109CBE,MD5=AB8F510E2A9B9F932A6AB1BBA4E73ED9,SHA256=97DB9285A916F00B0C8149C7B36438726E227C5DD26E874037734C23B50066DC,IMPHASH=7B7F7ED372C027216AE5100589C424EA","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1202,technique_name=Indirect Command Execution","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\cert.exe  -decode c:\\\\x\\\\peer.crt c:\\\\x\\\\agent.exe","integrityLevel":"High","fileVersion":"10.0.19041.1 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1202,technique_name=Indirect Command Execution\r\nUtcTime: 2021-07-05 20:31:19.061\r\nProcessGuid: {4dc16835-6c17-60e3-8f01-000000004800}\r\nProcessId: 3960\r\nImage: C:\\Windows\\cert.exe\r\nFileVersion: 10.0.19041.1 (WinBuild.160101.0800)\r\nDescription: CertUtil.exe\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: CertUtil.exe\r\nCommandLine: C:\\Windows\\cert.exe  -decode c:\\x\\peer.crt c:\\x\\agent.exe\r\nCurrentDirectory: C:\\Windows\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=ED314BE18A50107B404681FA5FD74B6B17109CBE,MD5=AB8F510E2A9B9F932A6AB1BBA4E73ED9,SHA256=97DB9285A916F00B0C8149C7B36438726E227C5DD26E874037734C23B50066DC,IMPHASH=7B7F7ED372C027216AE5100589C424EA\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T20:31:19.0634236Z","eventRecordID":"253469","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92061" level="13">
        <if_sid>92060</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)decode\s+(.+)\s+.+\.exe</field>
        <description>Masqueraded CertUtil.exe used to decode binary file</description>
        <mitre>
            <id>T1036.003</id>
            <id>T1140</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"CertUtil.exe","image":"C:\\\\Windows\\\\certutil.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"CertUtil.exe","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-6c17-60e3-8f01-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"3960","currentDirectory":"C:\\\\Windows\\\\","utcTime":"2021-07-05 20:31:19.061","hashes":"SHA1=ED314BE18A50107B404681FA5FD74B6B17109CBE,MD5=AB8F510E2A9B9F932A6AB1BBA4E73ED9,SHA256=97DB9285A916F00B0C8149C7B36438726E227C5DD26E874037734C23B50066DC,IMPHASH=7B7F7ED372C027216AE5100589C424EA","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1202,technique_name=Indirect Command Execution","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\cert.exe  -decode c:\\\\x\\\\peer.crt c:\\\\x\\\\agent.exe","integrityLevel":"High","fileVersion":"10.0.19041.1 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1202,technique_name=Indirect Command Execution\r\nUtcTime: 2021-07-05 20:31:19.061\r\nProcessGuid: {4dc16835-6c17-60e3-8f01-000000004800}\r\nProcessId: 3960\r\nImage: C:\\Windows\\cert.exe\r\nFileVersion: 10.0.19041.1 (WinBuild.160101.0800)\r\nDescription: CertUtil.exe\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: CertUtil.exe\r\nCommandLine: C:\\Windows\\cert.exe  -decode c:\\x\\peer.crt c:\\x\\agent.exe\r\nCurrentDirectory: C:\\Windows\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=ED314BE18A50107B404681FA5FD74B6B17109CBE,MD5=AB8F510E2A9B9F932A6AB1BBA4E73ED9,SHA256=97DB9285A916F00B0C8149C7B36438726E227C5DD26E874037734C23B50066DC,IMPHASH=7B7F7ED372C027216AE5100589C424EA\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T20:31:19.0634236Z","eventRecordID":"253469","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92062" level="13">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.originalFileName" type="pcre2">(?i)CertUtil\.exe</field>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)decode\s+(.+)\s+.+\.exe</field>
        <description>CertUtil.exe used to decode binary file</description>
        <mitre>
            <id>T1140</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"MsMpEng.exe","image":"C:\\\\Windows\\\\MsMpEng.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"Antimalware Service Executable","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-68de-60e3-7d01-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"4304","currentDirectory":"C:\\\\Windows\\\\","utcTime":"2021-07-05 20:17:34.077","hashes":"SHA1=85536AD6AFEE43B728ED12EE8CFFCA41F74F6446,MD5=CA2DE21D04A42228B707ABCE64EBBC8B,SHA256=2CCB6063389F3512BE2EF169E236C7474380C542ABD82B4B6BCAA8DEE2E3DCBE,IMPHASH=E568A0358C31B8910DC7FFF649D3FE0D","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.003,technique_name=Windows Command Shell","company":"Microsoft Corporation","commandLine":"msmpeng","integrityLevel":"High","fileVersion":"4.18.1909.6 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.003,technique_name=Windows Command Shell\r\nUtcTime: 2021-07-05 20:17:34.077\r\nProcessGuid: {4dc16835-68de-60e3-7d01-000000004800}\r\nProcessId: 4304\r\nImage: C:\\Windows\\MsMpEng.exe\r\nFileVersion: 4.18.1909.6 (WinBuild.160101.0800)\r\nDescription: Antimalware Service Executable\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: MsMpEng.exe\r\nCommandLine: msmpeng\r\nCurrentDirectory: C:\\Windows\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=85536AD6AFEE43B728ED12EE8CFFCA41F74F6446,MD5=CA2DE21D04A42228B707ABCE64EBBC8B,SHA256=2CCB6063389F3512BE2EF169E236C7474380C542ABD82B4B6BCAA8DEE2E3DCBE,IMPHASH=E568A0358C31B8910DC7FFF649D3FE0D\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T20:17:34.0803610Z","eventRecordID":"253242","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92063" level="13">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.originalFileName" type="pcre2">(?i)MsMpEng\.exe</field>
        <field name="win.eventdata.image" type="pcre2" negate="yes">(?i)[c-z]:\\\\(ProgramData\\\\Microsoft|Program Files)\\\\Windows Defender</field>
        <description>Windows Defender executed from suspicious path, possible DLL side-loading</description>
        <mitre>
            <id>T1574.002</id>
        </mitre>
    </rule>


    <!-- Sample: {"win":{"eventdata":{"subjectLogonId":"0x3e7","restrictedAdminMode":"%%1843","subjectDomainName":"EXCHANGETEST","targetLinkedLogonId":"0x0","impersonationLevel":"%%1833","ipAddress":"192.168.0.1","authenticationPackageName":"Negotiate","workstationName":"BANKDC","targetLogonId":"0x4105aff","logonProcessName":"User32","logonGuid":"{64C35E00-1827-0FCE-2AE0-11E54FFE301F}","targetUserName":"Administrator","keyLength":"0","elevatedToken":"%%1842","subjectUserSid":"S-1-5-18","processId":"0x464","processName":"C:\\\\Windows\\\\System32\\\\svchost.exe","ipPort":"0","targetDomainName":"EXCHANGETEST","targetUserSid":"S-1-5-21-887924094-598891991-956377308-500","virtualAccount":"%%1843","logonType":"10","subjectUserName":"BANKDC$"},"system":{"eventID":"4624","keywords":"0x8020000000000000","providerGuid":"{54849625-5478-4994-A5BA-3E3B0328C30D}","level":"0","channel":"Security","opcode":"0","message":"\"An account was successfully logged on.\r\n\r\nSubject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tBANKDC$\r\n\tAccount Domain:\t\tEXCHANGETEST\r\n\tLogon ID:\t\t0x3E7\r\n\r\nLogon Information:\r\n\tLogon Type:\t\t10\r\n\tRestricted Admin Mode:\tNo\r\n\tVirtual Account:\t\tNo\r\n\tElevated Token:\t\tYes\r\n\r\nImpersonation Level:\t\tImpersonation\r\n\r\nNew Logon:\r\n\tSecurity ID:\t\tS-1-5-21-887924094-598891991-956377308-500\r\n\tAccount Name:\t\tAdministrator\r\n\tAccount Domain:\t\tEXCHANGETEST\r\n\tLogon ID:\t\t0x4105AFF\r\n\tLinked Logon ID:\t\t0x0\r\n\tNetwork Account Name:\t-\r\n\tNetwork Account Domain:\t-\r\n\tLogon GUID:\t\t{64C35E00-1827-0FCE-2AE0-11E54FFE301F}\r\n\r\nProcess Information:\r\n\tProcess ID:\t\t0x464\r\n\tProcess Name:\t\tC:\\Windows\\System32\\svchost.exe\r\n\r\nNetwork Information:\r\n\tWorkstation Name:\tBANKDC\r\n\tSource Network Address:\t::1\r\n\tSource Port:\t\t0\r\n\r\nDetailed Authentication Information:\r\n\tLogon Process:\t\tUser32 \r\n\tAuthentication Package:\tNegotiate\r\n\tTransited Services:\t-\r\n\tPackage Name (NTLM only):\t-\r\n\tKey Length:\t\t0\r\n\r\nThis event is generated when a logon session is created. It is generated on the computer that was accessed.\r\n\r\nThe subject fields indicate the account on the local system which requested the logon. This is most commonly a service such as the Server service, or a local process such as Winlogon.exe or Services.exe.\r\n\r\nThe logon type field indicates the kind of logon that occurred. The most common types are 2 (interactive) and 3 (network).\r\n\r\nThe New Logon fields indicate the account for whom the new logon was created, i.e. the account that was logged on.\r\n\r\nThe network fields indicate where a remote logon request originated. Workstation name is not always available and may be left blank in some cases.\r\n\r\nThe impersonation level field indicates the extent to which a process in the logon session can impersonate.\r\n\r\nThe authentication information fields provide detailed information about this specific logon request.\r\n\t- Logon GUID is a unique identifier that can be used to correlate this event with a KDC event.\r\n\t- Transited services indicate which intermediate services have participated in this logon request.\r\n\t- Package name indicates which sub-protocol was used among the NTLM protocols.\r\n\t- Key length indicates the length of the generated session key. This will be 0 if no session key was requested.\"","version":"2","systemTime":"2021-07-02T20:19:32.631853500Z","eventRecordID":"4200219","threadID":"720","computer":"bankdc.ExchangeTest.com","task":"12544","processID":"556","severityValue":"AUDIT_SUCCESS","providerName":"Microsoft-Windows-Security-Auditing"}}} -->
    <rule id="92064" level="0">
        <if_sid>60106</if_sid>
        <field name="win.eventdata.logonType" type="pcre2">10</field>
        <description>User: $(win.eventdata.subjectDomainName)\$(win.eventdata.targetUserName) logged using Remote Desktop Connection (RDP) from ip:$(win.eventdata.ipAddress)</description>
        <mitre>
            <id>T1021.001</id>
            <id>T1078.002</id>
        </mitre>
    </rule>


    <!-- Sample: {"win":{"eventdata":{"subjectLogonId":"0x3e7","restrictedAdminMode":"%%1843","subjectDomainName":"EXCHANGETEST","targetLinkedLogonId":"0x0","impersonationLevel":"%%1833","ipAddress":"::1","authenticationPackageName":"Negotiate","workstationName":"BANKDC","targetLogonId":"0x4105aff","logonProcessName":"User32","logonGuid":"{64C35E00-1827-0FCE-2AE0-11E54FFE301F}","targetUserName":"Administrator","keyLength":"0","elevatedToken":"%%1842","subjectUserSid":"S-1-5-18","processId":"0x464","processName":"C:\\\\Windows\\\\System32\\\\svchost.exe","ipPort":"0","targetDomainName":"EXCHANGETEST","targetUserSid":"S-1-5-21-887924094-598891991-956377308-500","virtualAccount":"%%1843","logonType":"10","subjectUserName":"BANKDC$"},"system":{"eventID":"4624","keywords":"0x8020000000000000","providerGuid":"{54849625-5478-4994-A5BA-3E3B0328C30D}","level":"0","channel":"Security","opcode":"0","message":"\"An account was successfully logged on.\r\n\r\nSubject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tBANKDC$\r\n\tAccount Domain:\t\tEXCHANGETEST\r\n\tLogon ID:\t\t0x3E7\r\n\r\nLogon Information:\r\n\tLogon Type:\t\t10\r\n\tRestricted Admin Mode:\tNo\r\n\tVirtual Account:\t\tNo\r\n\tElevated Token:\t\tYes\r\n\r\nImpersonation Level:\t\tImpersonation\r\n\r\nNew Logon:\r\n\tSecurity ID:\t\tS-1-5-21-887924094-598891991-956377308-500\r\n\tAccount Name:\t\tAdministrator\r\n\tAccount Domain:\t\tEXCHANGETEST\r\n\tLogon ID:\t\t0x4105AFF\r\n\tLinked Logon ID:\t\t0x0\r\n\tNetwork Account Name:\t-\r\n\tNetwork Account Domain:\t-\r\n\tLogon GUID:\t\t{64C35E00-1827-0FCE-2AE0-11E54FFE301F}\r\n\r\nProcess Information:\r\n\tProcess ID:\t\t0x464\r\n\tProcess Name:\t\tC:\\Windows\\System32\\svchost.exe\r\n\r\nNetwork Information:\r\n\tWorkstation Name:\tBANKDC\r\n\tSource Network Address:\t::1\r\n\tSource Port:\t\t0\r\n\r\nDetailed Authentication Information:\r\n\tLogon Process:\t\tUser32 \r\n\tAuthentication Package:\tNegotiate\r\n\tTransited Services:\t-\r\n\tPackage Name (NTLM only):\t-\r\n\tKey Length:\t\t0\r\n\r\nThis event is generated when a logon session is created. It is generated on the computer that was accessed.\r\n\r\nThe subject fields indicate the account on the local system which requested the logon. This is most commonly a service such as the Server service, or a local process such as Winlogon.exe or Services.exe.\r\n\r\nThe logon type field indicates the kind of logon that occurred. The most common types are 2 (interactive) and 3 (network).\r\n\r\nThe New Logon fields indicate the account for whom the new logon was created, i.e. the account that was logged on.\r\n\r\nThe network fields indicate where a remote logon request originated. Workstation name is not always available and may be left blank in some cases.\r\n\r\nThe impersonation level field indicates the extent to which a process in the logon session can impersonate.\r\n\r\nThe authentication information fields provide detailed information about this specific logon request.\r\n\t- Logon GUID is a unique identifier that can be used to correlate this event with a KDC event.\r\n\t- Transited services indicate which intermediate services have participated in this logon request.\r\n\t- Package name indicates which sub-protocol was used among the NTLM protocols.\r\n\t- Key length indicates the length of the generated session key. This will be 0 if no session key was requested.\"","version":"2","systemTime":"2021-07-02T20:19:32.631853500Z","eventRecordID":"4200219","threadID":"720","computer":"bankdc.ExchangeTest.com","task":"12544","processID":"556","severityValue":"AUDIT_SUCCESS","providerName":"Microsoft-Windows-Security-Auditing"}}} -->
    <rule id="92065" level="15">
        <if_sid>92051</if_sid>
        <field name="win.eventdata.ipAddress" type="pcre2">::1|127\.0\.0\.1</field>
        <description>User: $(win.eventdata.subjectDomainName)\$(win.eventdata.targetUserName) logged using Remote Desktop Connection (RDP) from loopback address, possible exploit over reverse tunneling using stolen credentials</description>
        <mitre>
            <id>T1021.001</id>
            <id>T1078.002</id>
        </mitre>
    </rule>
</group>