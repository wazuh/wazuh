<!--
  -  Grouping of TA0008 "Discovery" rules
  -  Author: Fabricio Brunetti
  -  Updated by Wazuh, Inc.
  -  Copyright (C) 2015-2021, Wazuh Inc.
  -  This program is a free software; you can redistribute it and/or modify it under the terms of GPLv2.
-->




<group name="TA0008,">



    <!-- Sample: type=SYSCALL msg=audit(1624643172.076:11843): arch=c000003e syscall=59 success=yes exit=0 a0=25c81f0 a1=255f000 a2=255df40 a3=7ffc66d5c8e0 items=3 ppid=4353 pid=13331 auid=1198400500 uid=1198400500 gid=1198400513 euid=1198400500 suid=1198400500 fsuid=1198400500 egid=1198400513 sgid=1198400513 fsgid=1198400513 tty=pts0 ses=48 comm="runtime" exe="/usr/bin/python3.6" subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 key="wazuh_execution"\u001DARCH=x86_64 SYSCALL=execve AUID="administrator@ExchangeTest.com" UID="administrator@ExchangeTest.com" GID=646F6D61696E2075736572734045786368616E6765546573742E636F6D EUID="administrator@ExchangeTest.com" SUID="administrator@ExchangeTest.com" FSUID="administrator@ExchangeTest.com" EGID=646F6D61696E2075736572734045786368616E6765546573742E636F6D SGID=646F6D61696E2075736572734045786368616E6765546573742E636F6D FSGID=646F6D61696E2075736572734045786368616E6765546573742E636F6D type=EXECVE msg=audit(1624643172.076:11843): argc=6 a0="/usr/bin/python3" a1="./runtime" a2="calc.py" a3="exchangetest.com/administrator@192.168.0.57" a4="-hashes" a5="c615d74f277acb732af4e8680330fcf1:c615d74f277acb732af4e8680330fcf1" type=CWD msg=audit(1624643172.076:11843):  cwd="/var" type=PATH msg=audit(1624643172.076:11843): item=0 name="./runtime" inode=8409155 dev=fd:00 mode=0100755 ouid=1198400500 ogid=1198400513 rdev=00:00 obj=unconfined_u:object_r:user_tmp_t:s0 objtype=NORMAL cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0\u001DOUID="administrator@ExchangeTest.com" OGID=646F6D61696E2075736572734045786368616E6765546573742E636F6D type=PATH msg=audit(1624643172.076:11843): item=1 name="/usr/bin/python3" inode=1691048 dev=fd:00 mode=0100755 ouid=0 ogid=0 rdev=00:00 obj=system_u:object_r:bin_t:s0 objtype=NORMAL cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0\u001DOUID="root" OGID="root" type=PATH msg=audit(1624643172.076:11843): item=2 name="/lib64/ld-linux-x86-64.so.2" inode=4636927 dev=fd:00 mode=0100755 ouid=0 ogid=0 rdev=00:00 obj=system_u:object_r:ld_so_t:s0 objtype=NORMAL cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0\u001DOUID="root" OGID="root" type=PROCTITLE msg=audit(1624643172.076:11843): proctitle=2F7573722F62696E2F707974686F6E33002E2F72756E74696D65007073657865632E70790065786368616E6765746573742E636F6D2F61646D696E6973747261746F72403139322E3136382E302E3537002D6861736865730063363135643734663237376163623733326166346538363830333330666366313A633631356437 -->
    <!-- Sample 2: type=SYSCALL msg=audit(1624643172.076:11843): arch=c000003e syscall=59 success=yes exit=0 a0=25c81f0 a1=255f000 a2=255df40 a3=7ffc66d5c8e0 items=3 ppid=4353 pid=13331 auid=1198400500 uid=1198400500 gid=1198400513 euid=1198400500 suid=1198400500 fsuid=1198400500 egid=1198400513 sgid=1198400513 fsgid=1198400513 tty=pts0 ses=48 comm="runtime" exe="/usr/bin/python2.7" subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 key="wazuh_execution"\u001DARCH=x86_64 SYSCALL=execve AUID="administrator@ExchangeTest.com" UID="administrator@ExchangeTest.com" GID=646F6D61696E2075736572734045786368616E6765546573742E636F6D EUID="administrator@ExchangeTest.com" SUID="administrator@ExchangeTest.com" FSUID="administrator@ExchangeTest.com" EGID=646F6D61696E2075736572734045786368616E6765546573742E636F6D SGID=646F6D61696E2075736572734045786368616E6765546573742E636F6D FSGID=646F6D61696E2075736572734045786368616E6765546573742E636F6D type=EXECVE msg=audit(1624643172.076:11843): argc=6 a0="/usr/bin/python3" a1="./runtime" a2="calc.py" a3="exchangetest.com/administrator@192.168.0.57" a4="-hashes" a5="c615d74f277acb732af4e8680330fcf1:c615d74f277acb732af4e8680330fcf1" type=CWD msg=audit(1624643172.076:11843):  cwd="/var" type=PATH msg=audit(1624643172.076:11843): item=0 name="./runtime" inode=8409155 dev=fd:00 mode=0100755 ouid=1198400500 ogid=1198400513 rdev=00:00 obj=unconfined_u:object_r:user_tmp_t:s0 objtype=NORMAL cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0\u001DOUID="administrator@ExchangeTest.com" OGID=646F6D61696E2075736572734045786368616E6765546573742E636F6D type=PATH msg=audit(1624643172.076:11843): item=1 name="/usr/bin/python3" inode=1691048 dev=fd:00 mode=0100755 ouid=0 ogid=0 rdev=00:00 obj=system_u:object_r:bin_t:s0 objtype=NORMAL cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0\u001DOUID="root" OGID="root" type=PATH msg=audit(1624643172.076:11843): item=2 name="/lib64/ld-linux-x86-64.so.2" inode=4636927 dev=fd:00 mode=0100755 ouid=0 ogid=0 rdev=00:00 obj=system_u:object_r:ld_so_t:s0 objtype=NORMAL cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0\u001DOUID="root" OGID="root" type=PROCTITLE msg=audit(1624643172.076:11843): proctitle=2F7573722F62696E2F707974686F6E33002E2F72756E74696D65007073657865632E70790065786368616E6765746573742E636F6D2F61646D696E6973747261746F72403139322E3136382E302E3537002D6861736865730063363135643734663237376163623733326166346538363830333330666366313A633631356437 -->
    <!-- This rule requires endpoint detection of commands executed from /tmp/ folder with this audit rule: -w /tmp -p x -k wazuh_execution -->
    <rule id="92100" level="0">
        <if_group>audit</if_group>
        <field name="audit.exe" type="pcre2">python</field>
        <description>Executed python script</description>
        <mitre>
            <id>T1059.006</id>
        </mitre>
    </rule>



    <!-- Sample: type=SYSCALL msg=audit(1624643172.076:11843): arch=c000003e syscall=59 success=yes exit=0 a0=25c81f0 a1=255f000 a2=255df40 a3=7ffc66d5c8e0 items=3 ppid=4353 pid=13331 auid=1198400500 uid=1198400500 gid=1198400513 euid=1198400500 suid=1198400500 fsuid=1198400500 egid=1198400513 sgid=1198400513 fsgid=1198400513 tty=pts0 ses=48 comm="runtime" exe="/usr/bin/python3.6" subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 key="wazuh_execution"\u001DARCH=x86_64 SYSCALL=execve AUID="administrator@ExchangeTest.com" UID="administrator@ExchangeTest.com" GID=646F6D61696E2075736572734045786368616E6765546573742E636F6D EUID="administrator@ExchangeTest.com" SUID="administrator@ExchangeTest.com" FSUID="administrator@ExchangeTest.com" EGID=646F6D61696E2075736572734045786368616E6765546573742E636F6D SGID=646F6D61696E2075736572734045786368616E6765546573742E636F6D FSGID=646F6D61696E2075736572734045786368616E6765546573742E636F6D type=EXECVE msg=audit(1624643172.076:11843): argc=6 a0="/usr/bin/python3" a1="./runtime" a2="calc.py" a3="exchangetest.com/administrator@192.168.0.57" a4="-hashes" a5="c615d74f277acb732af4e8680330fcf1:c615d74f277acb732af4e8680330fcf1" type=CWD msg=audit(1624643172.076:11843):  cwd="/tmp" type=PATH msg=audit(1624643172.076:11843): item=0 name="./runtime" inode=8409155 dev=fd:00 mode=0100755 ouid=1198400500 ogid=1198400513 rdev=00:00 obj=unconfined_u:object_r:user_tmp_t:s0 objtype=NORMAL cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0\u001DOUID="administrator@ExchangeTest.com" OGID=646F6D61696E2075736572734045786368616E6765546573742E636F6D type=PATH msg=audit(1624643172.076:11843): item=1 name="/usr/bin/python3" inode=1691048 dev=fd:00 mode=0100755 ouid=0 ogid=0 rdev=00:00 obj=system_u:object_r:bin_t:s0 objtype=NORMAL cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0\u001DOUID="root" OGID="root" type=PATH msg=audit(1624643172.076:11843): item=2 name="/lib64/ld-linux-x86-64.so.2" inode=4636927 dev=fd:00 mode=0100755 ouid=0 ogid=0 rdev=00:00 obj=system_u:object_r:ld_so_t:s0 objtype=NORMAL cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0\u001DOUID="root" OGID="root" type=PROCTITLE msg=audit(1624643172.076:11843): proctitle=2F7573722F62696E2F707974686F6E33002E2F72756E74696D65007073657865632E70790065786368616E6765746573742E636F6D2F61646D696E6973747261746F72403139322E3136382E302E3537002D6861736865730063363135643734663237376163623733326166346538363830333330666366313A633631356437 -->
    <!-- Sample 2: type=SYSCALL msg=audit(1624643172.076:11843): arch=c000003e syscall=59 success=yes exit=0 a0=25c81f0 a1=255f000 a2=255df40 a3=7ffc66d5c8e0 items=3 ppid=4353 pid=13331 auid=1198400500 uid=1198400500 gid=1198400513 euid=1198400500 suid=1198400500 fsuid=1198400500 egid=1198400513 sgid=1198400513 fsgid=1198400513 tty=pts0 ses=48 comm="runtime" exe="/usr/bin/python2.7" subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 key="wazuh_execution"\u001DARCH=x86_64 SYSCALL=execve AUID="administrator@ExchangeTest.com" UID="administrator@ExchangeTest.com" GID=646F6D61696E2075736572734045786368616E6765546573742E636F6D EUID="administrator@ExchangeTest.com" SUID="administrator@ExchangeTest.com" FSUID="administrator@ExchangeTest.com" EGID=646F6D61696E2075736572734045786368616E6765546573742E636F6D SGID=646F6D61696E2075736572734045786368616E6765546573742E636F6D FSGID=646F6D61696E2075736572734045786368616E6765546573742E636F6D type=EXECVE msg=audit(1624643172.076:11843): argc=6 a0="/usr/bin/python3" a1="./runtime" a2="/tmp/calc.py" a3="exchangetest.com/administrator@192.168.0.57" a4="-hashes" a5="c615d74f277acb732af4e8680330fcf1:c615d74f277acb732af4e8680330fcf1" type=CWD msg=audit(1624643172.076:11843):  cwd="/tmp" type=PATH msg=audit(1624643172.076:11843): item=0 name="./runtime" inode=8409155 dev=fd:00 mode=0100755 ouid=1198400500 ogid=1198400513 rdev=00:00 obj=unconfined_u:object_r:user_tmp_t:s0 objtype=NORMAL cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0\u001DOUID="administrator@ExchangeTest.com" OGID=646F6D61696E2075736572734045786368616E6765546573742E636F6D type=PATH msg=audit(1624643172.076:11843): item=1 name="/usr/bin/python3" inode=1691048 dev=fd:00 mode=0100755 ouid=0 ogid=0 rdev=00:00 obj=system_u:object_r:bin_t:s0 objtype=NORMAL cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0\u001DOUID="root" OGID="root" type=PATH msg=audit(1624643172.076:11843): item=2 name="/lib64/ld-linux-x86-64.so.2" inode=4636927 dev=fd:00 mode=0100755 ouid=0 ogid=0 rdev=00:00 obj=system_u:object_r:ld_so_t:s0 objtype=NORMAL cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0\u001DOUID="root" OGID="root" type=PROCTITLE msg=audit(1624643172.076:11843): proctitle=2F7573722F62696E2F707974686F6E33002E2F72756E74696D65007073657865632E70790065786368616E6765746573742E636F6D2F61646D696E6973747261746F72403139322E3136382E302E3537002D6861736865730063363135643734663237376163623733326166346538363830333330666366313A633631356437 -->
    <rule id="92101" level="6">
        <if_sid>92100</if_sid>
        <match type="pcre2">a\d="\w+\.py".+cwd="/tmp"|a\d="/tmp/.+\.py</match>
        <description>Executed python script from /tmp/ folder</description>
        <mitre>
            <id>T1059.006</id>
        </mitre>
    </rule>

    <!-- Sample: type=SYSCALL msg=audit(1624643172.076:11843): arch=c000003e syscall=59 success=yes exit=0 a0=25c81f0 a1=255f000 a2=255df40 a3=7ffc66d5c8e0 items=3 ppid=4353 pid=13331 auid=1198400500 uid=1198400500 gid=1198400513 euid=1198400500 suid=1198400500 fsuid=1198400500 egid=1198400513 sgid=1198400513 fsgid=1198400513 tty=pts0 ses=48 comm="runtime" exe="/usr/bin/python3.6" subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 key="wazuh_execution"\u001DARCH=x86_64 SYSCALL=execve AUID="administrator@ExchangeTest.com" UID="administrator@ExchangeTest.com" GID=646F6D61696E2075736572734045786368616E6765546573742E636F6D EUID="administrator@ExchangeTest.com" SUID="administrator@ExchangeTest.com" FSUID="administrator@ExchangeTest.com" EGID=646F6D61696E2075736572734045786368616E6765546573742E636F6D SGID=646F6D61696E2075736572734045786368616E6765546573742E636F6D FSGID=646F6D61696E2075736572734045786368616E6765546573742E636F6D type=EXECVE msg=audit(1624643172.076:11843): argc=6 a0="/usr/bin/python3" a1="./runtime" a2="psexec.py" a3="exchangetest.com/administrator@192.168.0.57" a4="-hashes" a5="c615d74f277acb732af4e8680330fcf1:c615d74f277acb732af4e8680330fcf1" type=CWD msg=audit(1624643172.076:11843):  cwd="/tmp" type=PATH msg=audit(1624643172.076:11843): item=0 name="./runtime" inode=8409155 dev=fd:00 mode=0100755 ouid=1198400500 ogid=1198400513 rdev=00:00 obj=unconfined_u:object_r:user_tmp_t:s0 objtype=NORMAL cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0\u001DOUID="administrator@ExchangeTest.com" OGID=646F6D61696E2075736572734045786368616E6765546573742E636F6D type=PATH msg=audit(1624643172.076:11843): item=1 name="/usr/bin/python3" inode=1691048 dev=fd:00 mode=0100755 ouid=0 ogid=0 rdev=00:00 obj=system_u:object_r:bin_t:s0 objtype=NORMAL cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0\u001DOUID="root" OGID="root" type=PATH msg=audit(1624643172.076:11843): item=2 name="/lib64/ld-linux-x86-64.so.2" inode=4636927 dev=fd:00 mode=0100755 ouid=0 ogid=0 rdev=00:00 obj=system_u:object_r:ld_so_t:s0 objtype=NORMAL cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0\u001DOUID="root" OGID="root" type=PROCTITLE msg=audit(1624643172.076:11843): proctitle=2F7573722F62696E2F707974686F6E33002E2F72756E74696D65007073657865632E70790065786368616E6765746573742E636F6D2F61646D696E6973747261746F72403139322E3136382E302E3537002D6861736865730063363135643734663237376163623733326166346538363830333330666366313A633631356437 -->
    <rule id="92102" level="12">
        <if_sid>92100, 92101</if_sid>
        <match type="pcre2">psexec.py|smbexec.py</match>
        <match type="pcre2">a\d="-hashes".+a\d=".+:.+</match>
        <description>Suspicious python script matches Impacket signature, possible use of stolen credentials or pass the hash attack</description>
        <mitre>
            <id>T1059.006</id>
            <id>T1550.002</id>
        </mitre>
    </rule>

    <!-- {"win":{"eventdata":{"destinationPort":"445","image":"System","sourcePort":"51970","initiated":"false","destinationIp":"192.168.0.57","protocol":"tcp","processGuid":"{86107A5D-0B6A-60D6-EB03-000000000000}","sourceIp":"192.168.0.218","processId":"4","utcTime":"2021-06-25 18:34:36.226","destinationPortName":"microsoft-ds","ruleName":"technique_id=T1021.002,technique_name=Remote Services: SMB/Windows Admin Shares","destinationIsIpv6":"false","user":"NT AUTHORITY\\\\SYSTEM","sourceIsIpv6":"false"},"system":{"eventID":"3","keywords":"0x8000000000000000","providerGuid":"{5770385F-C22A-43E0-BF4C-06F5698FFBD9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Network connection detected:\r\nRuleName: technique_id=T1021.002,technique_name=Remote Services: SMB/Windows Admin Shares\r\nUtcTime: 2021-06-25 18:34:36.226\r\nProcessGuid: {86107A5D-0B6A-60D6-EB03-000000000000}\r\nProcessId: 4\r\nImage: System\r\nUser: NT AUTHORITY\\SYSTEM\r\nProtocol: tcp\r\nInitiated: false\r\nSourceIsIpv6: false\r\nSourceIp: 192.168.0.218\r\nSourceHostname: -\r\nSourcePort: 51970\r\nSourcePortName: -\r\nDestinationIsIpv6: false\r\nDestinationIp: 192.168.0.57\r\nDestinationHostname: -\r\nDestinationPort: 445\r\nDestinationPortName: microsoft-ds\"","version":"5","systemTime":"2021-06-25T18:34:37.376008800Z","eventRecordID":"658731","threadID":"3792","computer":"bankdc.ExchangeTest.com","task":"3","processID":"2620","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}} -->
    <rule id="92103" level="3">
        <if_group>sysmon_event3</if_group>
        <field name="win.eventdata.image" type="pcre2">^System$</field>
        <field name="win.eventdata.destinationPort" type="pcre2">^445$</field>
        <description>Windows System process activity over SMB port - Possible suspicious access to Windows admin shares</description>
        <mitre>
            <id>T1021.002</id>
        </mitre>
    </rule>

    <!-- {"win":{"eventdata":{"image":"System","processGuid":"{86107A5D-0B6A-60D6-EB03-000000000000}","processId":"4","utcTime":"2021-06-25 18:09:57.530","targetFilename":"C:\\\\Windows\\\\tiny.exe","creationUtcTime":"2021-06-24 23:36:43.555"},"system":{"eventID":"11","keywords":"0x8000000000000000","providerGuid":"{5770385F-C22A-43E0-BF4C-06F5698FFBD9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"File created:\r\nRuleName: -\r\nUtcTime: 2021-06-25 18:09:57.530\r\nProcessGuid: {86107A5D-0B6A-60D6-EB03-000000000000}\r\nProcessId: 4\r\nImage: System\r\nTargetFilename: C:\\Windows\\tiny.exe\r\nCreationUtcTime: 2021-06-24 23:36:43.555\"","version":"2","systemTime":"2021-06-25T18:09:57.530600200Z","eventRecordID":"647283","threadID":"3784","computer":"bankdc.ExchangeTest.com","task":"11","processID":"2620","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}} -->
    <rule id="92104" level="6">
        <if_group>sysmon_event_11</if_group>
        <field name="win.eventdata.image" type="pcre2">^System$</field>
        <field name="win.eventdata.targetFilename" type="pcre2">(?i)[c-z]:\\\\Windows\\\\.+(.exe$|\.dll)$</field>
        <description>Binary dropped in Windows root folder by System process. Possible abuse of Windows admin shares</description>
        <mitre>
            <id>T1570</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PSCP","image":"C:\\\\Users\\\\AtomicRed\\\\AppData\\\\Roaming\\\\TransbaseOdbcDriver\\\\pscp.exe","product":"PuTTY suite","parentProcessGuid":"{4dc16835-3bdd-609c-5901-000000003b00}","description":"Command-line SCP/SFTP client","logonGuid":"{4dc16835-2e5f-609c-19a4-7c0000000000}","parentCommandLine":"C:\\\\Windows\\\\system32\\\\cmd.exe","processGuid":"{4dc16835-416a-609c-7601-000000003b00}","logonId":"0x7ca419","parentProcessId":"5560","processId":"2180","currentDirectory":"C:\\\\Users\\\\AtomicRed\\\\AppData\\\\Roaming\\\\TransbaseOdbcDriver\\\\","utcTime":"2021-05-12 20:58:18.149","hashes":"SHA1=EE1B5F3A7F9563A9E7575EDDA467794584555F97,MD5=3145D4A197A3523253880E9E6E76F798,SHA256=7A09FD6885CA5662A40D6F9212C115D8F38C88F9C1BCDA697854BFB202F289B2,IMPHASH=C2612378E2F461D6FCF8743722ABEB7A","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.003,technique_name=Windows Command Shell","company":"Simon Tatham","commandLine":"pscp.exe  -scp psexec.py administrator@Exchangetest.com@192.168.0.218:/tmp/psexec.py","integrityLevel":"Medium","fileVersion":"Release 0.73","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.003,technique_name=Windows Command Shell\r\nUtcTime: 2021-05-12 20:58:18.149\r\nProcessGuid: {4dc16835-416a-609c-7601-000000003b00}\r\nProcessId: 2180\r\nImage: C:\\Users\\AtomicRed\\AppData\\Roaming\\TransbaseOdbcDriver\\pscp.exe\r\nFileVersion: Release 0.73\r\nDescription: Command-line SCP/SFTP client\r\nProduct: PuTTY suite\r\nCompany: Simon Tatham\r\nOriginalFileName: PSCP\r\nCommandLine: pscp.exe  -scp psexec.py administrator@Exchangetest.com@192.168.0.218:/tmp/psexec.py\r\nCurrentDirectory: C:\\Users\\AtomicRed\\AppData\\Roaming\\TransbaseOdbcDriver\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-2e5f-609c-19a4-7c0000000000}\r\nLogonId: 0x7CA419\r\nTerminalSessionId: 1\r\nIntegrityLevel: Medium\r\nHashes: SHA1=EE1B5F3A7F9563A9E7575EDDA467794584555F97,MD5=3145D4A197A3523253880E9E6E76F798,SHA256=7A09FD6885CA5662A40D6F9212C115D8F38C88F9C1BCDA697854BFB202F289B2,IMPHASH=C2612378E2F461D6FCF8743722ABEB7A\r\nParentProcessGuid: {4dc16835-3bdd-609c-5901-000000003b00}\r\nParentProcessId: 5560\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: C:\\Windows\\system32\\cmd.exe\"","version":"5","systemTime":"2021-05-12T20:58:18.1529188Z","eventRecordID":"199658","threadID":"3320","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2080","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}} -->
    <rule id="92105" level="6">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.originalFileName" type="pcre2">PSCP</field>
        <field name="win.eventdata.parentCommandLine" type="pcre2">(?i)-scp</field>
        <description>A file was copied to other system over SSH using pscp.exe</description>
        <mitre>
            <id>T1021.004</id>
        </mitre>
    </rule>

    <!-- Sample: type=SYSCALL msg=audit(1620937405.872:764): arch=c000003e syscall=2 success=yes exit=4 a0=555c2e4a6fb0 a1=41 a2=1a4 a3=7fcfaf0607b8 items=2 ppid=7903 pid=7909 auid=1198400500 uid=1198400500 gid=1198400513 euid=1198400500 suid=1198400500 fsuid=1198400500 egid=1198400513 sgid=1198400513 fsgid=1198400513 tty=(none) ses=21 comm="scp" exe="/usr/bin/scp" subj=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023 key="wazuh_fim" type=CWD msg=audit(1620937405.872:764):  cwd="/home/administrator@ExchangeTest.com" type=PATH msg=audit(1620937405.872:764): item=0 name="/tmp/" inode=8409157 dev=fd:00 mode=041777 ouid=0 ogid=0 rdev=00:00 obj=system_u:object_r:tmp_t:s0 objtype=PARENT cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0 type=PATH msg=audit(1620937405.872:764): item=1 name="/tmp/ps2.py" inode=9595745 dev=fd:00 mode=0100644 ouid=1198400500 ogid=1198400513 rdev=00:00 obj=unconfined_u:object_r:user_tmp_t:s0 objtype=CREATE cap_fp=0000000000000000 cap_fi=0000000000000000 cap_fe=0 cap_fver=0 type=PROCTITLE msg=audit(1620937405.872:764): proctitle=736370002D74002F746D702F7073322E7079 -->
    <rule id="92106" level="6">
        <if_group>audit</if_group>
        <field name="audit.command" type="pcre2">scp</field>
        <field name="audit.file.name" type="pcre2">.+</field>
        <description>A file was copied to this system over SSH using SCP</description>
        <mitre>
            <id>T1021.004</id>
        </mitre>
    </rule>




    <!-- Sample: {"win":{"eventdata":{"destinationPort":"3389","image":"C:\\\\Windows\\\\System32\\\\svchost.exe","sourcePort":"25387","initiated":"false","destinationIp":"0:0:0:0:0:0:0:1","protocol":"tcp","processGuid":"{86107A5D-6C0C-60DF-04DD-600100000000}","sourceIp":"0:0:0:0:0:0:0:1","processId":"7728","sourceHostname":"bankdc.ExchangeTest.com","utcTime":"2021-07-02 20:19:28.870","destinationPortName":"ms-wbt-server","ruleName":"technique_id=T1021,technique_name=Remote Services","destinationIsIpv6":"true","user":"NT AUTHORITY\\\\NETWORK SERVICE","destinationHostname":"bankdc.ExchangeTest.com","sourceIsIpv6":"true"},"system":{"eventID":"3","keywords":"0x8000000000000000","providerGuid":"{5770385F-C22A-43E0-BF4C-06F5698FFBD9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Network connection detected:\r\nRuleName: technique_id=T1021,technique_name=Remote Services\r\nUtcTime: 2021-07-02 20:19:28.870\r\nProcessGuid: {86107A5D-6C0C-60DF-04DD-600100000000}\r\nProcessId: 7728\r\nImage: C:\\Windows\\System32\\svchost.exe\r\nUser: NT AUTHORITY\\NETWORK SERVICE\r\nProtocol: tcp\r\nInitiated: false\r\nSourceIsIpv6: true\r\nSourceIp: 0:0:0:0:0:0:0:1\r\nSourceHostname: bankdc.ExchangeTest.com\r\nSourcePort: 25387\r\nSourcePortName: -\r\nDestinationIsIpv6: true\r\nDestinationIp: 0:0:0:0:0:0:0:1\r\nDestinationHostname: bankdc.ExchangeTest.com\r\nDestinationPort: 3389\r\nDestinationPortName: ms-wbt-server\"","version":"5","systemTime":"2021-07-02T20:19:29.969938200Z","eventRecordID":"1122514","threadID":"3504","computer":"bankdc.ExchangeTest.com","task":"3","processID":"2528","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}} -->
    <rule id="92082" level="15">
        <if_group>sysmon_event3</if_group>
        <field name="win.eventdata.destinationPort" type="pcre2">3389</field>
        <field name="win.eventdata.destinationIp" type="pcre2">0:0:0:0:0:0:0:1|127\.0\.0\.1</field>
        <field name="win.eventdata.sourceIp" type="pcre2">0:0:0:0:0:0:0:1|127\.0\.0\.1</field>
        <description>Network activity using RDP port from-to loopback address, possible exploit using reverse tunneling</description>
        <mitre>
            <id>T1021.001</id>
        </mitre>
    </rule>


</group>