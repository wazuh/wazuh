# Copyright (C) 2015-2023, Wazuh Inc.
# Created by Wazuh, Inc. <info@wazuh.com>.
# This program is free software; you can redistribute it and/or modify it under the terms of GPLv2
import pytest
from wazuh_testing.utils.db_interface import cve_db
from wazuh_testing.utils.services import control_service
from wazuh_testing.modules.vulnerability_detector.packages import (insert_vulnerable_packages,
                                                                   insert_vulnerabilities_agent_inventory,
                                                                   insert_suse_system_package)
from wazuh_testing.utils.db_interface.agent_db import update_sync_info, update_last_full_scan
from wazuh_testing.tools.time import get_current_timestamp


@pytest.fixture()
def restart_modulesd() -> None:
    """Restart wazuh-modulesd daemon before starting a test, and stop it after finishing"""
    control_service('restart', daemon='wazuh-modulesd')
    yield
    control_service('stop', daemon='wazuh-modulesd')


@pytest.fixture()
def clean_cve_tables() -> None:
    """Clean all tables of the CVE database before and after finishing the test"""
    cve_db.clean_all_cve_tables()
    yield
    cve_db.clean_all_cve_tables()


@pytest.fixture(scope='module')
def clean_cve_tables_module() -> None:
    """Clean all tables of the CVE database before and after finishing the test"""
    cve_db.clean_all_cve_tables()
    yield
    cve_db.clean_all_cve_tables()


@pytest.fixture()
def prepare_full_scan(agent_system, mock_agent_with_custom_system):
    """Prepare the environment to launch the vulnerability scan.

    - Mock an agent with a specified system.
    - Force full scan.

    Args:
        agent_system (str): System to set to the mocked agent.
        mock_agent_with_custom_system (fixture): Mock an agent with a custom system.
    """
    update_last_full_scan(1, agent_id=mock_agent_with_custom_system)

    yield mock_agent_with_custom_system


def prepare_scan_with_vuln_packages_implementation(agent_id: int, last_scan: int, agent_system: str = 'RHEL8',
                                                   count: int = 5) -> None:
    """Prepare the environment to launch the vulnerability scan.

    - Mock an agent with a specified system.
    - Insert mocked vulnerables packages.
    - Update packages sync status.
    - Force full scan.

    Args:
        agent_id (int): Agent id to which packages and scan will be configured.
        last_scan (int): Timestamp to set as last scan. used to force different types of scans
        agent_system (str): System to set to the mocked agent.
        count (int): Number of packages to insert.
    """
    # Insert vulnerable packages
    package_vendor = 'Red Hat, Inc.' if 'RHEL' in agent_system else 'wazuh-mocking'

    if 'SLES' in agent_system:
        package_vendor = 'SUSE LLC <https://www.suse.com/>'
        insert_suse_system_package(agent_id=agent_id, version=agent_system)

    insert_vulnerable_packages(agent_id=agent_id, vendor=package_vendor, count=count)

    # Update sync info for packages
    update_sync_info(agent_id=agent_id, component="syscollector-packages")

    # Forcing a scan
    update_last_full_scan(last_scan, agent_id=agent_id)


@pytest.fixture()
def prepare_baseline_scan_with_vuln_packages(mock_agent_with_custom_system: int, agent_system: str) -> int:
    """Add a mocked agent with mocked packages and force the baseline scan for that agent.

    Args:
        agent_system (str): System to set to the mocked agent.
        mock_agent_with_custom_system (Fixture): Fixture for mocking an agent.
    """
    prepare_scan_with_vuln_packages_implementation(agent_id=mock_agent_with_custom_system, last_scan=0,
                                                   agent_system=agent_system)

    yield mock_agent_with_custom_system


@pytest.fixture()
def prepare_full_scan_with_vuln_packages(mock_agent_with_custom_system: int, agent_system: str) -> int:
    """Prepare the environment to launch the vulnerability full scan.

    Args:
        mock_agent_with_custom_system (fixture): Mock an agent with a custom system.
        agent_system (str): System to set to the mocked agent.
    """
    prepare_scan_with_vuln_packages_implementation(agent_id=mock_agent_with_custom_system, last_scan=1,
                                                   agent_system=agent_system)

    yield mock_agent_with_custom_system


@pytest.fixture()
def prepare_full_scan_with_vuln_package(mock_agent_with_custom_system: int, agent_system: str) -> int:
    """Add a mocked agent with only one mocked vulnerable package and force the full scan for that agent.

    Args:
        mock_agent_function (Fixture): Fixture for mocking an agent.
    """
    prepare_scan_with_vuln_packages_implementation(agent_id=mock_agent_with_custom_system, last_scan=1,
                                                   agent_system=agent_system, count=1)

    yield mock_agent_with_custom_system


@pytest.fixture()
def prepare_partial_scan_with_vuln_packages(mock_agent_with_custom_system, agent_system: str) -> int:
    """Add a mocked agent with mocked packages and force the partial scan for that agent.

    Args:
        mock_agent_with_custom_system (Fixture): Fixture for mocking an agent.
        agent_system (str): System to set to the mocked agent.
    """
    prepare_scan_with_vuln_packages_implementation(agent_id=mock_agent_with_custom_system,
                                                   last_scan=int(get_current_timestamp()), agent_system=agent_system)

    yield mock_agent_with_custom_system


def prepare_scan_with_obsolete_vulnerabilities_implementation(agent_id: int, last_scan: int,
                                                              agent_system: str = 'RHEL8') -> None:
    """Prepare the environment to launch the vulnerability scan.

    - Insert mocked vulnerables packages.
    - Update packages sync status.
    - Force scan based on the last_scan time passed.

    Args:
        agent_id (int): Agent id to insert the packages.
        last_scan (int): timestamp of last previous scan.
        agent_system (str): System to set to the mocked agent. Default: 'RHEL8'
    """
    # Insert vulnerability data in vulnerabilities inventory
    insert_vulnerabilities_agent_inventory(agent_id=agent_id, status='OBSOLETE')

    # Force sync status for packages
    update_sync_info(agent_id=agent_id, component="syscollector-packages")

    # Force the partial scan
    update_last_full_scan(last_scan, agent_id=agent_id)


@pytest.fixture()
def prepare_partial_scan_with_obsolete_vulnerabilities(mock_agent_with_custom_system: int,
                                                       agent_system: str) -> int:
    """Add a mocked agent with mocked packages and force the partial scan for that agent.

    Args:
        mock_agent_with_custom_system (Fixture): Fixture for mocking an agent.
    """
    prepare_scan_with_obsolete_vulnerabilities_implementation(agent_id=mock_agent_with_custom_system,
                                                              last_scan=int(get_current_timestamp()),
                                                              agent_system=agent_system)

    yield mock_agent_with_custom_system


@pytest.fixture()
def prepare_full_scan_with_obsolete_vulnerabilities(mock_agent_with_custom_system: int,
                                                    agent_system: str) -> int:
    """Add a mocked agent with mocked packages and force the full scan for that agent.

    Args:
        mock_agent_with_custom_system (Fixture): Fixture for mocking an agent.
    """
    prepare_scan_with_obsolete_vulnerabilities_implementation(agent_id=mock_agent_with_custom_system,
                                                              last_scan=1, agent_system=agent_system)

    yield mock_agent_with_custom_system
